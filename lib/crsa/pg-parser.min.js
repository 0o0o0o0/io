var pgIdCount=0,pgObjectCount=0,pgIdRegExp=new RegExp('\\s*data\\-pg\\-id="([0-9]+)"',"i"),pgIdRegExpReplace=new RegExp('\\s*data\\-pg\\-id="[0-9]+"',"ig"),pgWhiteSpaceRegExp=new RegExp("^[\\s\\n]*$"),pgSelectorCache={},pgDontFormat=["p","span","bdo","em","strong","dfn","code","samp","kbd","var","cite","abbr","acronym","q","sub","sup","tt","i","b","big","small","u","s","strike","font","ins","del","pre","address","dt","h1","h2","h3","h4","h5","h6","br"],pgDontFormatIfAllChildrenNonFormat=["a"],pgParserException=function(t,e){this.message=t,this.name="pgParserException",this.reference=e},pgParserSourceProblem=function(t,e){this.message="Can not edit source node.",this.name="pgParserSourceProblem",this.node=t,this.$el=e;var i=[];this.add=function(t,e,n,s){s||(s="dynamic"),i.push({obj_type:t,obj:e,action:n,reason:s})},this.ok=function(){return 0==i.length},this.toString=function(){if(0==i.length)return null;for(var t="<ul>",e=0;e<i.length;e++){var n="",s=i[e];switch(s.obj_type){case"class":n="Class <b>"+s.obj+"</b>";break;case"element":n="Element <b>"+s.obj+"</b>"}var r;switch(s.reason){default:r="because it was either: <b>added by a script</b>, <b>removed from the page</b> or <b>changed in the code editor without refreshing the page</b>"}switch(s.action){case"remove":n+=" can't be <b>removed</b>";break;case"add":n+=" can't be <b>added</b>";break;case"change":n+=" can't be <b>changed</b>";break;case"find":n+=" does't <b>exist in source</b>";break;case"duplicate":n+=" cant't be <b>duplicated</b>"}n+=" "+r+".",t+="<li>"+n+"</li>"}return t+="</ul>"}},pgParserNodeCatalogue=function(){var t={};this.clear=function(){t={}},this.add=function(e){var i=e.getId();i&&(t[i]=e)},this.get=function(e){return e in t?t[e]:null},this.remove=function(e){var i=e.getId();if(i&&i in t){if(e.objectCount!=t[i].objectCount)return;delete t[i]}},this.logStat=function(){var e=0;for(var i in t)t.hasOwnProperty(i)&&++e;console.log("pgParserNodeCatalogue - # objects: "+e)}},pgParserNodeCatalogueInstance=new pgParserNodeCatalogue,pgGetAttributesStringFilterOutPgIds=function(t,e,i){return"data-pg-id"==e?null:null===i?e:e+'="'+i+'"'},pgCreateNodeFromHtml=function(t){var e=new pgParser;if(e.parse(t),1!=e.rootNode.children.length)throw new pgParserException("Create node from html failed. Only one node can be created.",t);return e.rootNode.children[0]},pgParserNode=function(){var t="data-pg-id";this.tagName=null,this.tagNameOriginal=null,this.textNode=!1,this.rootNode=!1,this.attributes="",this.closingTag=null,this.closed=!1,this.selfClosed=!1,this.content=null,this.singleTag=!1,this.script=!1,this.children=[],this.parent=null,this.comment=!1,this.isElement=!1,this.pgId=null,this.hasPgIdAttr=!1,this.objectCount=++pgObjectCount,this.attrList=null,this.attrListChanged=!1,this.nodeCatalogue=null,this.document=null,this.$el=null;var e=this;this.setDocument=function(t){this.walkSelfAndChildren(function(e){return e.document=t,!0})},this.addChild=function(t){this.children.push(t),t.parent=this,t.setDocument(this.document)},this.removeChild=function(t){var e=this.getChildPos(t);e>=0&&this.children.splice(e,1),t.parent=null,t.setDocument(null)},this.getParent=function(){return this.parent},this.shouldHaveId=function(){return this.isElement&&!this.script&&!this.textNode&&!this.comment},this.getByPgId=function(t){var e=this.nodeCatalogue?this.nodeCatalogue:this.document?this.document.nodeCatalogue:null;return e?e.get(t):null},this.walk=function(t){for(var e=0;e<this.children.length;e++){if(!t(this.children[e]))return;this.children[e].walk(t)}},this.walkSelfAndChildren=function(t){t(this)&&this.walk(t)},this.find=function(t,e){pgSelectorCache={};for(var i=t.split(","),n=[],s=0;s<i.length;s++){var r=i[s].split(" "),h=this;this.walk(function(t){return t.isTo(r,h)&&(n.indexOf(t)<0&&n.push(t),e)?!1:!0})}return n},this.validateTree=function(){var t=[];return this.walk(function(e){return e.validate()||t.push(e),!0}),t},this.isTo=function(t,e){var i=t[t.length-1],n=!1;if(">"==i.charAt(0)&&(n=!0,i=i.substr(1)),this.isSelector(i)){if(t.length<2)return!0;for(var s=t.length-2,r=this.getParent();r&&r!=e;){var h=t[s],a=!1;if(">"==h.charAt(0)&&(a=!0,h=h.substr(1)),r.isSelector(h)){if(s--,0>s)return!0}else if(n)return!1;r=r.getParent(),n=a}return!1}return!1},this.parseSelector=function(t){return pgSelectorCache[t]||(pgSelectorCache[t]={id:t.match(/#[^\s\.]+/),tag:t.match(/^[^\s\.#]+/),classes:t.match(/\.[^\s\.#]+/g)}),pgSelectorCache[t]},this.isSelector=function(t){var e=this.parseSelector(t);if(e.id&&this.getElementId()!=e.id[0].replace("#",""))return!1;if(e.tag&&e.tag!=this.tagName)return!1;if(e.classes)for(var i=0;i<e.classes.length;i++)if(!this.hasClass(e.classes[i].replace(".","")))return!1;return!0},this.replaceTag=function(t){return this.tagName=t,this.tagNameOriginal=t,this.closingTag&&(this.closingTag=t),this},this.replaceWith=function(t,e){return t.insertBefore(this),e?this.detach():this.remove(),this},this.clone=function(t){var e=new pgParserNode;e.tagName=this.tagName,e.textNode=this.textNode,e.rootNode=this.rootNode,e.attributes=this.getAttributesString(),e.closingTag=this.closingTag,e.selfClosed=this.selfClosed,e.content=this.content,e.singleTag=this.singleTag,e.script=this.script,e.comment=this.comment,e.document=this.document,e.nodeCatalogue=this.nodeCatalogue,e.isElement=this.isElement,e.attrList=null,e.hasPgIdAttr=this.hasPgIdAttr,!t&&e.shouldHaveId()&&(e.assignId(),pgParserNodeCatalogueInstance.add(e));for(var i=0;i<this.children.length;i++)e.addChild(this.children[i].clone(t));return e},this.html=function(t,e){if("undefined"==typeof t||null===t){for(var i="",n=0;n<this.children.length;n++)i+=this.children[n].toString("",!0,e);return i}var s=new pgParser;for(s.parse(t);this.children.length;)this.children[0].remove();for(var n=0;n<s.rootNode.children.length;n++)this.addChild(s.rootNode.children[n])},this.text=function(t){if("undefined"==typeof t||null===t){for(var e="",i=0;i<this.children.length;i++)e+="text"==this.children[i].tagName?this.children[i].toString("",!0,!1):this.children[i].text();return e}this.html(t)},this.isDescendantOf=function(t){for(var e=this.parent;null!=e;){if(e==t)return!0;e=e.parent}return!1},this.getChildPos=function(t){return this.children.indexOf(t)},this.next=function(){for(var t=this.parent.getChildPos(this)+1,e=null;t<this.parent.children.length&&!e;){if(this.parent.children[t].isElement){e=this.parent.children[t];break}t++}return e},this.insertAtIndex=function(t,e,i){if(t==this.parent){var n=this.parent.children.indexOf(this);e>n&&e--}if(this.detach(),i&&e>0){for(var s=0,r=e,n=0;n<t.children.length;n++)if(t.children[n].shouldHaveId()){if(s++,e==s)break}else r++;e=r}return e>=t.children.length?t.children.push(this):t.children.splice(e,0,this),this.parent=t,this.setDocument(this.parent.document),this},this.insert=function(t,e){if(!t.parent)throw new pgParserException("Object has no parent",t);var i=t.parent.getChildPos(t);if(0>i)throw new pgParserException("Node is not in parent child list",t);return e?this.insertAtIndex(t.parent,i):this.insertAtIndex(t.parent,i+1),this},this.detach=function(){this.parent&&this.parent.removeChild(this)},this.remove=function(){for(this.detach(),pgParserNodeCatalogueInstance.remove(this);this.children.length;)this.children[0].remove()},this.insertBefore=function(t){return this.insert(t,!0)},this.insertAfter=function(t){return this.insert(t,!1)},this.appendPrepend=function(t,e){return this.detach(),e?t.children.unshift(this):t.children.push(this),this.parent=t,this.setDocument(this.parent.document),this},this.appendTo=function(t){return this.appendPrepend(t,!1)},this.prependTo=function(t){return this.appendPrepend(t,!0)},this.append=function(t){t.appendTo(this)},this.prepend=function(t){t.prependTo(this)},this.hasClass=function(t){var e=this.getAttr("class");if(e){var i=e.split(" "),n=i.indexOf(t);if(n>=0)return!0}return!1},this.addClass=function(t){var e=this.getAttr("class");if(e){var i=e.split(" "),n=i.indexOf(t);0>n&&(i.push(t),this.setAttr("class",i.join(" ")))}else this.setAttr("class",t)},this.removeClass=function(t){var e=this.getAttr("class");if(e){for(var i=e.split(" "),n=[],s=0;s<i.length;s++)i[s]!=t&&n.push(i[s]);this.setAttr("class",n.join(" "))}},this.canAddClass=function(){return!0},this.canRemoveClass=function(t){return this.hasClass(t)},this.getAttrList=function(){if(this.attrList)return this.attrList;if(this.attrList=[],this.attrListChanged=!1,this.script||this.comment||!this.attributes||0==this.attributes.length)return this.attrList;for(var t=0,i=!1,n="",s=null,r=function(i,n){var s=e.attributes.indexOf(i,t);do{if(0>s)return t=e.attributes.length,null;if(n){var r=e.attributes.indexOf(n,t);if(r>=0&&s>=r&&s+i.length<=r+n.length){t=s+i.length;continue}}var h=e.attributes.substr(t,s-t);return t=s+i.length,h}while(t<e.attributes.length)};t<this.attributes.length;){var h=this.attributes.charAt(t);if(" "==h||"	"==h||"\n"==h||"\r"==h||"/"==h||">"==h||"="==h){if(n.length>0){var a=!1;if(t<this.attributes.length-1)for(;t<this.attributes.length&&(" "==h||"="==h);)"="==h&&(a=!0),t++,h=this.attributes.charAt(t);if(a){i=!0,s='"'==h||"'"==h?h:null;var o="";if(s)t++,o=r(s,"\\"+s);else if(t<this.attributes.length-1)do o+=h,t++,h=this.attributes.charAt(t);while(t<this.attributes.length&&" "!=h&&">"!=h&&"/"!=h);this.attrList.push({name:n.toLowerCase(),value:o})}else t--,this.attrList.push({name:n.toLowerCase(),value:null});n=""}}else n+=h;t++}return n.length&&this.attrList.push({name:n.toLowerCase(),value:null}),this.attrList},this.hasAttr=function(){};var i=function(t,e){var i=[];t=t.toLowerCase();for(var n=0;n<e.length;n++)t==e[n].name&&i.push(e[n]);return i};this.setAttr=function(t,e){var n=this.getAttrList(),s=i(t,n);s.length?s[s.length-1].value=e:n.push({name:t,value:e}),this.attrListChanged=!0},this.getAttr=function(t){var e=this.getAttrList();if(!e)return null;var n=i(t,e);return n.length?n[n.length-1].value:null},this.removeAttr=function(t){var e=this.getAttrList();t=t.toLowerCase(),this.attrList=[];for(var i=0;i<e.length;i++)e[i].name!=t&&this.attrList.push(e[i]);e.length!=this.attrList.length&&(this.attrListChanged=!0)},this.getAttributesString=function(t){if(!this.attrListChanged&&!t)return this.attributes;var e=[],i=this.getAttrList();if(t)for(var n=0;n<i.length;n++){var s=t(this,i[n].name,i[n].value);s&&s.length&&e.push(s)}else for(var n=0;n<i.length;n++)null===i[n].value?e.push(i[n].name):e.push(i[n].name+'="'+i[n].value+'"');return e.length>0?" "+e.join(" "):""},this.getElementId=function(){return this.getAttr("id")},this.getId=function(){if(null===this.pgId){var t=this.attributes.match(pgIdRegExp);t?(this.pgId=t[1],this.hasPgIdAttr=!0):(this.pgId=0,this.hasPgIdAttr=!1)}return 0!==this.pgId?this.pgId:null},this.assignId=function(){return this.hasPgIdAttr&&(this.attributes=this.attributes.replace(pgIdRegExpReplace,""),this.hasPgIdAttr=!1),this.pgId=++pgIdCount,this.pgId},this.getOrAssignId=function(){var t=this.getId();return t||(t=this.assignId()),t},this.assignIdAndAddToCatalog=function(t){if(t)this.walkSelfAndChildren(function(t){if(t.shouldHaveId()){{t.getOrAssignId()}pgParserNodeCatalogueInstance.add(t)}return!0});else if(this.shouldHaveId()){{this.assignId()}pgParserNodeCatalogueInstance.add(this)}},this.get$DOMElement=function(t){return this.$el?this.$el:t?t.find('[data-pg-id="'+this.getId()+'"]'):null},this.mapIdsToDomElement=function(t){var e=this.getId();e&&t.setAttribute("data-pg-id",e);var i=0;if(t.hasChildNodes())for(var n=0;n<this.children.length;n++)if(this.children[n].shouldHaveId()){for(;i<t.childNodes.length&&1!=t.childNodes[i].nodeType;)i++;i<t.childNodes.length&&this.children[n].mapIdsToDomElement(t.childNodes[i]),i++}},this.validate=function(){return"text"!=this.tagName&&(!this.closed||this.closingTag&&this.tagName!=this.closingTag.toLowerCase())?!1:!0},this.toString=function(e,i,n,s,r,h,a){e=e||"",h||(h={indent:"    "}),"undefined"==typeof a&&(a=!0);var o="",l="",d=e,g="",c=null,u="",f=h.indent;this.attrListChanged=this.isElement,this.attrListChanged&&(this.attributes=this.getAttributesString(n?null:pgGetAttributesStringFilterOutPgIds),this.attrListChanged=!1);var p=this.attributes;c=this.getId();var m=r&&pgDontFormat.indexOf(this.tagName)<0;if(m&&pgDontFormatIfAllChildrenNonFormat.indexOf(this.tagName)>=0){m=!1;for(var v=0;v<this.children.length;v++)if(!this.children[v].textNode&&pgDontFormat.indexOf(this.children[v].tagName)<0){m=!0;break}}h.last_format=m;if(m&&(o="\n",l="\n"),e.length&&(l="\n"),this.rootNode&&(f=""),c&&(n?this.hasPgIdAttr||(u=" "+t+'="'+c+'"'):p=p.replace(pgIdRegExp,"")),null===c&&n&&this.isElement&&(c=this.assignId(),u=" "+t+'="'+c+'"'),i&&this.textNode)return m&&this.content.match(pgWhiteSpaceRegExp)?"":this.content;for(var b="",N=!0,C=!1,v=0;v<this.children.length;v++)if(i||!this.children[v].textNode){N=N&&this.children[v].textNode;var I=this.children[v].toString(e+f,i,n,s,r,h,m),A=h.last_format,x=this.children[v].textNode;if(m)if(I.length){if(x){if(I.length){var P="";"\n"==I.charAt(0)&&(I=I.replace(/^\n\s*/,""),C=!0,P="\n"),C&&(I=P+e+f+I,v+1<this.children.length?this.children[v+1].textNode||(I+="\n"):I+="\n")}}else(!this.rootNode||b.length)&&(I="\n"+I);C=A}else v+1==this.children.length&&(I="\n"+I);b+=I}return m&&this.children.length&&!N&&b.length&&!this.rootNode&&"\n"!=b.charAt(b.length-1)&&(b+="\n"),m&&N&&(o="",d=""),l="",h.last_format=m,p.length&&s&&(p=s(this,p,"attrs")),this.rootNode?g+b:(g+=(a?e:"")+"<"+(this.tagNameOriginal?this.tagNameOriginal:this.tagName)+p+u+(this.selfClosed?"/":"")+">",this.content&&(b+=this.content),s&&(b=s(this,b,"content")),g+=m?b:b,g+=this.singleTag?l:this.closingTag?(m?d:"")+"</"+this.closingTag+">"+l:l,s&&(g=s(this,g,"node")),g)},this.toStringOriginal=function(t,e,i){return this.toString(null,!0,!1,i,t,e)},this.toStringWithIds=function(t,e,i){return this.toString(null,!0,!0,i,t,e)},this.toDebug=function(){var t="";if(this.textNode?t="[TEXT] "+this.content:this.rootNode||(t=this.tagNameOriginal?this.tagNameOriginal:this.tagName,this.closed&&(t+=" /"+this.closingTag)),this.children.length){t+="<ul>";for(var e=0;e<this.children.length;e++)t+=this.children[e].toDebug();t+="</ul>"}return this.rootNode?t:"<li>"+t+"</li>"}},pgParser=function(){var t=null;this.singleTags=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr","!","?php","!doctype"],this.closingTags={html:[],head:["body"],body:[],p:["p","address","article","aside","blockquote","div","dl","fieldset","footer","form","h1","h2","h3","h4","h5","h6","header","hr","menu","nav","ol","pre","section","table","ul"],dd:["dd"],dt:["dt"],option:["option","optgroup"],optgroup:["optgroup"],thead:["tbody","tfoot"],th:["td","th"],tbody:["tfoot"],tr:["tr"],td:["td","th"],tfoot:["tbody"],colgroup:[],li:["li"]};this.assignIds=!0;var e=0,i=/[a-z0-9\?!:\-]/i,n=function(t,n){return 0==n.length&&(e=0,"/"==t)?!0:(0==e&&"!"==t&&(e=1),1==e&&"!--"==n?!1:t.match(i))},s=function(t){return">"!=t};this.replaceExistingIds=!1,this.rootNode=null,this.getNode=function(t){return pgParserNodeCatalogueInstance.get(t)},this.parse=function(e,i,r){t=e;var h=this,a=[];this.rootNode=new pgParserNode,this.rootNode.tagName="document",this.rootNode.rootNode=!0,this.rootNode.nodeCatalogue=pgParserNodeCatalogueInstance,this.rootNode.document=this.rootNode,this.replacedIds=[];var o=t.length,l=this.rootNode,d=0,g=function(e){for(var i=0;i<e.length;i++)if(d+i>=o||e.charAt(i)!=t.charAt(d+i))return!1;return!0},c=function(e,i){var n="",s="<?php",r="?>",h=!1;do{if(g(s))h=!0;else if(g(r)){if(h=!1,n+=t.substr(d,r.length),d+=r.length,d>=o)break;continue}var a=t.charAt(d);if(h)n+=a;else{if(!e(a,n))return n;if(n+=a,i&&('"'==a||"'"==a)){var l=a,c=!1;for(d++;o>d;){if(a=t.charAt(d),a==l&&!c){n+=a;break}c=c||"\\"!=a?!1:!0,n+=a,d++}}}d++}while(o>d);return n},u=function(e){var i=null,n=t.indexOf(e,d);return 0>n?(i=t.substr(d,o-d),d=o-1):(i=t.substr(d,n-d+e.length-1),d=n+e.length-1),i},f=function(){for(var e=(new Date).getTime(),g=50,p=0;o>d;){var m=t.indexOf("<",d);if(0>m){var v=new pgParserNode;v.tagName="text",v.content=t.substr(d),v.closingTag=v.tagName,v.textNode=!0,v.document=h.rootNode,l.addChild(v),d=o}else{if(m>d)for(var b=t.substr(d,m-d).split("\n"),N=0;N<b.length;N++){var v=new pgParserNode;v.tagName="text",v.content=(N>0?"\n":"")+b[N],v.closingTag=v.tagName,v.textNode=!0,v.document=h.rootNode,l.addChild(v)}d=m+1;var C,I=c(n),A=!1;"!"==I.charAt(0)&&0==I.indexOf("!--")?(C=u("-->"),A=!0):C="?php"==I?u("?>"):c(s,!0);var x=!1;C.length&&"/"==C.charAt(C.length-1)&&(x=!0,C=C.substr(0,C.length-1));var P=h.singleTags.indexOf(I.toLowerCase())>=0||x;if(A&&(P=!0),d++,"/"!=I.charAt(0)){S=new pgParserNode,S.tagName=I.toLowerCase(),S.tagNameOriginal=I,S.attributes=C,S.script="?php"==I,S.comment=A,S.document=h.rootNode,S.selfClosed=x,S.isElement=!S.script&&!S.comment&&"!"!=S.tagName.charAt(0),l.addChild(S),P?(S.singleTag=!0,S.closed=!0):(a.push(l),l=S),"script"==I&&(S.content=u("</script>"),S.closingTag="script",S.content.length>=8&&(S.content=S.content.substr(0,S.content.length-8)),S.closed=!0,l=a.pop(),d++);var w=S.getId();if(h.assignIds&&S.shouldHaveId()){if(w){if(h.replaceExistingIds){var T=S.assignId();h.replacedIds.push({old:w,"new":T}),w=T}}else w=S.assignId();parseInt(w)>pgIdCount&&(pgIdCount=parseInt(w)),pgParserNodeCatalogueInstance.add(S)}S.getAttrList()}else{var L=I.replace("/","").toLowerCase();if(l.tagName==L)l.closingTag=I.replace("/",""),l.closed=!0,l=a.length?a.pop():l;else{for(var O=-1,m=a.length-1;m>=0;m--)if(a[m].tagName==L){O=m,a[m].closingTag=I.replace("/",""),a[m].closed=!0;break}if(O>=0){for(;a.length>O+0;){var S=a.pop();if(S.closed=!0,h.closingTags[S.tagName]&&S.children.length){"option"==S.tagName&&(E=E);for(var E=0,k=S;E<S.children.length;)h.closingTags[S.tagName].indexOf(S.children[E].tagName)>=0?k=S.children[E].insertAfter(k):E++}}l=a.length?a.pop():l}else l.closingTag=I.replace("/",""),l.closed=!0,l=a.length?a.pop():l}}}if(p++,p%10==0&&i){var y=(new Date).getTime()-e;if(y>=g){r&&r(),setTimeout(f,10);break}}}d>=o&&i&&i()};f()},this.find=function(t){return this.rootNode.find(t)},this.toStringOriginal=function(t,e,i){return this.rootNode.toStringOriginal(t,e,i)},this.toStringWithIds=function(t,e,i){return this.rootNode.toStringWithIds(t,e,i)},this.validate=function(){return this.rootNode.validateTree()}};