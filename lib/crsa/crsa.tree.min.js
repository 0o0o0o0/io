var CrsaTree=function(e){this.$dest=e,this.$iframe=null,this.onSortStart=null,this.onSortStop=null,this.onSortReceive=null,this.currentCrsaPage=null,this.ready=!1;var t,a,n,r,s=this,o="",l=!1,i=null,d=null,c=300,u={name:"dummy",display_name:"tag"},f=function(e,t){var a=!1,n=!1,r=e.find(">ul");return r.find(">li").each(function(e,a){var r=$(a);if(!l||r.hasClass("child-found")||r.hasClass("found")){var s=f(r,t);n=n||s}}),a=n,e.find(">div").text().match(t)?(e.removeClass("not-found").addClass("found"),n=!0):(e.removeClass("found").addClass("not-found"),a?e.addClass("child-found"):e.removeClass("child-found")),n},h=function(){var e=i.val(),t=e.length>0?new RegExp(escapeRegExp(e),"i"):null;l=o.length>0&&0==e.indexOf(o)&&e!=o,""==o&&e.length>0&&setTimeout(function(){},2500),!l&&o.length>0&&d.find("li").removeClass("not-found found child-found"),t&&d.find(">li").each(function(e,a){f($(a),t)}),o=e,o.length>0},m=function(e){return e.data("has-events")?(console.log("has events"),void 0):(e.on("mouseover",function(e){var t=$(e.delegateTarget).data("crsa-element");$.fn.crsa("highlightElement",t),e.stopImmediatePropagation()}).on("mouseout",function(e){$(e.delegateTarget).data("crsa-element");$.fn.crsa("highlightElement",null),e.stopImmediatePropagation()}).on("click",function(e){var t=$(e.delegateTarget).closest("li"),a=(t.find("> div"),t.data("crsa-element"));$("#crsa-dummy-field").focus(),$.fn.crsa("selectElement",a),$.fn.crsa("scrollCanvasToElement",a),e.stopImmediatePropagation(),e.preventDefault(),$("body").trigger("click")}),e.find("> div > i.crsa-collapse").on("click",function(e){var t=$(e.delegateTarget),a=t.closest("li"),n=(a.find("> ul"),a.data("crsa-element"));$.fn.crsa("collapseElement",n,null),e.preventDefault(),e.stopPropagation()}),e.find("> div > i.crsa-visible").on("click",function(e){var t=$(e.delegateTarget),a=t.closest("li"),n=(a.find("> ul"),a.data("crsa-element")),r=!1;if(a.hasClass("crsa-tree-node-hidden")?(a.removeClass("crsa-tree-node-hidden"),t.addClass("fa-eye").removeClass("fa-eye-slash"),n.data("crsa-tree-hidden",null)):(a.addClass("crsa-tree-node-hidden"),t.addClass("fa-eye-slash").removeClass("fa-eye"),n.data("crsa-tree-hidden",!0),r=!0),r){var s=n.attr("style");null==s&&(s=""),n.get(0).crsaOriginalStyle=s}var o=n.get(0).crsaOriginalStyle;r?n.animate({opacity:0},250,function(){n.hide()}):(n.show().css("opacity",0),n.animate({opacity:1},250,function(){null==o||""==o?n.removeAttr("style"):n.attr("style",o),n.removeAttr("crsaOriginalStyle")})),e.preventDefault()}),e.data("has-events",!0),void 0)},v=function(e){e.nestedSortable({forcePlaceholderSize:!0,helper:"clone",placeholder:"tree-placeholder",handle:"div",tabSize:20,tolerance:"pointer",isTree:!0,items:"li.sort",listType:"ul",toleranceElement:"> div"}).on("sortreceive",function(e,t){console.log("received "+t.item.text());var a=t.item.parent().closest("li"),n=t.item.data("crsa-element"),r=a.data("crsa-element"),o=a.find("> ul > li").index(t.item);s.onSortReceive&&s.onSortReceive(n,r,o,t)}).on("sortupdate",function(){}).on("sortstop",function(e,t){var a=t.item.parent().closest("li"),n=t.item.data("crsa-element"),r=a.data("crsa-element"),o=a.find("> ul > li").index(t.item);s.onSortStop&&s.onSortStop(n,r,o,t)}).on("sortstart",function(e,t){var a=t.item.data("crsa-element");s.onSortStart&&s.onSortStart(a)})};this.hideTree=function(){var t=e.find("> div.tree-container");c=s.$dest.width(),s.$dest.addClass("closed"),s.$dest.animate({width:30},150,function(){r.removeClass("fa-angle-double-right").addClass("fa-angle-double-left"),t.hide(),e.css("overflow","hidden"),$(window).trigger("resize")})},this.showTree=function(t){var a=e.find("> div.tree-container");300>c&&(c=300),s.$dest.removeClass("closed"),a.show(),t?(r.addClass("fa-angle-double-right").removeClass("fa-angle-double-left"),e.css("overflow","auto"),s.currentCrsaPage&&s.currentCrsaPage.treeRepaintOnShow&&s.showTreeForIframe(s.currentCrsaPage.$iframe)):s.$dest.animate({width:c},150,function(){r.addClass("fa-angle-double-right").removeClass("fa-angle-double-left"),e.css("overflow","auto"),$(window).trigger("resize"),s.currentCrsaPage&&s.currentCrsaPage.treeRepaintOnShow&&s.showTreeForIframe(s.currentCrsaPage.$iframe)})},this.initUI=function(){this.$dest.html(""),t=0;var n=$("<div/>",{"class":"header"}).html('<i class="hider fa fa-angle-double-right"></i>').appendTo(e);i=$("<input/>",{placeholder:"search tree","class":"form-control filter-form"}).appendTo(n).on("input",h),i.tooltip({container:"body",placement:"left",title:"Tree Drag & Drop is disabled when filter is set.",trigger:"manual"}),r=n.find("i.hider").on("click",function(e){s.$dest.width();s.$dest.hasClass("closed")?s.showTree():s.hideTree(),e.preventDefault()}),a=$("<div/>",{"class":"tree-container"}).appendTo(this.$dest);$("<div/>",{"class":"tree-resizer"}).appendTo(this.$dest).on("mousedown",function(e){e.preventDefault(),$.fn.crsapages("showOverlays"),$("body").on("mousemove.tree",function(e){var t=$(window).width()-(e.pageX<500?500:e.pageX)-12;30>=t?(t=30,s.$dest.hasClass("closed")||s.hideTree()):s.$dest.hasClass("closed")&&s.showTree(!0),s.$dest.css("width",t+"px")}).on("mouseup.tree",function(e){e.preventDefault(),$("body").off(".tree"),$.fn.crsapages("showOverlays",!0),$.fn.crsapages("canvasResized")})});return!1};var p=function(){return s.$dest.hasClass("closed")},g=function(e){var t=$("<li/>"),a=getType(e,!1,!1,s.currentCrsaPage);e.is("body")?t.addClass("no-sort"):t.addClass("sort");var n;n=a?getElementName(e,a,!0,!1,!0):getElementName(e,u,!0,!1,!1);var r="fa-eye";e.get(0).crsaOriginalStyle&&(t.addClass("crsa-tree-node-hidden"),r="fa-eye-slash");var o=a&&a.tags?" tag-"+a.tags:"",l='<div class="crsa-tree-node-name'+o+'"><i class="crsa-collapse fa fa-fw fa-angle-down"></i><i class="crsa-visible fa fa-fw '+r+'"></i>'+n+"</div>";return t.html(l).data("crsa-element",e),e.data("crsa-tree-node",t),a&&a.paint_tree_node&&a.paint_tree_node(t,e),t},w=[],C=function(e,a,n,r){var o=null,l=null;if(r)l=e;else try{n>t&&(t=n),o=g(a),e.append(o),o.data("menu-level",n)}catch(i){console.log(i)}var d=a.get(0).children;if(d.length>0)for(var c=0;c<d.length;c++){var u=d.item(c);if(1==u.nodeType){var f=$(u),h=getType(f,!1,!1,s.currentCrsaPage);h&&(l||(l=$("<ul/>"),o.append(l),o.addClass("has-children"),l.addClass("crsa-tree-branch")),w.push({ul:l,node:f,level:n+1,only_kids:!1}))}}return a.data("crsa-tree-collapsed")&&(l&&l.addClass("crsa-tree-node-closed"),o.find("i.crsa-collapse").addClass("fa-angle-right").removeClass("fa-angle-down"),o.addClass("collapsed")),o},T=null,y=function(e){var t=!1;e.treeTop||(e.treeTop=$("<ul/>").addClass("crsa-tree-branch"),t=!0),s.currentCrsaPage!=e&&(d&&d.detach(),d=e.treeTop,a.append(d),t&&v(e.treeTop),s.currentCrsaPage=e)};this.showTreeForIframe=function(e,t){if(e){var a=getCrsaPageForIframe(e);y(a),a.treeRepaintOnShow&&!t&&(this.paintTree(a.$iframe,a.treeRepaintOnShow===!0?getTreeRootForElement(null,a.$iframe):a.treeRepaintOnShow),a.treeRepaintOnShow=null)}else d&&d.detach(),this.currentCrsaPage=null},this.closeTreeForPage=function(e){e==this.currentCrsaPage&&(e.treeTop.detach(),T&&(window.cancelAnimationFrame(T),T=null),this.currentCrsaPage=null),e.treeTop=null,e.treeCurrentRoot=null,e.treeRepaintOnShow=null},this.paintTree=function(e,a){var n,r=e&&a?getTreeRootForElement(a,e):null;if(e&&(n=getCrsaPageForIframe(e),n!=this.currentCrsaPage||p()))return n.treeRepaintOnShow=null==n.treeRepaintOnShow?a:r,void 0;if(!e||!a||!r)return d.html(""),void 0;n.treeCurrentRoot=r,this.$iframe=e,l||(l=d);var s,l=d,c=!1,u=0,f=t;t=0;var v=!1;if(a){s=a;var g=getTreeNodeForElement(s);!g||s.get(0)==r.get(0)||T||0==d.get(0).children.length?(s=r,l=d):(l=g.closest("ul.crsa-tree-branch"),l.length>0?(c=!0,s=s.parent(),u=g.data("menu-level"),t=f):(l=d,s=r))}else s=r;v&&(window.requestAnimationFrame=function(e){return setTimeout(function(){e()},100)},window.cancelAnimationFrame=function(){}),w=[],w.push({ul:l,node:s,level:u,only_kids:c});var y=10,S=75,P=0,R=function(){var e=20*t+150;300>e&&(e=300),b(),i.val(o),h()},x=function(){if(w.length>0){var e=(new Date).getTime(),t=0;do{for(var a=[],n=0;y>n&&w.length>0;){var r=w.shift(),s=C(r.ul,r.node,r.level,r.only_kids);s&&a.push(s.get(0)),n++}m($(a)),t=(new Date).getTime()-e}while(S>t&&w.length>0);P+=t,w.length>0?T=window.requestAnimationFrame(function(){x()}):(T=null,R())}};T&&(window.cancelAnimationFrame(T),T=null),T=window.requestAnimationFrame(function(){l.html(""),x()})};var b=function(){if(n){var e=getTreeNodeForElement(n);if(e){e.addClass("crsa-tree-node-selected");var t=e.position(),a=$("#crsa-tree > div.tree-container"),r=a.height(),s=20,o=a.scrollTop();if(t.top>=0&&t.top<r-s);else{var l=t.top+o-100;0>l&&(l=0),a.animate({scrollTop:l},150)}}}};this.setSelectedElement=function(e,t){if(d.find("li.crsa-tree-node-selected").removeClass("crsa-tree-node-selected"),n){var a=getTreeNodeForElement(n);a&&a.removeClass("crsa-tree-node-selected")}n=e,t||b()},this.initUI(),this.ready=!0},CrsaContextMenu=function(){var e=this;this.actions=[],this.add=function(e,t,a,n){n||(n="link"),this.actions.push({label:e,kbd:t,func:a,type:n})};var t,a,n,r,s,o,l,i;this.close=function(){t.remove(),t=null,$(document).off(".crsamenu"),n&&n.off(".crsamenu"),a&&(a.remove(),a=null)},this.showAt=function(d,c,u){if(0!=this.actions.length){$(document).trigger("click"),t=$('<ul class="dropdown-menu context-menu" role="menu"></ul>'),$.each(this.actions,function(a,n){var r;if("divider"==n.type?a>0&&(r=$('<li class="divider">'+n.label+"</li>")):r="header"==n.type?$('<li class="dropdown-header">'+n.label+"</li>"):$('<li><a href="#">'+n.label+"</a></li>"),r){var s=r.find("a").data("action",n);n.kbd&&crsaAddKbd(s,n.kbd),s.on("click",function(t){t.preventDefault();var a=$(t.delegateTarget).data("action");a.func(e),e.close()}),t.append(r)}}),$("body").append(t),t.css("top",c+"px").css("left",d+"px"),s=c,"ontouchstart"in document.documentElement&&(a=$('<div class="dropdown-backdrop"/>').insertBefore(t).on("click",this.close)),$(document).off(".crsamenu").on("click.crsamenu",this.close),u&&(u.off(".crsamenu").on("scroll.crsamenu",function(){var e=s+(r-u.scrollTop());t.css("top",e+"px");var a=0;o>e&&(a=o-e-2,0>a&&(a=0)),t.css("clip","rect("+a+"px, "+i+"px, "+l+"px, 0px)")}),r=u.scrollTop(),o=u.offset().top),n=u,t.data("menu",this);var f;return t.on("mousewheel.crsamenu",function(){var e=t.get(0);e.classList.contains("crsa-disable-hover")||e.classList.add("crsa-disable-hover"),f=setTimeout(function(){e.classList.remove("crsa-disable-hover")},250)}),t.show(),l=t.outerHeight(),i=t.outerWidth(),u&&s+l>$(window).height()&&(s-=l,t.css("top",s+"px")),t}}};