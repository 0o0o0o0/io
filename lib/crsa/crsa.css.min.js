function setRuleInfo(e){if(e.raw)e.type="raw";else if(e.selector){e.classes=getClassesFromSelector(e.selector);var s=getClassFromSelector(e.selector);if(s)e.type="class",e.class=s;else{var t=getIdFromSelector(e.selector);if(t)e.type="element_id",e.element_id=t;else{var a=getTagFromSelector(e.selector);a?(e.type="tag",e.tag=a):e.type="composite"}}}else e.type="unknown";return e}var getRuleName=function(e){return e.selector?e.selector:(e.raw&&shortenString(e.raw,18),"Rule")},normalizeSelector=function(e){for(var s=e.split(","),t=0;t<s.length;t++)s[t]=$.trim(s[t].replace("\n","").replace(/\s{2,}/gi," "));return s.join(",")},_crsaCss_re_classes=/\.-?[_a-zA-Z]+[_a-zA-Z0-9-]*/g,_crsaCss_re_class=/^\.(-?[_a-zA-Z]+[_a-zA-Z0-9-]*)$/,_crsaCss_re_id=/^\#(-?[_a-zA-Z]+[_a-zA-Z0-9-]*)$/,_crsaCss_re_tag=/^(-?[a-zA-Z]+[_a-zA-Z0-9-]*)$/,getClassesFromSelector=function(e){var s=e.match(_crsaCss_re_classes);if(s){for(var t={},a=0;a<s.length;a++)t[s[a]]=!0;var r=[];for(var n in t)r.push(n);return r}return null},getClassFromSelector=function(e){var s=e.match(_crsaCss_re_class);return s?s[1]:null},getIdFromSelector=function(e){var s=e.match(_crsaCss_re_id);return s?s[1]:null},getTagFromSelector=function(e){var s=e.match(_crsaCss_re_tag);return s?s[1]:null};!function(e){function s(s){var t=e("body"),a=makeDialog("Edit rule source","Cancel","Keep changes","<div></div>").css("width","50%").addClass("crsa-dialog-edit");t.append(a);var r=a.find(".modal-body>div").css("height","200px"),n=ace.edit(r.get(0));n.setTheme("ace/theme/"+pinegrow.getSetting("code-theme","xcode")),n.getSession().setUseWrapMode(!0),n.getSession().setMode("ace/mode/less");var l=s.crsa_stylesheet;getCrsaPageForIframe(e.fn.crsa("getSelectedPage")).undoStack.add("Edit CSS rule");var o=!1,i=function(e){s.edited_source=e,l.genRegenerateRule(s,function(){var s=l.genGetError();if(s){var t=e.split("\n").length;o=!0,n.getSession().setAnnotations([{row:t>=s.line?s.line-1:0,column:s.column,text:"Syntax error: "+s.message,type:"error"}])}else l.changed=!0,o&&(n.getSession().clearAnnotations(),o=!1)})},c=s.crsa_stylesheet.genGetSourceForRules([s]);n.setValue(c,-1),n.getSession().getSelection().clearSelection(),n.getSession().on("change",function(){i(n.getValue())}),a.find("button.close,button.cancel").click(function(){try{getCrsaPageForIframe(e.fn.crsa("getSelectedPage")).undoStack.remove(),s.edited_source=c,l.genForgetCachedSource(),l.genRegenerateAndSetCssSource(function(){e("body").trigger("crsa-stylesheets-changed")})}catch(t){}a.hide(),a.remove()}),a.find("button.ok").click(function(){try{l.genRegenerateAndSetCssSource(function(){e("body").trigger("crsa-stylesheets-changed")})}catch(s){}a.hide(),a.remove()});t.width()-a.width()-100,t.height()-a.height()-100;a.draggable({handle:".modal-header"}).on("dragstart",function(){e.fn.crsapages("showOverlays")}).on("dragstop",function(){e.fn.crsapages("showOverlays",!0)})}function t(e){var s=e.contentDocument||e.contentWindow.document;return s.body}function a(e){return e.contentDocument||e.contentWindow.document}window.CrsaSimpleCssParser=function(){this.rules=[];var s=this;this.parse=function(t,a){this.rules=[];for(var r=0,n="",l="",o="",i=!1,c="",u=new CrsaSimpleCssParser,d=function(e,s){for(var t=s.i,a=s.i,r=s.str;a<r.length;){var n=r.charAt(a);if(n==e){var l=a-1>=t?r.charAt(a-1):"",o=a-2>=t?r.charAt(a-2):"";if("\\"!=l||"\\"==l&&"\\"==o)return a++,s.i=a,void 0}a++}s.i=a},h=function(e){for(var s=[],t=0,a=0,r=function(){t>a&&(s.push(e.substr(a,t-a)),a=t)};t<e.length;){var n=e.charAt(t),l=t<e.length-1?e.charAt(t+1):"",o=(t>0?e.charAt(t-1):"",!1);if("'"!=n&&'"'!=n){if("/"==n&&"/"==l){r();var i=e.indexOf("\n",t);t>i&&(i=e.length),a=i+1,t=a,o=!0}else if("/"==n&&"*"==l){r();var i=e.indexOf("*/",t);t>i&&(i=e.length),a=i+2,t=a,o=!0}o||t++}else{r(),t++;var c={i:t,str:e};d(n,c),t=c.i}}return r(),s.join("")},f=function(){if(n=e.trim(n),l=e.trim(l),c=e.trim(c),o=e.trim(o),n.length>0||l.length>0||c.length>0){var t;if(c.length>0)t={},t.less_type="Comment",t.raw=c,t.crsa_stylesheet=a,setRuleInfo(t),s.rules.push(t);else if(n.match(/^@media/gi))o.length>0?(u.parse(o),e.each(u.rules,function(r,l){t={},t.media=e.trim(n.replace(/^@media/i,"")),l.values&&(t.values=l.values),l.selector&&(t.selector=l.selector),l.raw&&(t.raw=l.raw),t.crsa_stylesheet=a,setRuleInfo(t),s.rules.push(t)})):(t={},t.raw=n+l,t.crsa_stylesheet=a,setRuleInfo(t),s.rules.push(t));else if(0==n.indexOf("@"))t={},t.raw=n+l,t.crsa_stylesheet=a,setRuleInfo(t),s.rules.push(t);else if(n.length>0&&l.length>0){t={},t.selector=n,t.values={},o=h(o);for(var r=[],i=0,f=0,g=o.length;g>i;){var p=o.charAt(i);if("'"==p||'"'==p){i++;var v={str:o,i:i};d(p,v),i=v.i}else";"==p&&i>f&&(r.push(o.substr(f,i-f)),f=i+1),i++}i>f&&r.push(o.substr(f,i-f)),e.each(r,function(s,a){if(a=e.trim(a),a.length>0){var r=a.indexOf(":");if(r>0){var n={};n.name=e.trim(a.substr(0,r)),n.value=r<a.length-1?e.trim(a.substr(r+1)):null,n.important=n.value?null!=n.value.match(/\!important/i):!1,t.values[n.name]=n}}}),t.crsa_stylesheet=a,setRuleInfo(t),s.rules.push(t)}}n="",l="",c="",o=""},g=0,p="",v=t.charAt(0);g<t.length;){if(p=t.charAt(g),v=g<t.length-1?t.charAt(g+1):"",0==r&&"/"==p&&"*"==v)i=!0;else if(i&&"*"==p&&"/"==v){i=!1,c+="*/",f(),g+=2;continue}i?c+=p:"{"==p?(r++,l+=p,r>1&&(o+=p)):"}"==p?(r>0&&(r--,l+=p,r>0&&(o+=p)),0==r&&f()):0==r?n+=p:(l+=p,o+=p),g++}if(n=e.trim(n),n.length>0){if(r>0)for(var m=r;m>0;m--)l+="}";f()}}};var r=new CrsaSimpleCssParser;r.parse(""),window.CrsaVariable=function(){this.name=null,this.value=null,this.cs=null,this.global=!1,this.isInUse=function(){for(var e=new RegExp(escapeRegExp(this.name)+"\\W","i"),s=0;s<n.length;s++){var t=n[s],a=t.genGetSourceForRules(t.crsa_rules);if(a.match(e))return!0}return!1},this.valueChanged=function(s,t){this.value=s,this.cs.less_source=null,this.cs.changed=!0;var a=this.global?n:[this.cs],r=0;e.each(a,function(e,s){r++,s.genRegenerateAndSetCssSource(function(){r--,0==r&&t&&t()},!1)})}},window.CrsaVariables=function(){this.list=[];var s=this;this.findByName=function(s,t){var a=null;return e.each(this.list,function(e,r){return r.cs==t&&r.name==s?(a=r,!1):void 0}),a},this.add=function(e,s,t){var a=this.findByName(e,t);return a||(a=new CrsaVariable,a.name=e,a.cs=t,this.list.push(a)),a.value=s,a},this.remove=function(s,t){var a=this.list.indexOf(s);a>=0&&this.list.splice(a,1),s.cs&&(s.cs.less_source=null,s.cs.genRegenerateAndSetCssSource(function(){e("body").trigger("crsa-stylesheets-changed"),t&&t()}))},this.getVarsForCs=function(s,t){var a=[];return e.each(this.list,function(e,r){(r.cs==s||t&&r.global)&&a.push(r)}),a},this.getAllVars=function(){var t=[];return e.each(n,function(e,a){t=t.concat(s.getVarsForCs(a,!1))}),t},this.removeVarsForCs=function(s){var t=[];e.each(this.list,function(e,a){a.cs!=s&&t.push(a)}),this.list=t}},window.CrsaStylesheet=function(){this.less_source=null,this.less_tree=null,this.crsa_rules=[],this.less_variables={},this.less_variables_string="",this.css_source="",this.url=null,this.name=null,this.dom_ss=[],this.changed=!1,this.less_error=null,this.loaded_type=null,this.inline=!1,this.loaded=!1,this.less_mode=!0,this.has_less_file=!1,this.ignore=!1;var s=this;this.genGetType=function(){return this.loaded_type&&"css"!=this.loaded_type?this.loaded_type:this.usesLessFeatures()?"less":"css"},this.genSetSource=function(e,t,a){switch(this.genGetType()){case"less":this.setLessSource(e,t,a);break;default:var r=new CrsaSimpleCssParser;r.parse(e,s),this.crsa_rules=r.rules,this.setAllCssText(e),setTimeout(function(){t&&t()},10)}},this.genGetSource=function(){switch(this.genGetType()){case"less":return this.getLessSource();default:return this.css_source||(this.css_source=this.genGetSourceForRules()),this.css_source}},this.genForgetCachedSource=function(){this.less_source=null,this.css_source=null},this.genRegenerateAndSetCssSource=function(e,s,t){switch("undefined"==typeof s&&(s=!0),"undefined"==typeof t&&(t=!1),this.genGetType()){case"less":this.regenerateAndSetCssSource(e,s,t);break;default:var a=this.genGetSourceForRules();if(!s){this.setAllCssText(a),setTimeout(function(){e&&e()},10);break}this.genSetSource(a,e)}},this.genRegenerateCssFromSource=function(e,s,t){switch("undefined"==typeof s&&(s=!0),"undefined"==typeof t&&(t=!1),this.genGetType()){case"less":this.regenerateCssFromLessSource(e,s,t);break;default:var a=this.genGetSourceForRules();s?this.genSetSource(a,function(){e&&e(a)}):(this.css_source=a,setTimeout(function(){e&&e(a)},10))}},this.genGetSourceForRules=function(e){return this.getLessSourceForRules(e)},this.genGetSourceHtmlForRule=function(e){return this.getLessSourceHtmlForRule(e)},this.genGetError=function(){switch(this.genGetType()){case"less":return this.less_error}return null},this.genRegenerateRule=function(e,s){switch(this.genGetType()){case"less":this.regenerateLessRule(e,s);break;default:this.cssRuleValueChanged(e,null,null,s)}},this.genRuleValueChanged=function(e,s,t,a,r){switch(this.genGetType()){case"less":this.lessRuleValueChanged(e,s,t,a,r);break;default:this.cssRuleValueChanged(e,s,t,a,r)}},this.genFindRules=function(e){return this.findLessRules(e)},this.setUrl=function(e){this.url=e,this.name=e.split("/").pop()},this.loadInline=function(s,t){var a=function(e,s,a){setTimeout(function(){t(e,s,a)},1)};s.ownerNode||t&&a(),this.name="(inline)";var r=e(s.ownerNode),n=r.html();this.loaded_type="css",this.loaded=!0,this.inline=!0,this.genSetSource(n,a())},this.reload=function(e){this.load(this.url,e,!0)},this.load=function(t,a,r){this.setUrl(t);var n=function(e,t,r){a&&setTimeout(function(){a(s,e,t,r)},1)};if(this.ignore&&!r)return n(),void 0;var l=crsaRemoveUrlParameters(t),o=l.replace(/\.css$/i,".less");o==l&&(o+=".less");var i,c=function(){if(s.loaded_type="css",isApp()&&crsaIsFileUrl(t))try{var a=i.readFileSync(crsaMakeFileFromUrl(t),{encoding:"utf8"});console.log("loaded css "+t),s.genSetSource(a,function(){s.changed=!1,s.loaded=!0,n()})}catch(r){s.genSetSource("",n)}else e.ajax({url:t,data:null,dataType:"text"}).done(function(e){console.log("loaded css "+t),s.genSetSource(e,function(){s.changed=!1,s.loaded=!0,n()})}).fail(function(){s.loaded=!0,s.genSetSource("",n)})};if(isApp()&&crsaIsFileUrl(o))try{i=require("fs");var u=i.readFileSync(crsaMakeFileFromUrl(o),{encoding:"utf8"});console.log("loaded "+o),s.has_less_file=!0,s.setLessSource(u,function(){s.less_error?(console.log("invalid less "+o),doneAsync()):(s.loaded=!0,console.log("loaded less "+o),s.loaded_type="less",s.changed=!1,n())})}catch(d){c()}else console.log("Loading "+o),e.ajax({url:o,data:null,dataType:"text"}).done(function(e){console.log("loaded "+o),s.has_less_file=!0,s.setLessSource(e,function(){s.less_error?(console.log("invalid less "+o),n()):(s.loaded=!0,console.log("loaded less "+o),s.loaded_type="less",s.changed=!1,n())})}).fail(function(){console.log("Failed loading "+o),c()})},this.shouldSaveLess=function(){return this.has_less_file||this.usesLessFeatures()},this.usesLessFeatures=function(){var e=l.getVarsForCs(this,!0);return e.length?!0:!1},this.save=function(e,t,a){a||(a=require("fs"));var r=this;r.getCssSource(function(n){setTimeout(function(){try{if(crsaWriteFileWithBackup(a,e,n,"utf8"),console.log("saved css path "+e),s.shouldSaveLess()){var l=r.getLessSource();r.has_less_file=!0;var o=e.replace(/\.css$/i,".less");o==e&&(o+=".less"),crsaWriteFileWithBackup(a,o,l,"utf8"),console.log("saved less file "+o);var i=e.replace(/\.css$/i,".scss");i==e&&(i+=".scss"),crsaWriteFileWithBackup(a,i,s.getSassSourceForRules(),"utf8"),console.log("saved scss file "+i)}r.changed=!1,r.setUrl(crsaMakeUrlFromFile(e)),t&&t()}catch(c){t(c)}},10)})},this.attachTo=function(t,r,n,l){if(r)this.dom_ss.indexOf(r)<0&&(this.dom_ss.push(r),s.loaded&&!s.genGetError()?s.getCssSource(function(e){s.genGetError()||s.setAllCssTextForPage(null,r,e),n&&n()}):n&&n());else{{var o=(a(t),crsaMakeLinkRelativeTo(this.url,getCrsaPageForIframe(e(t)).url));y(t,o,function(e){s.dom_ss.push(e),s.loaded?s.getCssSource(function(t){s.genGetError()||s.setAllCssTextForPage(null,e,t),n&&n()}):n&&n()},l)}t&&getCrsaPageForIframe(e(t)).setPageChanged(!0)}},this.detachFrom=function(s){var t=this.findAttachmentFor(s);if(t){var a=this.dom_ss.indexOf(t);e(t.ownerNode).remove(),this.dom_ss.splice(a,1)}s&&getCrsaPageForIframe(e(s)).setPageChanged(!0)},this.reattachToAll=function(s){this.cleanDomSs();var t=0,a=this.dom_ss;if(this.dom_ss=[],0==a.length)return s&&s(),void 0;for(var r=0;r<a.length;r++){var n=e(a[r].ownerNode),l=getIframeOfElement(n).get(0);t++,this.attachTo(l,null,function(){t--,0==t&&s&&s()},n)}},this.cleanDomSs=function(){var s=this.dom_ss;this.dom_ss=[];for(var t=0;t<s.length;t++)if(s[t].ownerNode){var a=e(s[t].ownerNode),r=getIframeOfElement(a);r&&this.dom_ss.push(s[t])}},this.getAttachedToPages=function(){for(var s=[],t=!1,a=0;a<this.dom_ss.length;a++)if(this.dom_ss[a].ownerNode){var r=getIframeOfElement(e(this.dom_ss[a].ownerNode));r?s.push(r):t=!0}else t=!0;return t&&this.cleanDomSs(),s},this.duplicate=function(e){var s=new CrsaStylesheet;s.name=this.name.replace(/\.(css|less)($|[\?\/])/i,".copy.$1");var t=this.url.split("/");return t.length>0?t.splice(t.length-1,1):t=[""],s.url=t.join("/")+"/"+s.name,s.changed=!0,s.less_source=this.getLessSource(),s.less_variables=this.less_variables,s.less_variables_string=this.less_variables_string,s.loaded=this.loaded,s.ignore=this.ignore,s.has_less_file=this.has_less_file,s.genRegenerateCssFromSource(function(){e&&e(s)}),s},this.findAttachmentFor=function(e){for(var s=a(e),t=0;t<this.dom_ss.length;t++){var r=this.dom_ss[t];if(r&&r.ownerNode&&r.ownerNode.ownerDocument==s)return r}return null},this.isEnabledForPage=function(e){var s=this.findAttachmentFor(e);return s?0==s.disabled:!1},this.setEnabledForPage=function(e,s){var t=this.findAttachmentFor(e);t&&(t.disabled=!s)},this.getBreakpoints=function(){var e=function(){var e=new RegExp("([0-9]+)px","g"),t=[];if(s.crsa_rules)for(var a=0;a<s.crsa_rules.length;a++)if(s.crsa_rules[a].media){var r=s.crsa_rules[a].media.match(e);if(r)for(var n=0;n<r.length;n++){var l=parseInt(r[n]);s.crsa_rules[a].media.match(new RegExp("max\\-width\\:\\s*"+l+"px"))&&(l+=1),t.indexOf(l)<0&&t.push(l)}}return t};return e()},this.changeBreakpoint=function(e,t,a){var r=function(){var r=new RegExp(":\\s*"+e+"px","g"),n=new RegExp(":\\s*"+(e-1)+"px","g"),l=!1;if(s.crsa_rules){for(var o=0;o<s.crsa_rules.length;o++)if(s.crsa_rules[o].media){var i=s.crsa_rules[o].media.replace(r,": "+t+"px");i=i.replace(n,": "+(t-1)+"px"),i!=s.crsa_rules[o].media&&(s.crsa_rules[o].media=i,l=!0)}l?(s.less_source=null,s.changed=!0,s.genSetSource(s.genGetSource(),function(){a&&a(!0)})):a&&a(!1)}else a&&a(!1)};return r()},this.addRule=function(e,s){var t={selector:e,values:s,crsa_stylesheet:this};setRuleInfo(t),this.crsa_rules.push(t),this.less_source=null},this.addLessRule=function(e,s){s||(s={});var t={selector:e,values:s};return setRuleInfo(t),this.crsa_rules.push(t),this.less_source=null,this.changed=!0,t},this.removeLessRule=function(e){var s=this.crsa_rules.indexOf(e);s>=0&&this.crsa_rules.splice(s,1),this.less_source=null,this.changed=!0},this.renameLessRule=function(t,a,r){var n="class"==t.type?t.class:null;t.selector=a;var l=this.crsa_rules.indexOf(t);this.less_source=null,this.changed=!0,this.genRegenerateAndSetCssSource(function(){var t=s.crsa_rules.length>l?s.crsa_rules[l]:null,a="class"==t.type?t.class:null,o=0;e.each(s.dom_ss,function(s,t){if(t.ownerNode.ownerDocument){var r=t.ownerNode.ownerDocument.getElementsByTagName("body");if(r&&r.length>0){var l=e(r[0]);if(n&&a){var i=l.find("."+n).removeClass(n).addClass(a);o+=i.length}}}}),r&&r(t,o)})},this.setLessSource=function(e,s,t){"undefined"==typeof t&&(t=!1),this.less_source=e,this.regenerateAndSetCssSource(s,!0,t)},this.getLessSource=function(){return this.less_source||(this.less_source=this.getLessSourceForRules()),this.less_source},this.getLessSourceForRules=function(s){var t=[];s||(s=this.crsa_rules,t.push(i()),t.push("\n\n"));var a=null,r="";return e.each(s,function(s,n){var l=n.media?n.media:null;a!==l&&(a&&t.push("}\n\n"),l?(t.push("@media "+l+"\n{\n"),r="    "):r=""),a=l,n.edited_source?t.push(n.edited_source):n.raw?t.push(e.trim(n.raw)+"\n"):(t.push(r+n.selector+"\n"+r+"{\n"),e.each(n.values,function(e,s){t.push(r+"    "+e+": "+s.value+";\n")}),t.push(r+"}\n")),0==r.length&&t.push("\n")}),a&&t.push("}\n\n"),t.join("")},this.getLessSourceHtmlForRule=function(s){var t=[],a=s.media?s.media:null,r="";return a&&(t.push('<span class="cm-cp-media">@media '+a+"</span>\n{\n"),r="    "),s.raw?t.push('<span class="cm-cp-raw">'+s.raw+"</span>\n"):s.edited_source?t.push('<span class="cm-cp-raw">'+s.edited_source+"</span>\n"):(t.push(r+'<span class="cm-cp-sel">'+s.selector+"</span>\n"+r+"{\n"),e.each(s.values,function(e,s){t.push(r+'    <span class="cm-cp-prop">'+e+'</span>: <span class="cm-cp-val">'+s.value+"</span>;\n")}),t.push(r+"}\n")),0==r.length&&t.push("\n"),a&&t.push("}\n\n"),t.join("")};var t=function(e,s){var t=s.split(","),a=["rgb","rgba","hsl","hsla","ceil","floor","percentage","round","abs","min","max","argb","hsv","hsva","hue","saturation","lightness","red","green","blue","alpha","saturate","desaturate","lighten","darken","mix","grayscale","contrast"];if(a.indexOf(e)>=0)return e+"("+s+")";switch(e){case"color":return e+"("+s.replace(/[\'\"]/g,"")+")";case"unit":return t.length<=1?"unit("+s+")":"(unit("+t[0]+") + "+t[1]+")";case"escape":case"unescape":return("escape"==e?"quote":"unquote")+"("+s+")";case"hsvhue":case"hsvsaturation":case"hsvlightness":return e.replace("hsv","")+"("+s+")";case"fadein":return"fade-in("+s+")";case"fadeout":return"fade-out("+s+")";case"fade":return"rgba("+s+")";case"spin":return"adjust-hue("+s+")";default:return e+"("+s+")"}},r=function(e){for(var s=0,a=e.length,n="",l=e;s<e.length;){var o=e.search(/[a-z]+\(/i);if(0>o)return n+e;n+=e.substr(0,o),s=o;for(var i="",c="",u=0,d=!1;!d&&a>s;){var h=e.charAt(s);"("==h?(u>0&&(c+=h),u++):")"==h?(u--,0==u?d=!0:c+=h):0==u?i+=h:c+=h,s++}if(!d)return l;c=r(c),n+=t(i,c),s<e.length&&(e=e.substr(s),s=0)}return n},n=function(e){return e=e.replace(/@/g,"$"),e=r(e)},o=function(){for(var e=l.getVarsForCs(s,!0),t=[],a=0;a<e.length;a++){var r=e[a];t.push(r.name.replace("@","$")+": "+r.value+";\n")}return t.join("")};this.getSassSourceForRules=function(s){var t=[];s||(s=this.crsa_rules,t.push(o()),t.push("\n\n"));var a=null,r="";return e.each(s,function(s,l){var o=l.media?l.media:null;a!==o&&(a&&t.push("}\n\n"),o?(t.push("@media "+o+"\n{\n"),r="    "):r=""),a=o,l.raw?t.push(e.trim(l.raw)+"\n"):(t.push(r+l.selector+"\n"+r+"{\n"),e.each(l.values,function(e,s){t.push(r+"    "+e+": "+n(s.value)+";\n")}),t.push(r+"}\n")),0==r.length&&t.push("\n")}),a&&t.push("}\n\n"),t.join("")},this.getAllRules=function(){return this.crsa_rules};var i=function(){for(var e=l.getVarsForCs(s,!0),t=[],a=0;a<e.length;a++){var r=e[a];t.push(r.name+": "+r.value+";\n")}return t.join("")};this.regenerateCssFromLessSource=function(e,t,a){"undefined"==typeof t&&(t=!0),"undefined"==typeof a&&(a=!1);var r=function(){setTimeout(function(){e&&e()},1)};d.parse(this.getLessSource()+"\n"+(a?"":i()),function(e,a){if(e)return s.less_error=e,r(),void 0;s.less_error=null,t&&s.processLessTree(a);try{s.css_source=a.toCSS()}catch(e){return s.less_error=e,r(),void 0}r()})},this.getCssSource=function(e){null!=this.css_source?e(this.css_source):this.genRegenerateCssFromSource(function(){e(s.css_source)},!1)},this.regenerateAndSetCssSource=function(e,t,a){"undefined"==typeof t&&(t=!0),"undefined"==typeof a&&(a=!1),this.regenerateCssFromLessSource(function(){s.less_error||s.setAllCssText(s.css_source),e&&e()},t,a)},this.setAllCssText=function(e){this.css_source=e;for(var s=0;s<this.dom_ss.length;s++){var t=this.dom_ss[s];this.setAllCssTextForPage(null,t,e)}},this.setAllCssTextForPage=function(s,t,a){var t=t?t:this.findAttachmentFor(s);if(t){var r=t;if(this.inline){if(t.ownerNode){var n=e(t.ownerNode);n.html(a);var l=n.get(0).sheet,o=this.dom_ss.indexOf(t);o>=0?this.dom_ss[o]=l:this.dom_ss.push(l)}}else if(r.styleSheet)try{r.styleSheet.cssText=a}catch(i){throw new Error("Couldn't reassign styleSheet.cssText.")}else{for(;r.cssRules&&r.cssRules.length>0;)r.removeRule?r.removeRule(0):r.deleteRule&&r.deleteRule(0);var c="@media (min-width:0px) {"+a+"}";try{r.insertRule(c,0);for(var u=r.cssRules[0],d=[],h=0;h<u.cssRules.length;h++)d.push(u.cssRules[h].cssText);r.removeRule?r.removeRule(0):r.deleteRule&&r.deleteRule(0);for(var h=0;h<d.length;h++)r.insertRule(d[h],h)}catch(f){console.log(f)}}}},this.processLessTree=function(e){this.less_tree=e,this.crsa_rules=[],this.less_variables={},this.less_variables_string="",l.removeVarsForCs(this);for(var s=0;s<e.rules.length;s++){var t=e.rules[s];this.processTreeRule(t,this.crsa_rules)}},this.processTreeRule=function(s,t,a){"undefined"==typeof a&&(a=!1);var r=[],n={add:function(e){r.push(e)},isEmpty:function(){return 0===r.length}},o={compress:!1,tabLevel:0};try{if(s.hasOwnProperty("importedFilename"))s.crsaSource='@import "'+s.importedFilename+'";';else if(s.hasOwnProperty("variable")&&s.variable){if(a)return null;var i=e.trim(s.name);s.value.genCSS({compress:!1},n);var c=r.join("");return this.less_variables[i]=c,this.less_variables_string+=i+":"+c+";",l.add(i,c,this),null}if(s.hasOwnProperty("features")&&s.rules){r=[],s.features.genCSS(o,n);for(var u=e.trim(r.join("")),d=0;d<s.rules.length;d++){var h=s.rules[d];if(h.rules)for(var f=0;f<h.rules.length;f++){var g=h.rules[f],p=this.processTreeRule(g,t,a);p&&(p.media=u)}}return null}if(s.selectors&&s.rules){var v=[],m=[];s.joinSelectors(m,v,s.selectors),s.paths=m;for(var S=0;S<s.paths.length;S++){var y=s.paths[S];o.firstSelector=!0;for(var b=0;b<y.length;b++)y[b].genCSS(o,n),o.firstSelector=!1;var w=o.compress?"":Array(o.tabLevel).join("  ");S+1<s.paths.length&&n.add(o.compress?",":",\n"+w)}var C=e.trim(r.join(""));if(0==C.length)return null;for(var _={},S=0;S<s.rules.length;S++){r=[];var T=s.rules[S];if(T.name){var i=T.name,c=null;T.value&&(T.value.crsaSource?c=T.value.crsaSource:(T.value.genCSS(o,n),c=r.join(""))),""==T.important||c.match(/\!important/i)||(c+=" !important"),_[i]={value:c,less_rule_line:T,important:""!=T.important}}}p={values:_,selector:C,crsa_stylesheet:this}}else if(s.name&&s.rules){r=[],s.genCSS(o,n);var R=r.join("");console.log(R)}else s.crsaSource&&(p={raw:s.crsaSource,crsa_stylesheet:this,less_type:s.__proto__.type});return p?(t.push(p),setRuleInfo(p),p):null}catch(F){return s.crsaSource?(p={raw:s.crsaSource,crsa_stylesheet:this},setRuleInfo(p),t.push(p),p):(console.log(F),null)}};var c=function(e){return e.selectorText?(e.crsaNormalizedSelector||(e.crsaNormalizedSelector=normalizeSelector(e.selectorText)),e.crsaNormalizedSelector):null},u=function(e){return e.selector?(e.crsaNormalizedSelector||(e.crsaNormalizedSelector=normalizeSelector(e.selector)),e.crsaNormalizedSelector):null};this.getSelector=function(e){return u(e)},this.findCssRules=function(s,t){t=normalizeSelector(t);var a=[];if(s.cssRules){var r=s.cssRules;1==r.length&&r[0].media&&(r=r[0].cssRules||[]),e.each(r,function(e,s){c(s)==t&&a.push(s)})}return a},this.findLessRules=function(s){s=normalizeSelector(s);var t=[];return e.each(this.crsa_rules,function(e,a){a.selector&&u(a)==s&&t.push(a)}),t},this.regenerateLessRule=function(e,s){this.lessRuleValueChanged(e,null,null,s)};var h=function(e,s,t){null==t?s in e.values&&delete e.values[s]:(s in e.values||(e.values[s]={}),e.values[s].value=t)};this.lessRuleValueChanged=function(e,t,a,r,n){t&&("media"==t?e.media=a:h(e,t,a)),this.css_source=null,this.less_source=null,this.changed=!0;var l=function(){r&&setTimeout(r,1)};if(n)return l(),void 0;var o=this.getLessSourceForRules([e]);d.parse(o+"\n"+i(),function(t,a){if(t)return s.less_error=t,l(),void 0;s.less_error=null;for(var r=[],n=0;n<a.rules.length;n++){var o=a.rules[n];s.processTreeRule(o,r,!0)}var i;try{i=a.toCSS()}catch(t){return s.less_error=t,l(),void 0}s.updateCssRulesInStylesheets(e,r,i,l)})},this.cssRuleValueChanged=function(e,t,a,r,n){t&&("media"==t?e.media=a:h(e,t,a)),this.css_source=null,this.changed=!0;var l=function(){r&&setTimeout(r,1)};if(n)return l(),void 0;var o=this.genGetSourceForRules([e]);s.updateCssRulesInStylesheets(e,[e],o,l)},this.updateCssRulesInStylesheets=function(e,t,a,r){var n=!1;if(1!=t.length)n=!0;else if(s.inline)n=!0;else if(t[0].selector)if(t[0].media)n=!0;else if(normalizeSelector(t[0].selector)!=normalizeSelector(e.selector))n=!0;else{var l=a.match(/\{([\s\S]*)\}/);if(l){var o=s.genFindRules(e.selector);o.length>1&&(n=!0)}else n=!0}else n=!0;if(!n)for(var i=0;i<s.dom_ss.length;i++){var c=s.dom_ss[i],u=s.findCssRules(c,e.selector);if(1!=u.length){n=!0;break}u[0].style.cssText=l[1].replace("\n",""),console.log("single rule changed")}n?(console.log("changing whole css"),s.genRegenerateAndSetCssSource(function(){r()},!1)):r()}},window.CrsaPageStyles=function(s){this.$iframe=e(s),this.stylesheets=[],this.default_ignore=[/fonts\.googl/i];var t=null,a=this,r=function(){var s=getCrsaPageForIframe(a.$iframe),t=a.default_ignore;return e.each(s.frameworks,function(e,s){t=t.concat(s.ignore_css_files)}),t};this.attachTo=function(e,s,t){this.stylesheets.push(e),e.attachTo(this.$iframe.get(0),s,t)},this.detachFrom=function(e){e.detachFrom(this.$iframe.get(0));var s=this.stylesheets.indexOf(e);s>=0&&this.stylesheets.splice(s,1)},this.removeAllInlineSheets=function(){for(var e=0;e<this.stylesheets.length;e++){var s=this.stylesheets[e];if(s.inline){this.stylesheets.splice(e,1),e--;var t=n.indexOf(s);t>=0&&n.splice(t,1)}}},this.removeAllExclusiveSheets=function(){for(var e=0;e<this.stylesheets.length;e++){var s=this.stylesheets[e];if(s.cleanDomSs(),1==s.dom_ss.length){this.stylesheets.splice(e,1),e--;var t=n.indexOf(s);t>=0&&n.splice(t,1)}}},this.loadAllStylesheets=function(e){for(var s=0,t=this.$iframe.get(0).contentDocument||this.$iframe.get(0).contentWindow.document,a=0;a<t.styleSheets.length;a++){var l=t.styleSheets[a],o=!1;if(!l.ownerNode||"crsa-inline-styles"!=l.ownerNode.id){for(var i=r(),c=0;c<i.length;c++)if(l.href&&l.href.match(i[c])){o=!0;break}if(l.href){if(0===l.href.indexOf("data:"))continue;var u=findCrsaStylesheetForUrl(l.href),d=u.length>0?u[0]:null;d?(console.log("PS: ss found, reusing "+d.name),this.attachTo(d,l)):(console.log("PS: loading "+l.href),s++,d=new CrsaStylesheet,this.attachTo(d,l),n.push(d),d.ignore=o,d.load(l.href,function(t){s--,console.log("done "+t.url+" "+s),0==s&&e&&(e(),s--)}))}else console.log("loading inline css"),s++,d=new CrsaStylesheet,this.attachTo(d,l),n.push(d),d.loadInline(l,function(){s--,0==s&&e&&(e(),s--)})}}0==s&&e&&e()},this.getAllActiveRules=function(e){var s=this.$iframe.get(0);t=[];for(var a=0;a<this.stylesheets.length;a++){var r=this.stylesheets[a];e&&e.indexOf(r)>=0||r.isEnabledForPage(s)&&(t=t.concat(r.getAllRules()))}return t},this.getAllCrsaStylesheets=function(){return this.stylesheets},this.reorder=function(e,t){if(e.length>0)for(var a=0,r=0;r<e.length;r++){var n=e[r];n.inline||(n.detachFrom(s),a++,n.attachTo(s,null,function(){a--,0==a&&(this.stylesheets=e,t&&t())}))}else t&&t()},this.reorderRules=function(s,t,a){var r=0;e.each(s,function(s,n){var l=[];e.each(t,function(e,s){s.crsa_stylesheet==n&&l.push(s)}),n.crsa_rules=l,n.less_source=null,n.changed=!0,r++,n.genRegenerateAndSetCssSource(function(){r--,0==r&&a&&a()})}),(!s||0==s.length&&a)&&a()}};var n=[],l=new CrsaVariables;window.findCrsaStylesheetForUrl=function(e,s){var t=function(e){if(!e)return e;var s=e.split(".");return s.length>1&&s.pop(),s.join(".")};s&&(e=t(e));for(var a=[],r=0;r<n.length;r++)if(n[r].url){var l=s?t(n[r].url):n[r].url;l==e&&a.push(n[r])}return a},window.getCrsaPageStylesForPage=function(e){return e.data("crsa-page-styles")},e.fn.crsacss=function(s){return m[s]?m[s].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof s&&s?(e.error("Method "+s+" does not exist on jQuery.crsacss"),void 0):m.init.apply(this,arguments)};var o,i=e("body"),c=null,u=[],d=new less.Parser,h={},f="",g=null,p=[],v=null,m={init:function(s){return o=e.extend({},e.fn.crsacss.defaults,s),e("body").on("crsa-page-added",function(){p=e("iframe.content-iframe")}),e("div.canvas").on("crsa-page-closed",function(){p=e("iframe.content-iframe")}),this.each(function(){})},addStylesheetFromUrl:function(e,s){var t=findCrsaStylesheetForUrl(e);return t.length>0?(s&&s(t[0]),void 0):(t=new CrsaStylesheet,t.load(e,function(){n.push(t),s&&s(t)}),void 0)},getAllCrsaStylesheets:function(){return n},overrideDocumentStylesheet:function(e){S(e,function(){v?m.setAllCssText(v):C()})},loadLessStyles:function(s,t){var a=e(s),r=getCrsaPageStylesForPage(a);r&&r.removeAllInlineSheets();var n=new CrsaPageStyles(s);a.data("crsa-page-styles",n),n.loadAllStylesheets(function(){console.log("all stylesheets loaded"),t&&t()})},setLessSource:function(e,s){g=e,C(s)},processLessTree:function(e){c=e,u=[],h={},f="";for(var s=0;s<e.rules.length;s++){var t=e.rules[s];m.processTreeRule(t,u)}},processTreeRule:function(s,t,a){"undefined"==typeof a&&(a=!1);var r=[],n={add:function(e){r.push(e)},isEmpty:function(){return 0===r.length}},l={compress:!1,tabLevel:0};try{if(s.hasOwnProperty("variable")&&s.variable&&!a){var o=e.trim(s.name);s.value.genCSS({compress:!1},n);var i=r.join("");return h[o]=i,f+=o+":"+i+";",null}if(s.hasOwnProperty("features")&&s.rules){r=[],s.features.genCSS(l,n);for(var c=e.trim(r.join("")),u=0;u<s.rules.length;u++){var d=s.rules[u];if(d.rules)for(var g=0;g<d.rules.length;g++){var p=d.rules[g],v=m.processTreeRule(p);v&&(v.media=c)}}return null}if(!s.rules)return null;if(s.selectors){var S=[],y=[];s.joinSelectors(y,S,s.selectors),s.paths=y;for(var b=0;b<s.paths.length;b++){var w=s.paths[b];l.firstSelector=!0;for(var C=0;C<w.length;C++)w[C].genCSS(l,n),l.firstSelector=!1;var _=l.compress?"":Array(l.tabLevel).join("  ");b+1<s.paths.length&&n.add(l.compress?",":",\n"+_)}var T=e.trim(r.join(""));if(0==T.length)return null;for(var R={},b=0;b<s.rules.length;b++){r=[];var F=s.rules[b];if(F.name){var o=F.name,i=null;F.value&&(F.value.genCSS(l,n),i=r.join("")),R[o]=i}}v={values:R,selector:T}}else if(s.name&&s.rules){r=[],s.genCSS(l,n);var k=r.join("");console.log(k)}return v?(t.push(v),setRuleInfo(v),v):null}catch(A){return s.crsaSource?(v={raw:s.crsaSource},setRuleInfo(v),t.push(v),v):(console.log(A),null)}},getLessVariables:function(){return h},getLessRuleValues:function(e){return e.values},getAllLessRules:function(){return u},lessVariableChanged:function(e,s){var t=e+":"+s+";";if(f.indexOf(e+":")<0)f+=t;else{var a=new RegExp(escapeRegExp(e)+"s*:s*[^;]*;","ig");f=f.replace(a,t)}h[e]=s,v=null,C()},lessRuleValueChanged:function(e,s,t,a,r){var n=e.crsa_stylesheet;return n.lessRuleValueChanged(e,s,t,a,r),void 0},getLessSource:function(){return g||(g=m.getLessSourceForRules()),g},getLessSourceForRules:function(s){var t=[];s||(s=u,e.each(h,function(e,s){t.push(e+": "+s+";\n")}),t.push("\n"));var a=null,r="";return e.each(s,function(s,n){var l=n.media?n.media:null;a!==l&&(a&&t.push("}\n\n"),l?(t.push("@media "+l+"\n{\n"),r="    "):r=""),a=l,n.raw?t.push(n.raw):n.edited_source?t.push(n.edited_source):(t.push(r+n.selector+"\n"+r+"{\n"),e.each(n.values,function(e,s){t.push(r+"    "+e+": "+s+";\n")}),t.push(r+"}\n")),0==r.length&&t.push("\n")}),a&&t.push("}\n\n"),t.join("")},lessTreeToCss:function(){var e=c.toCSS();m.setAllCssText(e)},findLessRules:function(s){var t=[];return e.each(u,function(e,a){a.selector==s&&t.push(a)}),t},addLessRule:function(e,s,t){s||(s={});var a={selector:e,values:s};return setRuleInfo(a),g=m.genGetSource()+"\n"+m.genGetSourceForRules([a]),C(function(){t&&t(u[u.length-1])}),a},removeLessRule:function(e,s){var t=u.indexOf(e);t>=0&&u.splice(t,1),g=null,C(s)},renameLessRule:function(e,s,t){e.crsa_stylesheet.renameLessRule(e,s,t)},reorderLessRules:function(e){u=e,g=null,C()},addRule:function(s){var t=e();return p.each(function(a,r){var n=e(r),l=n.data("crsa-css-ss");l.insertRule(s,l.cssRules?l.cssRules.length:0),t=t.add(l.cssRules[l.cssRules.length-1])}),t},css:function(s,t,a){return s.each(function(s,r){e(r).css(t,a)
}),this},find:function(s){var t=[];p.each(function(a,r){var n=e(r),l=n.data("crsa-css-ss"),o=b(e(l.cssRules),s);e.each(o,function(e,s){t.push(s)})});var a=e(t);return a},findAll:function(s){"undefined"==typeof s&&(s=!1);var t=[];return e.each(u,function(e,a){s&&"class"!==a.type||t.push(a)}),t},setRuleText:function(s,t){var a="string"==typeof s?m.find.call(this,s):s;return 0==a.length&&(a=m.addRule(s+" {}")),e.each(a,function(e,s){s.style.cssText=t}),this},replaceRule:function(e,s){var t=e.parentStyleSheet,a=t.cssRules.indexOf(e);0>a&&(a=t.cssRules.length),t.insertRule(s,a)},replaceAllRules:function(s){p.each(function(t,a){var r=e(a),n=r.data("crsa-css-ss"),l=[];e.each(n.cssRules,function(e,s){l.push(s)}),e.each(l,function(){n.removeRule?n.removeRule(0):n.deleteRule&&n.deleteRule(0)}),e.each(s,function(e,s){n.insertRule(s.cssText,e)})})},setAllCssText:function(s){v=s,p.each(function(t,r){{var n=e(r),l=n.data("crsa-css-ss"),o=l;a(r)}if(o.styleSheet)try{o.styleSheet.cssText=s}catch(r){throw new Error("Couldn't reassign styleSheet.cssText.")}else{for(;o.cssRules&&o.cssRules.length>0;)o.removeRule?o.removeRule(0):o.deleteRule&&o.deleteRule(0);var i="@media (min-width:0px) {"+s+"}";try{o.insertRule(i,0)}catch(c){console.log(c)}}})},renameRule:function(e,s){e.each(function(e,t){t.selectorText=s})},getCss:function(e,s){if(0==e.length)return null;var t=e[0],a=t.style;return a[s]?a[s]:null},getAllStyles:function(e){if("string"==typeof e&&(e=this.crsacss("find",e)),0==e.length)return null;var s=e[0];return s.style},getCssAsText:function(){var s="";return p.each(function(t,a){var r=e(a),n=r.data("crsa-css-ss");e.each(n.cssRules,function(e,t){s=s+t.cssText+"\n\n"})}),s},getClassesForElement:function(e){for(var s=e.get(0).className.split(/\s+/),t=[],a=0;a<s.length;a++)0!=s[a].indexOf("crsa-")&&t.push("."+s[a]);return t},getRulesForElement:function(s,t,a){var r=[],l=[],o=s.get(0);if(o.ownerDocument.defaultView&&o.ownerDocument.defaultView.getMatchedCSSRules){var i=o.ownerDocument.defaultView.getMatchedCSSRules(o,""),c={};if(i){for(var u=i.length;u--;)c[normalizeSelector(i[u].selectorText)]=!0;for(var u=0;u<n.length;u++){var d=n[u];d.ignore||e.each(d.getAllRules(),function(e,s){var t;s.selector&&(t=d.getSelector(s))in c&&(r.push(s),l.indexOf(t)<0&&l.push(t))})}}if(t)for(var h=m.getClassesForElement(s),u=0;u<h.length;u++){var f=normalizeSelector(h[u]);l.indexOf(f)<0&&l.push(f)}return a?l:r}for(var u=0;u<n.length;u++){var d=n[u];if(e.each(d.getAllRules(),function(e,t){try{if(t.selector&&s.is(t.selector)){var a=normalizeSelector(t.selector);r.push(t),l.indexOf(a)<0&&l.push(a)}}catch(n){}}),t)for(var h=m.getClassesForElement(s),u=0;u<h.length;u++){var f=normalizeSelector("."+h[u]),g=!1;for(j=0;j<r.length;j++){var p=r[j];if("object"==typeof p&&p.selector&&f==normalizeSelector(p.selector)){g=!0;break}}g||l.push(f)}}return a?l:r},showVariables:function(){var s=function(s,t){var a=getUniqueId();if(s.data("popover-active"))return s.popover("destroy"),s.data("popover-active",null),void 0;{var r=function(e){setTimeout(function(){e.closest(".popover").remove()},750)};s.popover({html:!0,placement:"right",trigger:"manual",title:"Add new variable",container:"body",content:'<form id="'+a+'"><form><input class="form-control" placeholder="var_name" style="margin-bottom:8px;"/><button class="ok btn">Create</button><button class="closeit btn btn-link">Cancel</button></form>'}).on("shown.bs.popover",function(){var n=e("#"+a),o=n.find("input").focus(),i=n.find("button.ok"),c=n.find("button.closeit"),u=function(){var a=e.trim(o.val());if(a.length>0){"@"!=a.substr(0,1)&&(a="@"+a);var i=l.findByName(a,t);if(i)return showAlert("Variable "+a+" is already defined.","Can't add variable"),void 0;getCrsaPageForIframe(e.fn.crsa("getSelectedPage")).undoStack.add("Add variable "+a);var c=t.genGetType();l.add(a,"",t),t.genForgetCachedSource(),t.genRegenerateAndSetCssSource(function(){e("body").trigger("crsa-stylesheets-changed");var s=t.genGetType();c!=s&&"css"!=s&&showAlert("To work with variables "+t.name+" is now using <b>"+s.toUpperCase()+"</b> parser. .less file will be saved alongside .css version. Use <b>"+a+"</b> in CSS rules instead of hard-coded values.","Notice")})}s.popover("hide"),r(n)};i.on("click",function(e){e.preventDefault(),u()}),n.on("submit",function(e){e.preventDefault(),u()}),c.on("click",function(e){s.popover("hide"),e.preventDefault(),r(n)})}).on("hidden.bs.popover",function(){setTimeout(function(){s.popover("destroy").data("popover-active",null)},10)})}s.popover("show").data("popover-active",!0)},t=e("#crsa-vars"),a=function(){t.find(".crsa-input-color-picker").spectrum("destroy"),t.html(""),e("<h2/>").html("Variables").appendTo(t),e.each(n,function(r,n){if(n.inline||n.ignore)return!0;var o=e("<h3/>",{"class":"crsa-cm-cs"}).html(n.name).appendTo(t),i=e("<a/>",{"class":"cm-varlist-add",href:"#"}).html("+ Add var").appendTo(o);i.on("click",function(e){e.preventDefault(),s(i,n)});var c=e("<div/>").appendTo(t),u=l.getVarsForCs(n,!1);e.each(u,function(s,t){var r={type:"color",name:t.name,file_picker:!0,file_picker_quotes:!0},o={};o[t.name]=t.value;var i=e.fn.crsa("addInputField",c,{type:"stylesheet",data:n},t.name,r,o,!0).data("crsa-var",t),u=(e("<a/>",{href:"#"}).html('<i class="fa fa-trash-o" />').on("click",function(s){var t=u.closest(".crsa-field"),r=t.data("crsa-var");r.isInUse()?showAlert("Variable "+r.name+" is used in one or more open stylesheets.","Can't remove it"):(getCrsaPageForIframe(e.fn.crsa("getSelectedPage")).undoStack.add("Remove variable "+r.name),l.remove(r,function(){a()})),s.preventDefault()}).appendTo(i),i.find("input.crsa-input")),d=null;u&&u.on("change input",function(s){var t=u.closest(".crsa-field"),a=t.data("crsa-var");d&&d==a||(getCrsaPageForIframe(e.fn.crsa("getSelectedPage")).undoStack.add("Change "+a.name),console.log("undo recorded"),d=a);var r=u.val();if(a.valueChanged(r),"change"==s.type)for(var n=a.cs.getAttachedToPages(),l=0;l<n.length;l++){var o=getCrsaPageForIframe(n[l]);o.autoSize()}})})})};a(),e("body").on("crsa-rules-changed crsa-stylesheets-changed",function(){a()})},showStylesheetsManager:function(){if(!(e(".crsa-sm").length>0)){{var s,t,a=e("<ul/>",{"class":"crsa-man crsa-sm"}),r=function(){showAlert("The stylesheet is not loaded. Load it (press on X in front of the stylesheet name in CSS panel) before renaming.","Notice")},l=function(s,t){s.append('<form class="form-inline" role="form">                <div class="form-group" style="width:65%;">                <label class="sr-only">Url</label>                <div class="input-group" style="width:98%;">                <input type="url" class="form-control url" placeholder="Url of .css or .less file">                <span class="input-group-addon"><i class="fa fa-folder-open"></i></span>                </div>                <p class="help-block"></p>                </div>                <button type="submit" class="btn btn-default add">Add</button>                <button class="btn btn-link cancel">Cancel</button>                </form>'),s.find(">a,>button").hide();var a=s.find("form"),l=a.find("input.url"),i=a.find("span.input-group-addon"),c=l.closest(".form-group"),u=c.find(".help-block").hide(),d=s.data("crsa-cs");d?(l.val(d.url),a.find("button.add").html("Rename")):a.find("button.cancel").hide(),isApp()?i.on("click",function(e){e.preventDefault(),crsaChooseFile(function(e){l.val(e)},(null!=d?crsaGetNameFromUrl(d.url):null)||(t?"style.css":!1))}):i.remove(),a.find("button.add").on("click",function(s){s.preventDefault();var t=e.trim(l.val());if(0==t.length)return c.addClass("has-error"),u.html("Enter the url of existing or new stylesheet.").show(),void 0;if(d){var a=findCrsaStylesheetForUrl(t,!0);a.length>0&&a[0]!=d?(c.addClass("has-error"),u.html("File with this url is already loaded.").show()):d.loaded?(d.setUrl(t),d.changed=!0,d.reattachToAll(function(){e("body").trigger("crsa-stylesheets-changed"),o()}),isApp()&&showAlert("Save the stylesheet or the page to which this stylesheet is attached to actually save it under this new name.","Notice")):r()}else{if(!crsaIsAbsoluteUrl(t)){var i=e.fn.crsa("getSelectedPage"),h=getCrsaPageForIframe(i);h&&(t=crsaCombineUrlWith(h.url,t),l.val(t))}if(findCrsaStylesheetForUrl(t,!0).length>0)c.addClass("has-error"),u.html("File with this url is already loaded.").show();else{c.removeClass("has-error"),u.hide();var f=new CrsaStylesheet;f.changed=!0,f.loaded=!0,f.load(t,function(){n.push(f),o(),showAlert("Attach the new stylesheet to the page if you want to use it on that page. Btw, one stylesheet can be attached to multiple pages.","A Tip")})}}}),a.find("button.cancel").on("click",function(e){var t=s.data("crsa-cs");t&&(a.remove(),s.find(">a,>button").show(),e.preventDefault())})},o=function(){a.html("");for(var c=n,u=e.fn.crsa("getSelectedPage"),d=0;d<c.length;d++){var h=c[d];if(!h.inline){var f=e("<li/>").appendTo(a).data("crsa-cs",h),g=(e("<span/>",{}).html(h.name+(h.changed?" *":"")).appendTo(f),e("<a/>",{href:"#"}).html("Duplicate").appendTo(f)),p=e("<a/>",{href:"#"}).html("Rename").appendTo(f),v=e("<a/>",{href:"#"}).html("Close").appendTo(f),m=null;h.changed&&isApp()&&h.loaded&&(m=e("<a/>",{href:"#"}).html("<b>Save</b>").appendTo(f)),e("<div/>",{}).html(h.url).appendTo(f);var S;if(u){var y=getCrsaPageForIframe(u);h.isEnabledForPage(u.get(0))?(f.addClass("crsa-active"),S=e("<a/>",{"class":"crsa-sm-attach",href:"#"}).html('<i class="fa fa-times"></i> Detach from '+y.name).appendTo(f)):S=e("<a/>",{"class":"crsa-sm-attach",href:"#"}).html('<i class="fa fa-reply"></i> Attach to '+y.name).appendTo(f),S.on("click",function(s){var t=e.fn.crsa("getSelectedPage");if(t){var a=t.get(0),r=e(s.delegateTarget).closest("li"),n=r.data("crsa-cs"),l=getCrsaPageStylesForPage(t),i=getCrsaPageForIframe(t);n.findAttachmentFor(a)?(i.undoStack.add("Detach "+n.name),l.detachFrom(n),r.removeClass("crsa-active"),e("body").trigger("crsa-stylesheets-changed"),i.autoSize(),o()):(i.undoStack.add("Attach "+n.name),r.addClass("crsa-active"),l.attachTo(n,null,function(){e("body").trigger("crsa-stylesheets-changed"),i.autoSize(),o()}))}s.preventDefault()})}g.on("click",function(s){var t=e(s.delegateTarget).closest("li"),a=t.data("crsa-cs");a.loaded?a.duplicate(function(e){n.push(e),o()}):r(),s.preventDefault()}),p.on("click",function(s){var t=e(s.delegateTarget).closest("li"),a=t.data("crsa-cs");a.loaded?l(t):r(),s.preventDefault()}),v.on("click",function(s){var t=e(s.delegateTarget).closest("li"),a=t.data("crsa-cs");if(a.cleanDomSs(),a.dom_ss.length>0)showAlert("This stylesheet is attached to at least one open document. Close the document or detach the stylesheet before closing it.","Can't close this stylesheet");else{var r=n.indexOf(a);n.splice(r,1),e("body").trigger("crsa-stylesheets-changed"),o()}s.preventDefault()}),m&&m.on("click",function(s){var t=e(s.delegateTarget).closest("li"),a=t.data("crsa-cs"),r=require("fs");crsaIsFileUrl(a.url)?a.save(crsaMakeFileFromUrl(a.url),function(e){e?showAlert(e,"Can't save this stylesheet"):crsaQuickMessage(crsaGetNameFromUrl(a.url)+" saved!"),o()},r):showAlert("This is a remote stylesheet. Rename it first, then save it.","Can't save this stylesheet"),s.preventDefault()})}}var f=e("<li/>").appendTo(a),b='<ul class="nav nav-tabs">                <li class="active"><a href="#ss-add-new" data-toggle="tab">New...</a></li>                <li><a href="#ss-add-open" data-toggle="tab">Open file...</a></li>                <li><a href="#ss-add-url" data-toggle="tab">Open url...</a></li>            </ul>                <div class="tab-content">                    <div class="tab-pane active" id="ss-add-new"><p class="text-muted">Create a new stylesheet (if you select an existing stylesheet it will be loaded instead).</p></div>                    <div class="tab-pane" id="ss-add-open"><p class="text-muted">Open an existing stylesheet.</p></div>                    <div class="tab-pane" id="ss-add-url"><p class="text-muted">Enter an absolute or relative url of the stylesheet that you want to create or load.</p></div>                </div>';s&&s.remove(),t&&t.remove(),t=e("<h4>Add stylesheet:</h4>").appendTo(i),s=e(b).appendTo(i),l(s.find("#ss-add-new"),!0),l(s.find("#ss-add-open")),l(s.find("#ss-add-url"))},i=e('<div class="manager"/>').append(a);makeModalDialog("Stylesheets Manager","Close",null,i)}o(),e("body").on("crsa-page-selected",function(){o()})}},showFrameworkManager:function(s){var t;t=s?"Select which framework components you want to use with this page in <b>Lib</b> and <b>Prop</b> panels. NOTE: This will not add framework stylesheets and scripts to the page.":"The list of frameworks, libraries and plugins. Select Framework Manager for a specific page to manage which plugins are active for that page.";var a=e('<div><p class="text-muted">'+t+"</p></div>"),r=e("<ul/>",{"class":"crsa-man crsa-fm"}).appendTo(a),n=function(s){s.append('<form class="form-inline" role="form">                <h4>Load your own plugins</h4>                <p><b>PLEASE LOAD ONLY PINEGROW PLUGINS!</b> Loading anything else <b>WILL</b> break the app.</p>                <div class="form-group" style="width:65%;">                <label class="sr-only" for="exampleInputEmail2">Url</label>                <div class="input-group" style="width:98%;">                <input type="url" class="form-control url" id="exampleInputEmail2" placeholder=".js file">                <span class="input-group-addon"><i class="fa fa-folder-open"></i></span>                </div>                <p class="help-block"></p>                </div>                <button type="submit" class="btn btn-default add">Add</button>                <button class="btn btn-link cancel">Cancel</button>                </form>'),s.find(">a,>button").hide();var t=s.find("form"),a=t.find("input.url"),r=t.find("span.input-group-addon"),n=a.closest(".form-group"),o=n.find(".help-block").hide();t.find("button.cancel").hide(),isApp()?r.on("click",function(e){e.preventDefault(),crsaChooseFile(function(e){a.val(e)})}):r.remove(),t.find("button.add").on("click",function(s){s.preventDefault();var t=e.trim(a.val());if(0==t.length)return n.addClass("has-error"),o.html("Select the file first.").show(),void 0;var r=t;pinegrow.findFrameworkWithFile(r)?(n.addClass("has-error"),o.html("This file is already loaded.").show()):(n.removeClass("has-error"),o.hide(),confirm("Are you sure? Only Pinegrow PLUGINS and COMPONENTS can be loaded. Anything else (framework JavaScript files, etc...) WILL break the app.")&&pinegrow.loadFrameworkFromFile(r,!0,function(e){e&&showAlert("Unable to load "+r+". "+e,"Unable to load plugin."),l()}))})},l=function(){r.html("");var t=pinegrow.getFrameworks();e.each(t,function(t,a){var n=e("<li/>").appendTo(r).data("crsa-fm",a),o=e("<span/>",{}).html(a.name).appendTo(n);e('<i class="fa fa-check"></i>').appendTo(o);var i;s&&(s.frameworks.indexOf(a)<0?i=e("<a/>",{"class":"crsa-sm-attach",href:"#"}).html('<i class="fa fa-plus"></i> Activate').appendTo(n):(n.addClass("crsa-active"),i=e("<a/>",{"class":"crsa-sm-attach",href:"#"}).html('<i class="fa fa-minus"></i> Deactivate').appendTo(n)),i.on("click",function(t){var a=e(t.delegateTarget).closest("li"),r=a.data("crsa-fm"),n=s.frameworks.indexOf(r);n>=0?(s.removeFramework(r),a.removeClass("crsa-active"),l(),s.setPageChanged(!0)):(s.addFramework(r)?a.addClass("crsa-active"):showAlert("Only one "+r.type+" framework can be added to a page at the same time. Remove the other one first.","Could not add framework"),l(),s.setPageChanged(!0)),t.preventDefault()})),a.changed&&e("<a/>",{"class":"crsa-sm-attach",href:"#"}).html('<i class="fa fa-save"></i> <b>Save</b>').appendTo(n).on("click",function(s){s.preventDefault();var t=e(s.delegateTarget).closest("li"),a=t.data("crsa-fm");a.localFile?a.save(a.localFile,function(){crsaQuickMessage("Library saved."),l(),pinegrow.frameworksChanged()}):crsaChooseFile(function(e,s){a.save(s,function(){crsaQuickMessage("Library saved."),l(),pinegrow.frameworksChanged()})},a.getFileName())}),a.localFile&&(e("<a/>",{"class":"crsa-sm-attach",href:"#"}).html('<i class="fa fa-times"></i> Unload').appendTo(n).on("click",function(s){s.preventDefault();var t=e(s.delegateTarget).closest("li"),a=t.data("crsa-fm");a.changed?showAlert("Plugin has unsaved changes. Sure you want to close it?","Unsaved changes","Cancel","Close it",null,function(){pinegrow.unloadFramework(a),l()}):(pinegrow.unloadFramework(a),l())}),e("<div/>",{}).html(a.localFile).appendTo(n))});var a=e("<li/>").appendTo(r);n(a)};l(),a.append('<p><a href="https://github.com/matjaztrontelj/PinegrowCommunity/wiki" target="_blank" class="link">Learn how to create Pinegrow plugins.</a></p>');var o=makeModalDialog(s?"Framework &amp; Plugin Manager for "+s.name:"Framework &amp; Plugin Manager","Close",null,a);isApp()&&o.find("a.link").on("click",function(s){var t=e(s.delegateTarget).attr("href");if(t){s.preventDefault();var a=require("nw.gui"),t=e(s.delegateTarget).attr("href");a.Shell.openExternal(t)}}),e("body").on("crsa-framework-loaded",function(){l()})}},S=function(s,t){var a=s.length;s.each(function(s,r){var n=r.contentDocument||r.contentWindow.document,l=n.getElementsByTagName("head")[0],i=e(r),c=w(n,o.title);if(c)i.data("crsa-css-ss",c),a--,0>=a&&t&&t();else{var u=e("<style/>",{title:o.title}).appendTo(e(l));c=u.get(0).sheet,i.data("crsa-css-ss",c),a--,0>=a&&t&&t()}})},y=function(s,t,a,r){var n=s.contentDocument||s.contentWindow.document,l=n.getElementsByTagName("head")[0],o=n.createElement("link");o.setAttribute("href",t),o.setAttribute("rel","stylesheet"),o.setAttribute("type","text/css");var i,c;"sheet"in o?(i="sheet",c="cssRules"):(i="styleSheet",c="rules");var u=setInterval(function(){try{o[i]&&(clearInterval(u),clearTimeout(d),a(o[i]))}catch(e){}finally{}},10),d=setTimeout(function(){clearInterval(u),clearTimeout(d),l.removeChild(o),a(null)},15e3);return r?r.replaceWith(e(o)):l.appendChild(o),o},b=function(s,t){var a;t||(t=/./),t.split?(a=e.trim(t).toLowerCase().split(/\s*,\s*/),t=function(){return this.selectorText?!!e.grep(this.selectorText.toLowerCase().split(/\s*,\s*/),function(s){return-1!=e.inArray(s,a)}).length:!1}):t.exec&&(a=t,t=function(){return a.test(this.selectorText)});var r=e([]).pushStack(e.grep(s,function(e,s){return t.call(e,s)}));return r},w=function(e){for(var s=null,t=0;t<e.styleSheets.length;t++){var a=e.styleSheets[t];a.href&&a.href.length>0&&a.href.indexOf("edit.inline.css")<0&&(s=a)}return s},C=function(e,s){"undefined"==typeof s&&(s=null),d.parse(m.getLessSource()+"\n"+f,function(t,a){if(t)return console.error(t);m.processLessTree(a);var r=a.toCSS();m.setAllCssText(r),e&&e(s)})};e.fn.crsacss.defaults={title:"crsa"};var _=function(a){var r=!1,n=null,l=e("<div/>",{"class":"crsa-cm-main clearfix"}).appendTo(a),o=e("<div/>",{"class":"crsa-cm-rules"}).appendTo(l),c=e("<div/>",{"class":"crsa-cm-props"}).appendTo(l),u=null,d=null;this.filter_set_in_props_mode=!1,this.setReferenceElement=function(e,s){n=e,s||N(),F&&(n?F.show():F.hide())},this.setShowOnlyClasses=function(e,s){r=e,s||this.refresh()},this.setSelectedPage=function(e,s){u=e,d=u?u.get(0):null,s||this.refresh()};var h=function(){var e=getCrsaPageForIframe(u);e&&T.find("span").html("Visible at "+e.deviceWidth+"px")},f=[],g=[],p=!1,v=!1;this.refresh=function(){h(),w(),D(),N()},this.setSelectedPage(e.fn.crsa("getSelectedPage"),!0),e("body").on("crsa-window-changed",function(e,s){s==getCrsaPageForIframe(u)&&(h(),v&&N())});var m=function(){e(".crsa-cm-props").html(""),k.showListPanel(!1)};e("<h2/>").html("Stylesheets").appendTo(o);var S=e("<ul/>",{"class":"cm-sslist"}).appendTo(o),y=function(e,s,t){if(e.ignore=t,t){var a=f.indexOf(e);0>a&&f.push(e)}else{var a=f.indexOf(e);a>=0&&f.splice(a,1)}},b=function(e,s){var t=s.find("i.filter");e.ignore?t.addClass("fa-times").removeClass("fa-check"):t.addClass("fa-check").removeClass("fa-times")},w=function(){if(S.html(""),u){var s=getCrsaPageStylesForPage(u);if(s){var t=s.getAllCrsaStylesheets();e.each(t,function(a,r){{var n=e("<li/>").appendTo(S).data("crsa-cs",r),l=e("<i/>",{"class":"filter fa fa-fw"}).appendTo(n).addClass(f.indexOf(r)<0?"fa-check":"fa-times"),i=e("<i/>",{"class":"fa fa-fw ss-enable"}).appendTo(n).addClass(r.isEnabledForPage(d)?"fa-eye":"fa-eye-slash"),c=e("<a/>",{href:"#"}).html(r.name).appendTo(n),u=e("<a/>",{href:"#"}).html("   x");e("<i/>",{"class":"fa fa-bars"}).appendTo(n)}l.tooltip({container:"body",placement:"top",title:"Hide / show stylesheet rules in the list below.",trigger:"hover"}),i.tooltip({container:"body",placement:"top",title:"Disable / enable the stylesheet.",trigger:"hover"}),b(r,n),r.genGetError()&&c.addClass("has-css-error");var h=function(s){s.ignore=!1,f=[],e.each(t,function(e,t){t!=s&&(f.push(t),t.ignore=!0)}),s.ignore||s.loaded?(e("body").trigger("crsa-stylesheets-changed"),crsaQuickMessage("CSS rules list updated.")):s.load(s.url,function(){e("body").trigger("crsa-stylesheets-changed"),crsaQuickMessage("CSS rules list updated.")});var a=o.find("h3.crsa-cm-cs"),r=a.css("color");setTimeout(function(){a.animate({color:"#ffee00"},100,function(){a.animate({color:r},250)})},50)};c.on("click",function(s){var t=e(s.delegateTarget).closest("li"),a=t.data("crsa-cs");h(a),s.preventDefault()}).on("contextmenu",function(s){s.preventDefault();var t=new CrsaContextMenu,a=e(s.delegateTarget).closest("li"),r=a.data("crsa-cs");t.add("Show only these CSS rules",null,function(){h(r)}),r.ignore||!r.loaded?t.add("Load &amp; Show",null,function(){g(a,r)}):t.add("Ignore",null,function(){g(a,r)}),r.isEnabledForPage(d)?t.add("Disable",null,function(){v(r,a)}):t.add("Enable",null,function(){v(r,a)}),r.inline||t.add("Reload",null,function(){k.reloadStylesheet(r)}),t.showAt(s.pageX,s.pageY)});var g=function(s,t){y(t,s,!t.ignore),b(t,s),e(".tooltip").hide(),t.ignore||t.loaded?e("body").trigger("crsa-stylesheets-changed"):t.load(t.url,function(){e("body").trigger("crsa-stylesheets-changed")})};l.on("click",function(s){var t=e(s.delegateTarget).closest("li"),a=t.data("crsa-cs");g(t,a),s.preventDefault()});var p=function(t){var a=getCrsaPageForIframe(e.fn.crsa("getSelectedPage"));a.undoStack.add("Detach "+t.name),s.detachFrom(t),a.autoSize(),e("body").trigger("crsa-stylesheets-changed")};u.on("click",function(s){var t=e(s.delegateTarget).closest("li"),a=t.data("crsa-cs");p(a),s.preventDefault()});var v=function(s,t){var a=t.find("i.ss-enable"),r=s.isEnabledForPage(d);s.setEnabledForPage(d,!r),r?a.addClass("fa-eye-slash").removeClass("fa-eye"):a.addClass("fa-eye").removeClass("fa-eye-slash");var n=getCrsaPageForIframe(e.fn.crsa("getSelectedPage"));n.autoSize(),D()};i.on("click",function(s){var t=e(s.delegateTarget).closest("li"),a=t.data("crsa-cs");v(a,t),s.preventDefault()})}),S.sortable("refresh")}}};e("<a/>",{"class":"cm-sslist-manage",href:"#"}).html("+ Manage...").appendTo(o).on("click",function(s){e.fn.crsacss("showStylesheetsManager"),s.preventDefault()}),S.sortable({handle:"i.fa-bars",axis:"y",scroll:!1}).on("sortupdate",function(){var s=[];S.find(">li").each(function(t,a){var r=e(a).data("crsa-cs");r&&s.push(r)}),getCrsaPageForIframe(e.fn.crsa("getSelectedPage")).undoStack.add("Reorder stylesheets"),getCrsaPageStylesForPage(u).reorder(s,function(){D(),m()})}),w(),e("body").on("crsa-stylesheets-changed",function(){w(),D(),N(),m()}),e("<h2/>").html("CSS Rules").appendTo(o);var C=e("<input/>",{"class":"crsa-cm-input form-control filter-form",placeholder:"search"}).appendTo(o),_=e('<label class="css-opt-label"><input class="control-label" type="checkbox" value="1">&nbsp;Active</label>').appendTo(o),T=e('<label class="css-opt-label"><input class="control-label" type="checkbox" value="1">&nbsp;<span>Visible</span></label>').appendTo(o);_.find(">input").on("change",function(s){p=e(s.delegateTarget).is(":checked"),N()}),_.tooltip({container:"body",placement:"top",title:"Show only active rules for the selected element.",trigger:"hover"}),T.find(">input").on("change",function(s){v=e(s.delegateTarget).is(":checked"),N()}),T.tooltip({container:"body",placement:"top",title:"Show only rules that match the current window size.",trigger:"hover"});var R=null,F=null;this.setFilter=function(e,s){"undefined"==typeof s&&(s=!0),R=e,C.val(e),s&&(D(),N())};var k=this,A=e("<ul/>",{"class":"crsa-cm-list"}).appendTo(o),x=!1,P=function(s){var t=R?normalizeSelector(R):null;x=!1;var a=[];return e.each(s,function(e,s){return r&&"class"!=s.type?!0:((!R||s.selector&&s.crsa_stylesheet.getSelector(s).indexOf(t)>=0||s.raw&&s.raw.indexOf(R)>=0)&&(a.push(s),"class"==s.type&&s.class===R&&(x=!0)),void 0)}),a},L=-1,D=function(){if(A.html(""),u){var r=null;if(n){var l=n.get(0);if(l.ownerDocument.defaultView&&l.ownerDocument.defaultView.getMatchedCSSRules){var o=l.ownerDocument.defaultView.getMatchedCSSRules(l,"");if(r={},o)for(var c=o.length;c--;)r[o[c].selectorText]=!0}}var d=getCrsaPageStylesForPage(u),h=getCrsaPageForIframe(u);g=[],e.each(d.getAllCrsaStylesheets(),function(s,t){if(t.ignore)return!0;g.push(t);var a=P(t.getAllRules()),r=e("<li/>",{"class":"crsa-stylesheet"}).appendTo(A).html('<div><h3 class="crsa-cm-cs">'+t.name+"</h3></div>").data("cs",t),n=t.genGetType();if("css"!=n){var l=e('<span class="cs-type">'+n+"</span>");l.tooltip({container:"body",placement:"auto top",title:"This stylesheet uses "+n.toUpperCase()+" parser.",trigger:"hover"}),r.find("h3").append(l)}var o=e("<a/>",{"class":"cm-sslist-addrule",href:"#"}).html("+ Add rule").appendTo(r.find(">div"));o.on("click",function(e){e.preventDefault(),E(o,t,R)});var i=t.genGetError();if(i){var c=i.extract?i.extract.join("\n"):"";c.length>80&&(c=c.substr(0,80));{var u='<div class="cm-error">Line '+i.line+", "+i+"<pre>"+c+"</pre></div>";e('<div class="alert alert-info">Stylesheet has one or more LESS syntax errors (use <b>Page -&gt; Edit code</b> to fix it): '+u+"</div>").appendTo(r.find(">div"))}}A=e("<ul/>").appendTo(r);var d=null;a.length>0?(e.each(a,function(s,t){var a=t.media?t.media:null;if(d!=a&&(d&&(A=A.parent().closest("ul")),a)){var r=e("<li/>",{"class":"crsa-cm-media"}).appendTo(A).html('<div class="media-query">'+h.describeMediaQuery(a)+"</div>").data("media",a);e("<i/>",{"class":"fa fa-bars crsa-cm-move"}).appendTo(r.find("> div")),A=e("<ul/>").appendTo(r)}d=a;var n,r=e("<li/>",{"class":"mjs-nestedSortable-no-nesting"}).appendTo(A).data("rule",t),l=e('<div class="rule"></div>').appendTo(r);t.selector?(t.class&&e("<i/>",{"class":"fa fa-plus crsa-cm-apply"}).appendTo(l),n=e("<a/>",{"class":"crsa-cm-edit",href:"#"}).text(t.selector).appendTo(l)):t.raw&&(n=e("<a/>",{"class":"crsa-cm-edit",href:"#"}).text(shortenString(t.raw,18)).appendTo(l),t.less_type&&"Comment"==t.less_type&&n.addClass("crsa-cm-name-comment"));e("<i/>",{"class":"fa fa-trash-o crsa-cm-remove"}).appendTo(l),e("<i/>",{"class":"fa fa-code crsa-cm-code"}).appendTo(l);e("<i/>",{"class":"fa fa-bars crsa-cm-move"}).appendTo(l)}),d&&(A=A.parent().closest("ul"))):R&&e('<li><div class="alert alert-info">No rules found.</div></li>').appendTo(A),A=A.parent().closest("ul")}),A.find(".crsa-cm-apply").on("click",function(s){var t=e(s.delegateTarget).closest("li"),r=t.data("rule"),n=pinegrow.getSelectedElement();if(n&&"element"==n.type){if(r.classes)if(1==r.classes.length)n.data.hasClass(r.class)?a.trigger("crsa-cm-class-remove",r.class):a.trigger("crsa-cm-class-add",r.class);else{var l=t.data("assign-menu");if(l&&l.is(":visible"))l.remove();else{var o=I(t,!0);t.data("assign-menu",o)}}return!1}}),A.find(".crsa-cm-edit").on("click",function(t){var a=e(t.delegateTarget).closest("li"),r=a.data("rule");r.selector?k.editRule(r):s(r),t.preventDefault()}).on("mouseover",function(s){var a=e(s.delegateTarget).closest("li"),r=a.data("rule");if(r&&r.selector)try{var n=e(t(u.get(0))).find(r.selector);e.fn.crsa("highlightElement",n)}catch(l){}}).on("mouseout",function(){e.fn.crsa("highlightElement",null)}),A.find("div.rule").on("contextmenu",function(s){s.preventDefault();var t=e(s.delegateTarget).closest("li");I(t,!1)}),A.find(".crsa-cm-code").on("click",function(t){var a=e(t.delegateTarget).closest("li"),r=a.data("rule");s(r),t.preventDefault()}).on("mouseover",function(s){var t=e(s.delegateTarget).closest("li"),a=t.data("rule");if(a){{var r=e("<div/>");e("<pre/>").html(a.crsa_stylesheet.genGetSourceHtmlForRule(a)).appendTo(r)}e('<p>Click on <i class="fa fa-code"></i> to edit rule code.<br />Click on <span>.Selector</span> to edit rule properties.</p>').appendTo(r)}e.fn.crsa("showPreview",t,r,"cm-preview")}).on("mouseout",function(){e.fn.crsa("hidePreview")}),A.find(".crsa-cm-remove").on("click",function(s){{var t=e(s.delegateTarget).closest("li"),r=t.data("rule"),n=t.closest("li.crsa-stylesheet"),l=n.data("cs"),o=t.find("input");e.trim(o.val())}getCrsaPageForIframe(e.fn.crsa("getSelectedPage")).undoStack.add("Remove CSS rule"),l.removeLessRule(r),l.genRegenerateAndSetCssSource(function(){a.trigger("crsa-cm-removed",r),i.trigger("crsa-rules-changed")}),s.preventDefault()}),R?A.find("a.crsa-cm-move").hide():A.find("a.crsa-cm-move").show()}},I=function(t,r){var n=t.data("rule"),l=new CrsaContextMenu;r||(n.selector&&l.add("Edit...",null,function(){k.editRule(n)}),l.add("Edit code...",null,function(){s(n)}));var o=pinegrow.getSelectedElement();if(o&&"element"!=o.type&&(o=null),n.classes)if(r||l.add("",null,null,"divider"),o){l.add("Assign class to <b>"+getElementName(o.data)+"</b>",null,null,"header");var i=[];e.each(n.classes,function(e,s){s=s.replace(".",""),o.data.hasClass(s)&&i.push(s),function(e){l.add("+ "+e,null,function(){a.trigger("crsa-cm-class-add",e)})}(s)});var c=o.data.attr("class").split(/\s+/),u=[];c&&e.each(c,function(e,s){i.indexOf(s)<0&&u.push(s)}),(i.length>0||u.length>0)&&(l.add("",null,null,"divider"),l.add("Remove class from <b>"+getElementName(o.data)+"</b>",null,null,"header"),e.each(i,function(e,s){!function(e){l.add("- "+e,null,function(){a.trigger("crsa-cm-class-remove",e)})}(s)}),e.each(u,function(e,s){0!=s.indexOf("crsa-")&&!function(e){l.add("- "+e,null,function(){a.trigger("crsa-cm-class-remove",e)})}(s)}))}else l.add("Select element first, then assign class to it.",null,null,"header");var d=l.showAt(event.pageX,event.pageY,t.closest(".crsa-cm-rules"));return d};this.editRule=function(s){L=s.crsa_stylesheet.crsa_rules.indexOf(s);var t=getObjectFromRule(s);e.fn.crsa("showProperties",t,c);var a=l.find("button.back");0==a.length&&(a=e("<button/>",{"class":"btn back"}).html('<i class="fa fa-arrow-left"></i>&nbsp;Back to rules').prependTo(c.parent()),a.on("click",function(e){k.refresh(),k.showListPanel(!0),e.preventDefault()})),l.animate({left:-250},150,function(){})},this.showListPanel=function(e){e?l.animate({left:0},150,function(){}):l.css("left",0)},this.reloadStylesheet=function(s,t){var a=function(){t&&t(),crsaQuickMessage(s.name+" reloaded."),e("body").trigger("crsa-stylesheets-changed")};s.changed?showAlert(s.name+" has unsaved changes. Do you want to reload the stylesheet and loose these changes?","Unsaved changes","Cancel","Reload",null,function(){s.reload(a)}):s.reload(a)};var E=function(s,t,r){if(t.genGetError())return showAlert(t.name+" has syntax errors. Fix the errors before adding new rules.","Notice"),void 0;var l=s.offset(),o=l.left>e(window).width()/2?"left":"right",i=getUniqueId();if(s.data("popover-active"))return s.popover("destroy"),s.data("popover-active",null),void 0;{var c=function(e){setTimeout(function(){e.closest(".popover").remove()},750)};s.popover({html:!0,placement:o,trigger:"manual",title:"Add new CSS rule",container:"body",content:'<form id="'+i+'"><div class="form-group"><input class="form-control" placeholder=".new-rule" style="margin-bottom:8px;"/><p class="help-block"></p></p><button class="ok btn">Create</button><button class="ok assign btn btn-link">Create & Assign</button><button class="closeit btn btn-link">Cancel</button></div></form>'}).on("shown.bs.popover",function(){var l=e("#"+i),o=l.find("input").focus();r&&o.val(r);var u=l,d=l.find("button.ok"),h=l.find("button.assign"),f=l.find("p.help-block").hide(),g=l.find("button.closeit");n||h.hide();
var p=function(r){var i=e.trim(o.val());return i&&0!=i.length?e(r.delegateTarget).hasClass("assign")&&!getClassFromSelector(i)?(f.html(i+" is not a class selector. You can only assign classes (for example .BUTTON) to elements.").show(),l.addClass("has-error"),void 0):(getCrsaPageForIframe(e.fn.crsa("getSelectedPage")).undoStack.add("Add CSS rule / "+i),t.addLessRule(i,{}),t.genRegenerateAndSetCssSource(function(){e("body").trigger("crsa-rules-changed");var s=t.crsa_rules.length>0?t.crsa_rules[t.crsa_rules.length-1]:null;s&&(e(r.delegateTarget).hasClass("assign")&&n&&s.class&&!n.hasClass(s.class)&&(a.trigger("crsa-cm-class-add",s.class),N()),k.editRule(s))}),s.popover("hide"),c(l),void 0):(l.addClass("has-error"),void 0)};u.on("submit",function(e){e.preventDefault(),p(e)}),d.on("click",function(e){e.preventDefault(),p(e)}),g.on("click",function(e){s.popover("hide"),e.preventDefault(),c(l)})}).on("hidden.bs.popover",function(){setTimeout(function(){s.popover("destroy").data("popover-active",null)},10)})}s.popover("show").data("popover-active",!0)},N=function(){if(n?A.find(".crsa-cm-apply").show():(A.find(".crsa-cm-apply").hide(),A.find("li.crsa-cm-has-rule").removeClass("crsa-cm-has-rule")),u){var s={},t=getCrsaPageForIframe(u).getWindow();if(n){var a=null,r=n.get(0);if(r.ownerDocument.defaultView&&r.ownerDocument.defaultView.getMatchedCSSRules){var l=r.ownerDocument.defaultView.getMatchedCSSRules(r,"");if(a={},l)for(var o=l.length;o--;)a[normalizeSelector(l[o].selectorText)]=!0}A.find("li").each(function(s,t){var r=e(t),l=!1,o=r.data("rule");if(null==o||!o.selector)return o&&(l=p,t.className=p?"hide-rule":""),!0;var i=o.selector,c=!1;if(a)t.crsaNormalizedSelector?i=t.crsaNormalizedSelector:(i=normalizeSelector(i),t.crsaNormalizedSelector=i),i&&i in a?(t.className="crsa-cm-has-rule",c=!0):(l=p,t.className=p?"hide-rule":"");else try{i&&n.is(i)?(t.className="crsa-cm-has-rule",c=!0):(l=p,t.className=p?"hide-rule":"")}catch(u){l=p,t.className=p?"hide-rule":""}if(o.class){var d=t.firstChild.firstChild;d.className=c?"fa fa-minus crsa-cm-apply":"fa fa-plus crsa-cm-apply"}l&&(t.className="hide-rule")})}A.find("li.crsa-cm-media").each(function(a,r){var n=e(r),l=n.data("media");return l&&v&&(l in s||(s[l]=t.matchMedia(l).matches),!s[l])?(n.addClass("hide-rule"),!0):(0==n.find(">ul >li").not(".hide-rule").length?n.addClass("hide-rule"):n.removeClass("hide-rule"),void 0)})}};D(),A.nestedSortable({forcePlaceholderSize:!0,helper:"clone",placeholder:"tree-placeholder",handle:"div > i.fa-bars, h3",tabSize:20,protectRoot:!0,tolerance:"pointer",scroll:!1,aacontainer:".crsa-cm-rules",axis:"y",isTree:!0,items:"li",listType:"ul",toleranceElement:"> div",isAllowed:function(e,s,t){if(R)return!1;if(t.data("cs"))return!1;if(!s)return!1;if(s.data("cs"))return!0;if(s.data("media")){if(t.data("media"))return!1}else if(s.data("rule"))return!1;return!0}}).on("sortstart",function(){R&&showAlert("Can't sort rules while search filter is active. Something bad could happen...","Ups, this is unpredictable")}).on("sortupdate",function(){var s=[];getCrsaPageForIframe(e.fn.crsa("getSelectedPage")).undoStack.add("Reorder CSS rules"),A.find("li").each(function(t,a){var r=e(a),n=r.data("rule");n&&(n.media=r.parent().parent().data("media"),n.crsa_stylesheet=r.closest("li.crsa-stylesheet").data("cs"),s.push(n))}),getCrsaPageStylesForPage(u).reorderRules(g,s,function(){e("body").trigger("crsa-rules-changed")})}),N();var O=null;C.on("input",function(){R=C.val(),R&&0==R.length&&(R=null),O&&clearTimeout(O),O=setTimeout(function(){D(),O=null},300)}),i.on("crsa-rules-changed",function(){getCrsaPageStylesForPage(u).getAllActiveRules();D(),N()}),i.on("crsa-element-selected",function(e,s){if(s&&"element"==s.type){var t=s.data;k.setReferenceElement(t)}else null==s&&k.setReferenceElement(null)})};window.CrsaClassManager=_}(jQuery);