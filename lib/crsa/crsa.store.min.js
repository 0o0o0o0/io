var CrsaBrowserStorage=function(){var e=function(e){return"localSave_"+e};this.save=function(t,n){var o=e(t);localStorage[o]=n},this.exists=function(t){return e(t)in localStorage},this.load=function(t){var n=e(t);return n in localStorage?localStorage[n]:null},this.saveProject=function(){var e={pages:[],css:[]};if($.each($.fn.crsapages("getAllPages"),function(t,n){e.pages.push({url:n.url,html:n.getSource(!1),name:n.name}),n.setPageChanged(!1)}),0==e.pages.length)return null;$.each($.fn.crsacss("getAllCrsaStylesheets"),function(t,n){!n.inline&&n.loaded&&(e.css.push({url:n.url,less:n.genGetSource()}),n.changed=!1)});var t=JSON.stringify(e);return t.length>2e6?alert("Sorry, the project is too big to save. Use File -> Save."):localStorage.savedProject=t,e},this.hasSavedProject=function(){return"savedProject"in localStorage},this.restoreProject=function(e){if(!this.hasSavedProject())return null;try{var t=localStorage.savedProject,n=JSON.parse(t),o=0,i=0,r=function(){if(i>=n.css.length)$("body").trigger("crsa-stylesheets-changed"),e&&e();else{var t,o=n.css[i],a=findCrsaStylesheetForUrl(o.url);a&&a.length>0?(t=a[0],t.genSetSource(o.less,function(){i++,r()})):$.fn.crsacss("addStylesheetFromUrl",o.url,function(e){e.genSetSource(o.less,function(){i++,r()})})}},a=function(){var e=n.pages[o];$.fn.crsa("openPage",e.url,function(){},function(t){setPageSource(t.$iframe,e.html,null,!0),t.runScripts(function(){t.callFrameworkHandler("on_page_loaded"),$.fn.crsa("updateIfNeeded"),t.addCrsaStyles()}),e.name&&(t.name=e.name,t.updateNameDisplay())},null,function(){o++,o<n.pages.length?a():r()})};return n.pages.length>0&&a(),n}catch(s){return null}}},CrsaLocalStorage=function(){var e={},t=null,n=function(){t&&clearTimeout(t),t=setTimeout(function(){var t=JSON.stringify(e);t=window.btoa(encodeURIComponent(t)),localStorage.crsaInternal=t},100)};if(this.setValue=function(t,o){isApp()?(e[t]=o,n()):localStorage[t]=o},this.getValue=function(t){return isApp()?t in e?e[t]:null:t in localStorage?localStorage[t]:null},this.hasValue=function(t){return isApp()?t in e?!0:!1:t in localStorage?!0:!1},isApp())if(localStorage.crsaInternal)try{e=JSON.parse(decodeURIComponent(window.atob(localStorage.crsaInternal)))}catch(o){e={}}else $.each(localStorage,function(t,n){e[t]=n}),n()},CrsaPost=function(e){var t=0,n={},o={};console.log("Post started"),this.remote=e,this.app="chrome-extension:"==location.protocol;var i=this;window.addEventListener("message",function(e){console.log("Post - msg received"),console.log(e);var t=e.data.action?e.data.action:null,r=e.data.msg_id?e.data.msg_id:null,a=e.data.passed_msg_id?e.data.passed_msg_id:null;if(t)if(t in o){var s=o[t](e.data);s||(s={}),r&&(s.passed_msg_id=r,i.send(s))}else{console.log("Post - Unknown action received - "+t);var s={error:"Unknown action"};r&&(s.passed_msg_id=r,i.send(s))}else if(a)a in n?(n[a](e.data),delete n[a]):console.log("Post - have key, but no callback found.");else if(!i.remote){i.remote=e.source,console.log("Post - remote set");var s={message:"Remote source set"};r&&(s.passed_msg_id=r,i.send(s))}}),this.registerAction=function(e,t){o[e]=t},this.send=function(e,o){if(console.log("Post - sending msg..."),console.log(e),t++,o){var i="cmd"+t;n[i]=o,e.msg_id=i}this.remote.postMessage(e,"*")}},CrsaProject=function(){this.name="Project",this.root=null,this.localPath=null,this.url=null,this.entityMap={},this.frameworks=[];var e=this;this.getFile=function(e){for(var t=e.split("/"),n=this.root,o=0;o<t.length;o++){var i=t[o];if(0!=i.length)for(var r=0;r<n.children.length;r++){var a=n.children[r];if(a.name==i){if(a.isFile||o==t.length-1)return a;n=a;break}}}return null},this.toJSON=function(){var e={};return e.name=this.name,e.root=this.root,e.localPath=this.localPath,e.url=this.url,JSON.stringify(e)},this.getDocuments=function(){var e=[];return $.each(this.root.children,function(t,n){n.name.match(/\.html$/i)&&e.push(n)}),e},this.fromSimpleTemplate=function(t){this.url=t.url,this.name=t.name,t.frameworks&&(this.frameworks=t.frameworks),this.root=new CrsaFile,this.root.isFile=!1,this.root.name=t.name,this.root.url=t.url;var n=crsaGetAppDir();this.root.path=n+crsaMakeFileFromUrl(t.url);var o=function(e,t,i){var r=isApp()?require("path").sep:"/";$.each(e,function(e,a){if(a.children){var s=new CrsaFile;s.name=a.src,s.isFile=!1,s.url=i+s.name,a.tag&&(s.tag=a.tag),a.required&&(s.required=!0),n&&(s.path=t.path+s.name+r),t.children.push(s),o(a.children,s,s.url+r)}else{var l=new CrsaFile;l.name=a.src,l.isFile=!0,l.url=i+l.name,n&&(l.path=t.path+l.name),a.tag&&(l.tag=a.tag),a.required&&(l.required=!0),l.image=a.image?i+a.image:i+"screenshots"+r+l.name.replace("html","jpg"),t.children.push(l)}})};o(t.pages,e.root,t.url)},this.copyRequiredFilesTo=function(e){var t=require("fs"),n=require("path"),o=function(e,i){console.log("copy "+i),$.each(e,function(e,r){if(!r.required)return!0;var a=i+r.name,s=crsaIsFileOrDir(a,t);s||(r.isFile?(console.log("copy "+r.path+" to "+a),crsaCopyFileSync(t,r.path,a)):t.mkdirSync(a)),r.children&&o(r.children,a+n.sep)})};o(this.root.children,e)},this.copyRequiredFilesToZip=function(e,t){var n=0,o=function(e,i,r){$.each(e,function(e,a){if(!a.required)return!0;if(a.isFile)console.log("copy "+a.url+" to "+r),n++,$.ajax({url:a.url,data:null,dataType:"text"}).done(function(e){setTimeout(function(){i.file(a.name,e),n--,0==n&&t()},0)}).fail(function(){setTimeout(function(){n--,console.log("can not read "+a.url),0==n&&t()},0)});else{var s=i.folder(a.name);a.children&&o(a.children,s,r+"/"+a.name)}})};o(this.root.children,e,"/"),0==n&&t()}},CrsaFile=function(e){this.isFile=!0,this.name=null,this.path=null,this.url=null,this.children=[],this.entity=null,this.image=null,this.required=!1,this.tag=null;var t=e;return this.fromEntity=function(e){return this.isFile=e.isFile,this.name=e.name,this.path=e.fullPath,t&&(t[this.path]=e),this},this.getEntity=function(){return t&&this.path&&this.path in t?t[this.path]:null},this},CrsaStore=function(){this.type="AbstractStore",this.listProjects=function(){},this.getProject=function(){},this.createProjectFromTemplate=function(){},this.saveProject=function(){},this.deleteProject=function(){},this.createProjectFile=function(){},this.saveProjectFile=function(){},this.deleteProjectFile=function(){},this.copyProjectFile=function(){},this.getProjectFileUrl=function(){}},CrsaFileStore=function(){this.name="FileStore",this.app="chrome-extension:"==location.protocol;var e=this;this.listProjects=function(){},this.getProject=function(t,n){chrome.fileSystem.chooseEntry({type:"openDirectory"},function(t){console.log(t),e.loadProject(t,n)})},this.loadProject=function(e,t){var n=new CrsaProject;n.root=new CrsaFile(n.entityMap).fromEntity(e),chrome.fileSystem.getDisplayPath(e,function(o){n.name=n.root.name,n.localPath=o;var i=e.createReader(),r=0,a=function(e,t,o){r++,e.readEntries(function(i){if(r--,i.length){for(var s=0;s<i.length;s++){var l=new CrsaFile(n.entityMap);if(l.fromEntity(i[s]),t.children.push(l),!l.isFile){var c=i[s].createReader();a(c,l,o)}}a(e,t,o)}else 0>=r&&o()},function(e){r--,console.log(e),0>=r&&o()})};a(i,n.root,function(){t(n)})})},this.saveProject=function(){},this.createProjectFromTemplate=function(t,n){var o=chrome.runtime.getURL("/templates/"+t+"/pinegrow.json");console.log(o),$.ajax({url:o,data:null,dataType:"json"}).done(function(o){console.log(o),chrome.fileSystem.chooseEntry({type:"openDirectory"},function(i){chrome.fileSystem.isWritableEntry(i,function(r){if(r){var a=0,s=function(){a--,0>=a&&e.loadProject(i,function(e){n(e)})},l=function(e,n,o){console.log("copying dir "+e.name);for(var i=0;i<e.children.length;i++){var r=e.children[i];if(console.log(r.path),r.isFile){a++;var c=chrome.runtime.getURL("/templates/"+t+r.path.replace("/"+t,"")),u=new XMLHttpRequest;u.open("GET",c,!0),u.responseType="blob",u.crsaNode=r,u.onload=function(){var e=this.crsaNode,t=this.response;n.getFile(e.name,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(){console.log("Write completed."),s()},e.onerror=function(e){console.log("Write failed: "+e.toString()),s()},e.write(t)},function(e){s(),console.log(e)})},function(e){s(),console.log(e)})},u.send()}else{a++;var h=function(e){n.getDirectory(e.name,{create:!0},function(t){l(e,t,o),s()},function(e){s(),console(e)})};h(r)}}};l(o.root,i,function(){console.log("template copied to project.")})}else console.log(i+" is not writable.")}),console.log(i)})}).fail(function(e){console.log(e)})},this.deleteProject=function(){},this.createProjectFile=function(){},this.saveProjectFile=function(){},this.deleteProjectFile=function(){},this.copyProjectFile=function(){},this.getProjectFileUrl=function(){}};CrsaFileStore.prototype=new CrsaStore;