function getIframeBody(e){var t=e.contentDocument||e.contentWindow.document;return t.body}function getIframeHtmlElement(e){var t=e.contentDocument||e.contentWindow.document,a=t.getElementsByTagName("html")[0];return a}function getIframeHead(e){var t=e.contentDocument||e.contentWindow.document,a=t.getElementsByTagName("head")[0];return a}function getIframeTag(e,t){var a=e.contentDocument||e.contentWindow.document,n=a.getElementsByTagName(t)[0];return n}function crsaDuplicateName(e,t,a){var n,r,i=e.split("."),s=i.length>1?i.length-2:i.length-1,o=0,l=t?crsaGetFileDir(t):null,c=isApp()?require("fs"):null;do{if(i[s]=i[s].replace(/\([0-9]+\)$/i,""),i[s]=0==o?i[s]:i[s]+"("+o+")",r=i.join("."),n=!1,a&&a.indexOf(r)>=0&&(n=!0),!n&&c&&l){var d=l+r;c.existsSync(d)&&(n=!0)}o++}while(n);return r}function crsaGetFileDir(e){if(isApp()){var t=require("path"),a=t.dirname(e);return a.charAt(a.length-1)!=t.sep&&(a+=t.sep),a}var n=e.split("/"),a="";return n.length>1&&(n.splice(n.length-1,1),a=n.join("/")),"/"!=a.charAt(a.length-1)&&(a+="/"),a}function crsaGetAppDir(){return isApp()?crsaGetFileDir(crsaMakeFileFromUrl(window.location.href)):null}function crsaIsFileOrDir(e,t){if(!isApp())return!1;try{t||(t=require("fs"));var a=t.statSync(e);return a.isFile()?"file":a.isDirectory()?"dir":null}catch(n){return null}}function crsaCopyFileSync(e,t,a){var n=e.readFileSync(t);e.writeFileSync(a,n)}function crsaCopyFile(e,t,a,n){function r(e){i||(n(e),i=!0)}var i=!1,s=e.createReadStream(t);s.on("error",function(e){r(e)});var o=e.createWriteStream(a);o.on("error",function(e){r(e)}),o.on("close",function(){r()}),s.pipe(o)}function crsaWriteFileWithBackup(e,t,a,n){if("file"==crsaIsFileOrDir(t,e)){if("1"==pinegrow.getSetting("backup","1")){var r=require("path"),i=crsaGetFileDir(t)+"_pgbackup";crsaIsFileOrDir(i,e)||e.mkdirSync(i),i+=r.sep;var s=getPageName(t),o=s.split("."),l="_"+Math.floor((new Date).getTime()/1e3);o.length>1?o[o.length-2]+=l:o[0]+=l;var c=i+o.join(".");crsaCopyFileSync(e,t,c)}}else{var d=crsaGetFileDir(t);crsaCreateDirs(d,e)}console.log("writing file "+t),e.writeFileSync(t,a,n)}function crsaRemoveUrlParameters(e){var t=e.split(/[\?\#]/);return t.length>0?t[0]:e}function crsaCreateDirs(e,t){var a=require("path");if(crsaIsFileOrDir(e,t))return!1;for(var n=e.split(a.sep),r="",i=0;i<n.length;i++)0!=n[i].length?(r+=a.sep+n[i],crsaIsFileOrDir(r,t)||t.mkdirSync(r)):r+=a.sep;return!0}function crsaMakeUrlFromFile(e){var t="file://";if(isApp())var a=require("path"),t="/"==a.sep?"file://":"file:///";return t+encodeURI(e.replace(/\\/g,"/"))}function crsaMakeFileFromUrl(e){if(isApp()){var t=require("path"),a="/"==t.sep?"file://":"file:///";return decodeURI(crsaRemoveUrlParameters(e).replace(a,"").replace(/\//g,t.sep))}return crsaRemoveUrlParameters(e).replace("file://","")}function crsaIsFileUrl(e){return 0==e.indexOf("file:")}function crsaGetNameFromUrl(e,t){e=crsaRemoveUrlParameters(e);var a=e.split(/[\\\/]/).pop();0==a.length&&(a=t);var n=a.split("?");return n.length>1?n[0]:a}function crsaGetBaseForUrl(e){e=crsaRemoveUrlParameters(e);var t=e.split(/[\/]/);return t.pop(),t.join("/")}function crsaCombineUrlWith(e,t){return e=crsaGetBaseForUrl(e),0==t.length?e:("/"!=t.charAt(0)&&(t="/"+t),e+t)}function crsaIsAbsoluteUrl(e){return e.indexOf("://")>=0}var crsaPageUid=1,CrsaPageTemplate=function(){this.type=null,this.header=null,this.html=null,this.detect=function(e){if(0!=e.indexOf("---"))return!1;var t=e.split("---");return t.length<3?!1:(this.type="liquid",this.header="---"+t[1]+"---",t.splice(0,2),this.html=1==t.length?t[0]:t.join("---"),!0)},this.getTemplateSource=function(e){return this.type?this.header+"\n"+e:e},this.getHtml=function(){return this.html}},CrsaPage=function(){this.url=null,this.name=null,this.localFile=null,this.$iframe=null,this.$page=null,this.loading=!1,this.changed=!0,this.force_close=!1,this.live_update=null,this.save_parent=!1,this.uid=crsaPageUid++,this.undoStack=new CrsaPageUndoStack(this),this.undoSetFlag=!1,this.exists=!1,this.crsaProjectTemplate=null,this.allowReload=!1,this.readOnly=!1,this.treeTop=null,this.treeRepaintOnShow=null,this.treeCurrentRoot=null,this.load_source=null,this.frameworks_added=!1,this.breakpoints=[],this.sourceNode=null,this.scrollMode=crsaGetCustomLogic().scrollMode,this.deviceWidth=1024,this.template=new CrsaPageTemplate,this.frameworks=[],this.animationsStopped=!1;var e=this,t=null,a="crsa-inline-styles",n=null,r={},i=null,s=function(t,a){var n=e.getPageUrlFromLoadedUrl(a.url);n==e.url&&(console.log("Source loaded "+n),e.sourceNode=a.rootNode)};pinegrow.sourceParser&&$("body").on("crsa-server-page-loaded",s),this.getPageUrlFromLoadedUrl=function(e){return e=pinegrow.getOriginalUrl(e),e.replace("?pgedit=1","").replace("pgedit=1","")};var o=function(){n=null,i=null};this.getComponentTypes=function(){if(!n){n=[];for(var e=0;e<this.frameworks.length;e++){var t=this.frameworks[e];$.each(t.getComponentTypes(),function(e,t){n.push(t)})}n.sort(function(e,t){return e.priority-t.priority}),r={},$.each(n,function(e,t){r[t.type]||(r[t.type]=t)})}return n},this.getPageStylesheets=function(){return getCrsaPageStylesForPage(this.$iframe)},this.getTypeDefinition=function(e){return null==r&&this.getComponentTypes(),r[e]?r[e]:null},this.hasStylesheet=function(e){for(var t=this.$iframe.get(0).contentDocument||this.$iframe.get(0).contentWindow.document,a=0;a<t.styleSheets.length;a++){var n=t.styleSheets[a];if(n.href&&n.href.match(e))return!0}return!1},this.getLibSections=function(){if(!i){i=[];for(var e=0;e<this.frameworks.length;e++){var t=this.frameworks[e];$.each(t.getLibSections(),function(e,t){i.push(t)})}}return i},this.getAllTypes=function(e){for(var t=[],a=0;a<this.frameworks.length;a++){var n=this.frameworks[a],r=n.getType(e);r&&t.push(r)}return t},this.detectAndAddFrameworks=function(){var t=this.getPageInfo(),a=[],n=[];this.crsaProjectTemplate&&(n=this.crsaProjectTemplate.frameworks),this.frameworks=[];var r=function(t){e.frameworks.unshift(t),t.type&&a.push(t.type)};n.length>0&&$.each(pinegrow.getFrameworks(),function(e,t){n.indexOf(e)>=0&&r(t)}),$.each(pinegrow.getFrameworks(),function(n,i){if(t&&t.frameworks)t.frameworks.indexOf(i.key)>=0&&r(i);else if(i.default)r(i);else if(i.detect&&i.detect(e)){if(i.type&&a.indexOf(i.type)>=0)return!0;r(i),crsaQuickMessage(i.name+" detected.",2e3)}}),o(),this.frameworks_added=!0;var i=this.getProjectInfo();i&&i.breakpoints&&i.breakpoints.length&&(this.breakpoints=i.breakpoints,$("body").trigger("crsa-breakpoints-changed"))},this.findFrameworkOfType=function(e){for(var t=0;t<this.frameworks.length;t++)if(this.frameworks[t].type===e)return this.frameworks[t];return null},this.canAddFramework=function(e){if(e.allow_single_type&&e.type){var t=this.findFrameworkOfType(e.type);if(t)return!1}return!0},this.addFramework=function(e){var t=this.frameworks.indexOf(e);return 0>t?this.canAddFramework(e)?(this.frameworks.unshift(e),pinegrow.frameworksChanged(),!0):!1:!0},this.frameworksChanged=function(){o()},this.removeFramework=function(e){var t=this.frameworks.indexOf(e);t>=0&&(this.frameworks.splice(t,1),o(),$("body").trigger("crsa-frameworks-changed"))};var l=function(e,t){var a=e.length;if(a!=t.length)return!1;for(;a--;)if(e[a]!==t[a])return!1;return!0},c=function(a){t&&clearTimeout(t),t=setTimeout(function(){var n=getIframeBody(a.$iframe.get(0)),r=getIframeBody(e.$iframe.get(0)),i=n.innerHTML;i=removeCrsaClassesFromHtml(i).replace(/contenteditable="true"/g,""),r.innerHTML=i;var s=$.map(r.attributes,function(e){return e.name});$.each(s,function(e,t){$(r).removeAttr(t)}),$.each(n.attributes,function(e,t){$(r).attr(t.nodeName,t.nodeValue)}),e.readOnly||($.fn.crsa("buildTree",e.$iframe),e.treeRepaintOnShow=!0),t=null,l(e.breakpoints,a.breakpoints)||(e.setAllBreakpoints(a.breakpoints),$("body").trigger("crsa-breakpoints-changed")),e.autoSize(),e.setPageChanged(!0)},500)};this.onPageChanged=function(e){c(e)},this.setPageChanged=function(e,t){if(this.live_update&&this.save_parent&&(e=!1),this.changed!=e||t){this.changed=e;var a=this.$page.find(".page-changed");this.changed?a.show():a.hide()}},this.getMirroredPages=function(){for(var e=[],t=0;t<crsaPages.length;t++)crsaPages[t]!=this&&crsaPages[t].live_update==this&&e.push(crsaPages[t]);return e},this.elementWasSelected=function(e){if(this.scrollMode){var t=(new Date).getTime(),a=this.getMirroredPages();if(this.live_update&&a.push(this.live_update),a.length>0){var n=this.$iframe.get(0).contentDocument.querySelectorAll("*");if(n){for(var r=-1,i=e.get(0),s=0;s<n.length;s++)if(n[s]==i){r=s;break}if(r>=0)for(var o=0;o<a.length;o++){var l=a[o],c=l.$iframe.get(0).contentDocument.querySelectorAll("*");if(c&&c.length>r){var d=$(c[r]);scrollToElementInIframe(d,l.$iframe)}}}}{(new Date).getTime()-t}}},this.pageLoaded=function(){for(var e=this.getMirroredPages(),t=0;t<e.length;t++){var a=e[t];a.url!=this.url&&(a.rename(this.url),a.reload())}},this.hasCssChanges=function(){if(this.force_close)return!1;var e=getCrsaPageStylesForPage(this.$iframe),t=!1;return e&&$.each(e.stylesheets,function(e,a){return a.inline?!0:a.loaded?(t=t||a.changed,void 0):!0}),t},this.getBreakpointsFromCss=function(e){var t=getCrsaPageStylesForPage(this.$iframe),a=[],n=function(){for(var t=[],n=0;n<a.length;n++)a.indexOf(a[n]+1)>=0&&(a[n]=-1);for(var n=0;n<a.length;n++)a[n]>0&&t.indexOf(a[n])<0&&t.push(a[n]);e(t)};if(t){var r=0;$.each(t.stylesheets,function(e,t){r++,t.loaded?setTimeout(function(){a=a.concat(t.getBreakpoints()),r--,0==r&&n()},100):(t.ignore=!1,t.load(t.url,function(){a=a.concat(t.getBreakpoints()),t.ignore=!0,r--,0==r&&n()}))}),0==r&&n()}else n()},this.changeBreakpoint=function(t,a,n){if(t!=a){for(var r=0;r<this.breakpoints.length;r++)if(a==this.breakpoints[r])throw"Breakpoint "+a+" is already set.";for(var r=0;r<this.breakpoints.length;r++)t==this.breakpoints[r]&&(this.breakpoints[r]=a);this.setPageChanged(!0),d={};var i=getCrsaPageStylesForPage(this.$iframe),s=!1,o=function(){n(s)};if(i){var l=0;$.each(i.stylesheets,function(n,r){l++,r.loaded?setTimeout(function(){r.changeBreakpoint(t,a,function(t){l--,s=s||t,e.setPageChanged(!0),0==l&&o()})},40):(r.ignore=!1,r.load(r.url,function(){r.changeBreakpoint(t,a,function(t){l--,s=s||t,e.setPageChanged(!0),r.ignore=!t,0==l&&o()})}))}),0==l&&o()}else o()}},this.addBreakpoint=function(e){e=parseInt(e);for(var t=0;t<this.breakpoints.length;t++)if(e==this.breakpoints[t])throw"Breakpoint "+e+" is already set.";this.breakpoints.push(e),this.breakpoints.sort(function(e,t){return e-t}),this.setPageChanged(!0),d={}},this.removeBreakpoint=function(e){for(var t=[],a=0;a<this.breakpoints.length;a++)e!=this.breakpoints[a]&&t.push(this.breakpoints[a]);this.breakpoints=t,this.setPageChanged(!0),d={}},this.setAllBreakpoints=function(e){this.breakpoints=e,this.breakpoints.sort(function(e,t){return e-t}),d={}},this.showManageBreakpoints=function(){var t=function(t,a){var r=getUniqueId();if(t.data("popover-active"))return t.popover("destroy"),t.data("popover-active",null),void 0;{var i=function(e){setTimeout(function(){e.closest(".popover").remove()},750)};t.popover({html:!0,placement:"right",trigger:"manual",title:a?"Edit breakpoint":"Add new breakpoint",container:"body",content:'<form id="'+r+'"><form><input class="form-control" placeholder="width in px" style="margin-bottom:8px;"/><button class="ok btn">'+(a?"Set":"Add")+'</button><button class="closeit btn btn-link">Cancel</button></form>'}).on("shown.bs.popover",function(){var s=$("#"+r),o=s.find("input").focus(),l=s.find("button.ok"),c=s.find("button.closeit");a&&o.val(a);var d=function(){var r=$.trim(o.val());if(r.length>0){r=r.replace(/[^0-9]/g,"");try{a?(t&&t.html("Please wait...").addClass("disabled"),e.undoStack.add("Change breakpoint"),e.changeBreakpoint(a,r,function(e){t.html("Edit").removeClass("disabled"),e&&(setTimeout(function(){crsaQuickMessage("Stylesheets were updated!",3e3)},250),setTimeout(function(){$("body").trigger("crsa-stylesheets-changed")},50))})):e.addBreakpoint(r),didMakeChange(e.$iframe),t.popover("hide"),i(s),n(),$("body").trigger("crsa-breakpoints-changed")}catch(l){alert(l)}}};l.on("click",function(e){e.preventDefault(),d()}),s.on("submit",function(e){e.preventDefault(),d()}),c.on("click",function(e){t.popover("hide"),e.preventDefault(),i(s)})}).on("hidden.bs.popover",function(){setTimeout(function(){t.popover("destroy").data("popover-active",null)},10)})}t.popover("show").data("popover-active",!0)},a=$("<ul/>"),n=function(){a.html("");for(var r=0;r<e.breakpoints.length;r++){var i=$('<a href="#" class="btn btn-sm btn-link">Edit</a>'),s=$('<a href="#" class="btn btn-sm btn-link">Delete</a>');$("<li></li>").html(e.breakpoints[r]+"px").appendTo(a).append(i).append(s).data("breakpoint",e.breakpoints[r]),i.on("click",function(e){var a=$(e.delegateTarget).closest("li");e.preventDefault(),t($(e.delegateTarget),a.data("breakpoint"))}),s.on("click",function(t){var a=$(t.delegateTarget).closest("li");t.preventDefault(),confirm("Are you sure? Existing CSS rules will not be affected.")&&(e.removeBreakpoint(a.data("breakpoint")),n(),$("body").trigger("crsa-breakpoints-changed"),didMakeChange(e.$iframe))})}};n();var r=a,i=$('<div class="manager"><p>Note: At the moment only breakpoints in <b>px</b> unit are supported.</p></div>').append(r);$('<a href="#" class="btn btn-link add">Add breakpoint...</a>').appendTo(i).on("click",function(e){e.preventDefault(),t($(this))}),$('<a href="#" class="btn btn-link add">Get from stylesheets</a>').appendTo(i).on("click",function(t){t.preventDefault();var a=$(t.delegateTarget);a.html("Please wait...").addClass("disabled"),e.getBreakpointsFromCss(function(t){if(t.length){var r=function(){e.setAllBreakpoints(t),didMakeChange(e.$iframe),crsaQuickMessage("Done!",2e3)};if(e.breakpoints.length){var i="Breakpoints ["+t.join(", ")+"] were found in CSS. Do you want to use them instead of current breakpoints? This can't be undone.";confirm(i)&&r()}else r()}else crsaQuickMessage("No breakpoints found!",2e3);n(),$("body").trigger("crsa-breakpoints-changed"),a.html("Get from stylesheets").removeClass("disabled")})}),$('<a href="http://docs.pinegrow.com/solution/articles/1000067353-creating-responsive" target="_blank" class="btn btn-link add external">Help</a>').appendTo(i),crsaHandleExternalLinks(i);var s=function(){var t=i.find(".meta-add");t.length||(t=$('<div class="meta-add well" style="margin-top:12px;"></div>').appendTo(i));var a=e.get$Html().find("head"),n=a.find('meta[name="viewport"]');if(n.length)t.hide();else{t.html('<p>Document needs <code>&lt;meta name=&quot;viewport&quot; ... &gt;</code> directive to enable responsive behaviour on mobile devices. <a href="#" class="">Add it!</a></p>');var r=t.find("a");t.show(),r.on("click",function(t){t.preventDefault(),e.undoStack.add("Meta viewport directive added"),a.append('<meta name="viewport" content="width=device-width, initial-scale=1.0">'),e.setPageChanged(!0),didMakeChange(e.$iframe,a),s(),crsaQuickMessage("Viewport declaration added!",2e3)})}};s();var o=makeModalDialog("Manage breakpoints","Close",null,i);o.removeAttr("tabindex"),o.find(".modal-dialog").css("width","500px")};var d={};this.describeMediaQuery=function(t){var a=null;if(t in d)return d[t];var n=t.indexOf("(");n>=0?(a=t.substr(n),t.indexOf("only")>=0&&(a=a.replace("only ","")),$.each(["screen","print"],function(e,n){t.indexOf(n)>=0&&(type=n,a=a.replace(n,""))})):a=t,a=a.replace(/\s/g,"");var r=null;if(e.breakpoints.length)for(var i=0;i<e.breakpoints.length;i++){var s=e.breakpoints[i],o="(max-width:"+(s-1)+"px)";if(a==o){r='<span class="line"></span><span class="excluding">'+s+"</span>";break}if(o="(min-width:"+s+"px)",a==o){r='<span class="including">'+s+'</span><span class="line"></span>';break}if(i<e.breakpoints.length-1){var l=e.breakpoints[i+1];if(o="(min-width:"+s+"px)and(max-width:"+(l-1)+"px)",a==o){r='<span class="including">'+s+'</span><span class="line"></span><span class="excluding">'+l+"</span>";break}}}return d[t]=r?r:t,r?r:t},this.showMediaQueryHelper=function(t){var a=t.offset(),n=(a.left>$(window).width()/2?"left":"right",getUniqueId());if(t.data("tool-active"))return t.data("tool-active",null),void 0;var r=function(){S.hide(),t.data("tool-active",null),L.closed=!0,setTimeout(function(){S.remove()},500)},i=$.trim(t.val()),s="",o=localStorage.mediaToolOnly?!0:!1,l=localStorage.mediaToolType?localStorage.mediaToolType:null,c=!0;if(i){var d=i.indexOf("(");d>=0?(s=i.substr(d),i.indexOf("only")>=0&&(o=!0,s=s.replace("only ","")),$.each(["screen","print"],function(e,t){i.indexOf(t)>=0&&(l=t,s=s.replace(t,""))}),s=s.replace(/\s\s+/g," "),c=!1):s=i}else c=!1;var f=!1,p="";if(e.breakpoints.length)for(var u=0;u<e.breakpoints.length;u++){var h=e.breakpoints[u],g="(max-width:"+(h-1)+"px)";if(p+='<li class="media-query" data-media="'+g+'"><i class="fa fa-check"></i><span class="line"></span><span class="excluding">'+h+"</span><small>smaller than "+h+" px</small></li>",g="(min-width:"+h+"px)",p+='<li class="media-query" data-media="'+g+'"><i class="fa fa-check"></i><span class="including">'+h+'</span><span class="line"></span><small>'+h+" px and up</small></li>",u<e.breakpoints.length-1){var m=e.breakpoints[u+1];g="(min-width:"+h+"px) and (max-width:"+(m-1)+"px)",p+='<li class="media-query submedia-last" data-media="'+g+'"><i class="fa fa-check"></i><span class="including">'+h+'</span><span class="line"></span><span class="excluding">'+m+"</span><small>from "+h+" px to "+(m-1)+" px</small></li>"}}else p+="<li>No breakpoints are defined. Use &quot;Manage breakpoints&quot; to define them.</li>";var v=null,k=function(e){v&&clearTimeout(v),v=setTimeout(function(){e.trigger("change"),v=null},50)},w='<form role="form" class="form-inline">            <div class="form-group" style="margin-right:10px;">            <label class="control-label sr-only" for="formInput1">Field label</label>            <select id="formInput1" class="form-control input-sm">            <option></option>            <option>screen</option>            <option>print</option>        </select>        </div>            <div class="checkbox">                <label class="control-label">                    <input type="checkbox"> Ignore in old browsers</label>                </div>            </form>',b=$('<div id="'+n+'" class="media-tool"><ul class="media-list">'+p+"</ul>"+w+"</div>"),y=$("body"),S=makeDialog("Select media query","Cancel","Ok",b).css("width","400px");y.append(S),S.find(".modal-footer").prepend('<a href="#" class="pull-left manage btn btn-link">Manage breakpoints...</a>').css("margin-top","0px"),S.find(".modal-body").css("padding-bottom","0px"),S.on("keydown",function(e){27==e.which&&(S.find("button.cancel").trigger("click"),e.preventDefault())});var h,P,T=t.offset(),C=y.width(),F=y.height();h=T.left<C/2?T.left+t.width()+35:T.left-S.width()-10,P=T.top-S.height()/2,h=localStorage.mediaToolX?parseInt(localStorage.mediaToolX):h,P=localStorage.mediaToolY?parseInt(localStorage.mediaToolY):P,10>P&&(P=10),P+S.height()>F&&(P=F-10-S.height()),10>h&&(h=10),h+S.width()>C&&(h=C-10-S.width()),S.css("top",P+"px").css("left",h+"px"),S.draggable({handle:".modal-header"}).on("dragstart",function(){$.fn.crsapages("showOverlays")}).on("dragstop",function(){$.fn.crsapages("showOverlays",!0);var e=S.offset();localStorage.mediaToolX=e.left,localStorage.mediaToolY=e.top});var A=$("#"+n),x=A.find("ul"),D=S.find("button.ok"),M=S.find("button.close,button.cancel"),O=A.find("select"),I=A.find('input[type="checkbox"]');c?(O.attr("disabled","disabled"),I.attr("disabled","disabled")):(O.val(l),o&&I.attr("checked","checked"),O.on("change",function(){U(s),localStorage.mediaToolType=O.val()}),I.on("change",function(){U(s),localStorage.mediaToolOnly=I.is(":checked")?"1":"0"}));var U=function(e){var a=O.val(),n=!1;a&&(e.length?(e=a+" and "+e,n=!0):e=a),I.is(":checked")&&(e="only "+(n?"":"")+e),t.val(e),k(t)},_=s.replace(/\s/g,"");x.find("li").each(function(t,a){var n=$(a),r=n.attr("data-media");if(r){r.replace(/\s/g,"")==_&&n.addClass("media-current");var i=e.getWindow();i&&i.matchMedia(r).matches&&n.addClass("media-match")}}),x.find("i.fa-check:visible").tooltip({container:"body",title:"Matches current window size ("+e.deviceWidth+"px)."}),x.find("li").on("mouseover",function(e){if(!f){var t=$(e.delegateTarget),a=t.attr("data-media");a&&U(a)}}).on("mouseout",function(e){if(!f){var a=$(e.delegateTarget).attr("data-media");a&&(c?(t.val(i),k(t)):U(s))}}).on("click",function(e){f=!0,e.preventDefault();var t=$(e.delegateTarget),a=t.attr("data-media");a&&(x.find("li.media-current").removeClass("media-current"),t.addClass("media-current"),U(a),r(A))}),D.on("click",function(e){e.preventDefault(),f=!0,r(A)}),M.on("click",function(e){f=!0,t.val(i),k(t),e.preventDefault(),r(A)}),S.find(".manage").on("click",function(a){f=!0,t.val(i),k(t),a.preventDefault(),r(A),e.showManageBreakpoints()}),t.data("tool-active",!0);var L={closed:!1,close:function(){r()}};return L},this.getPageInfo=function(){if(!e.localFile||!isApp())return null;var t=require("fs"),a=crsaGetFileDir(e.localFile)+"pinegrow.json",n={files:{}};try{var r=t.readFileSync(a,{encoding:"utf8"});return n=JSON.parse(r),n.files&&n.files[e.name]?n.files[e.name]:null}catch(i){}},this.getProjectInfo=function(){if(!e.localFile||!isApp())return null;var t=require("fs"),a=crsaGetFileDir(e.localFile)+"pinegrow.json",n={files:{}};try{var r=t.readFileSync(a,{encoding:"utf8"});return n=JSON.parse(r)}catch(i){}},this.getDocument=function(){return this.$iframe.get(0).contentDocument},this.getWindow=function(){return this.$iframe.get(0).contentWindow},this.getBody=function(){return getIframeBody(this.$iframe.get(0))},this.get$Html=function(){var e=this.getDocument();return $(e).find("> html")},this.getData=function(e,t){try{var a=getUniqueId("crsa");e.attr("data-tmp",a);var n=this.$iframe[0].contentWindow.$,r=this.$iframe.contents().find('[data-tmp="'+a+'"]');return e.removeAttr("data-tmp"),r.length>0?n.data(r.get(0),t):null}catch(i){}return null},this.save=function(t,a,n,r,i,s){if(isApp()){"undefined"==typeof i&&(i=!0);var o=this.getSource(!0),l=require("fs"),c=require("path");if(this.localFile&&!r)try{if(this.live_update&&this.save_parent)return t&&t(),showAlert("The page was not saved because it is a mirrored page. You should save the parent page "+this.live_update.name+" instead.","Page was not saved"),void 0;var d=crsaGetFileDir(this.localFile);this.crsaProjectTemplate&&i&&this.crsaProjectTemplate.copyRequiredFilesTo(d);var f=[],p=function(a){var r=crsaMakeUrlFromFile(e.localFile);r!=e.url&&e.rename(r),t&&t(a);var i="";if(!u&&s&&(i+=u?"</ul>":"</ul><p>Images, scripts and other resources were not saved.</p><p>If you want to save all changes it is recommended to first save the whole webpage to your computer (Save As Complete page in your browser) and then opening it in Pinegrow.</p>"),f.length>0){i+=u?"<p>The following stylesheets were not saved because they have syntax errors or are located on remote servers:</p><ul>":"<p>The following stylesheets were not saved because they have syntax errors or their paths would place them outside of the folder selected for saving the HTML file:</p><ul>";for(var o=0;o<f.length;o++)i+="<li>"+f[o].url+" - "+("syntax"==f[o].error?"Syntax error (check CSS panel for more)":"Invalid url")+"</li>"}i.length>0?showAlert(i,"Some files were not saved"):crsaQuickMessage(n?e.name+" was saved.":e.name+" (HTML only) was saved.")},u=crsaIsFileUrl(this.url);if(a){crsaWriteFileWithBackup(l,this.localFile,o,"utf8"),this.setPageChanged(!1);var h=$(getIframeBody(this.$iframe.get(0))),g=(h.find("[data-pg-component]").each(function(t,a){var n=$(a),r=n.data("pg-component");if(r){var i=n.get(0).outerHTML;i=removeCrsaClassesFromHtml(i),i=html_beautify(i);var s=crsaGetFileDir(e.localFile)+"components"+c.sep+r+".html";crsaWriteFileWithBackup(l,s,i,"utf8")}}),crsaGetFileDir(e.localFile)+"pinegrow.json"),m={files:{}};try{var v=l.readFileSync(g,{encoding:"utf8"});m=JSON.parse(v)}catch(k){}"files"in m||(m.files={});for(var w={frameworks:[]},b=0;b<e.frameworks.length;b++)w.frameworks.push(e.frameworks[b].key);m.files[e.name]=w,m.breakpoints=e.breakpoints;var v=JSON.stringify(m);crsaWriteFileWithBackup(l,g,v,"utf8")}if(n){var y=getCrsaPageStylesForPage(this.$iframe),S=0;$.each(y.getAllCrsaStylesheets(),function(t,a){if(a.inline)return!0;if(!a.loaded)return!0;var n=crsaMakeLinkRelativeTo(a.url,crsaMakeUrlAbsolute(e.url));n=crsaRemoveUrlParameters(n);var r;a.genGetError()?f.push({url:a.url,error:"syntax"}):n.indexOf("://")>=0&&!crsaIsFileUrl(n)||!u&&n.indexOf("..")>=0?a.changed&&f.push({url:a.url,error:"url"}):(r=n.indexOf("://")>=0?crsaMakeFileFromUrl(n):d+n,S++,a.save(r,function(e){if(e)throw e;S--,0==S&&p()},l))}),0==S&&p()}else p()}catch(k){t&&t(k),showAlert("Could not save file: "+k.message,"Error")}else crsaChooseFile(function(r,i){var s=function(){e.localFile=i,e.save_parent=!1,e.save(function(){e.rename(r),e.reload(),t()},a,n,!1,!0,!0)};r.indexOf(".htm")<0?showAlert("Do you want to use the file without the <b>.html</b> extension? Some browsers will not recognize it.","No .html extension","Cancel","Use it",null,function(){s()}):s()},this.name)}else{var P=new CrsaBrowserStorage;if(a&&(P.save(this.url,o),this.setPageChanged(!1)),n){var y=getCrsaPageStylesForPage(this.$iframe),S=0;$.each(y.getAllCrsaStylesheets(),function(e,t){if(t.inline)return!0;var a=t.getLessSource();P.save(t.url,a),t.changed=!1})}t&&t()}},this.saveChangedFrameworks=function(e){for(var t=0;t<this.frameworks.length;t++){var a=this.frameworks[t];!function(t){t.user_lib&&t.changed&&(t.localFile?t.save(t.localFile,function(){crsaQuickMessage("Library "+t.name+" saved."),pinegrow.frameworksChanged(),e&&e()}):crsaChooseFile(function(a,n){t.save(n,function(){crsaQuickMessage("Library "+t.name+" saved."),pinegrow.frameworksChanged(),e&&e()})},t.getFileName()))}(a)}},this.rename=function(e){this.url=e,this.name=getPageName(e),this.updateNameDisplay()},this.updateNameDisplay=function(){this.$page.find(".name").html(this.name),this.$page.find("a.crsa-preview").attr("href",this.url)},this.duplicate=function(){var e=new CrsaPage;e.url=this.url,e.scrollMode=this.scrollMode,e.frameworks=this.frameworks.slice(0),e.breakpoints=this.breakpoints.slice(0);for(var t=[],a=0;a<crsaPages.length;a++)t.push(crsaPages[a].name);return e.name=crsaDuplicateName(this.name,this.localFile,t),this.localFile&&(e.localFile=crsaGetFileDir(this.localFile)+e.name),e},this.loadingStart=function(t){$.fn.crsapages("showLoadingOverlay",this.$page,!1,function(){t&&t(e)})},this.loadingDone=function(){$.fn.crsapages("showLoadingOverlay",this.$page,!0)},this.reload=function(){$(".canvas").trigger("crsa-page-reload",this)},this.refresh=function(){$(".canvas").trigger("crsa-page-refresh",this)},this.autoSize=function(){$.fn.crsapages("autoSizePage",this.$iframe,this.scrollMode)},this.setLiveUpdate=function(e){$("body");if(e){this.$page.addClass("mirrored");var t=e.live_update?e.live_update:e;this.live_update=t}else this.live_update,this.$page.removeClass("mirrored"),this.live_update=null},this.callFrameworkHandler=function(t,a,n,r){for(var i=0;i<e.frameworks.length;i++){var s=e.frameworks[i];t in s&&s[t]&&s[t](e,a,n,r)}},this.getSource=function(t,a){var n,r=function(t){var a="<html";return $.each(getIframeHtmlElement(e.$iframe.get(0)).attributes,function(e,t){a+=" "+t.nodeName+'="'+t.nodeValue+'"'}),a+=">","<!DOCTYPE html>\n"+a+"\n"+t+"\n</html>"};return this.sourceNode&&(n=this.sourceNode.toString(null,!0,!1)),n||this.doWithoutCrsaStyles(function(){var t=e.getDocument(),a=$(t).find("> html").clone(!0);e.callFrameworkHandler("on_get_source",a),n=a.length>0?a[0].innerHTML:"",n=n.replace(/(<[^>]*)\s*contenteditable="true"/gi,"$1"),n=n.replace(/(<[^>]*)\s*style=""/gi,"$1"),n=removeCrsaClassesFromHtml(n)}),t?(n=r(n),a||(n=html_beautify(n)),this.template.getTemplateSource(n)):n},this.setSource=function(t,a,n){setPageSource(this.$iframe,t,function(){e.addCrsaStyles(),a&&a()},n)},this.runScripts=function(e){return e&&e(),void 0},this.addCrsaStyles=function(){var e={css:'.crsa-highlighted {            box-shadow: 0 0 10px rgba(0, 255, 0, 0.9) !important;        }        .crsa-selected {            box-shadow: 0 0 0px 1px rgba(0, 180, 255, 1) !important;        }        .crsa-edit {            cursor: default;        }        *[contenteditable="true"] {            outline: yellow dashed 2px !important;        }        .crsa-disable-hover {            pointer-events: none;        }        '};"1"==pinegrow.getSetting("show-placeholders","1")&&(e.css+=".pg-empty-placeholder {            min-height: 100px;            box-shadow: 0 0 0 1px rgba(0,0,0,0.15);            background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAADklEQVQIW2NgQAXGZHAAGioAza6+Hk0AAAAASUVORK5CYII=);        }        ",e.css+="*.pg-no-placeholder:empty {            min-height: inherit;        }        "),e.css+="        .crsa-placed {            opacity: 0.5 !important;        }        html.crsa-stop-animations * {            -webkit-transition-property: none !important;            transition-property: none !important;            -webkit-transform: none !important;            transform: none !important;            -webkit-animation: none !important;            animation: none !important;        }",this.callFrameworkHandler("on_set_inline_style",e);var t='<style id="'+a+'">'+e.css+"</style>",n=$(getIframeHead(this.$iframe.get(0)));0==n.find("#"+a).length&&n.append(t)},this.stopAnimations=function(){var e=$(getIframeHtmlElement(this.$iframe.get(0)));e.addClass("crsa-stop-animations"),this.animationsStopped=!0},this.startAnimations=function(){var e=$(getIframeHtmlElement(this.$iframe.get(0)));e.removeClass("crsa-stop-animations"),this.animationsStopped=!1},this.hasStoppedAnimations=function(){var e=$(getIframeHtmlElement(this.$iframe.get(0)));return e.hasClass("crsa-stop-animations")},this.doWithoutCrsaStyles=function(e){var t=$(getIframeHead(this.$iframe.get(0))),n=t.find("#"+a);n.detach(),e(),t.append(n)},this.getCompatibleUrl=function(e){return crsaIsFileUrl(e)&&pinegrow.sourceParser&&(e=pinegrow.httpServer.makeUrl(e)),e}},getCrsaPageForIframe=function(e){return e?e.data("crsa-page"):null},getPageName=function(e){var t=e.split(/[\\\/]/).pop();0==t.length&&(t="index.html");var a=t.split("?");return a.length>1?a[0]:t};$.fn.crsapages=function(e){return methods[e]?methods[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?($.error("Method "+e+" does not exist on jQuery.crsacss"),void 0):methods.init.apply(this,arguments)};var options,pages,crsaPages=[],currentZoom=1,centerLeft=300,centerRight=300,fitZoom=!1,$body=$("body"),$empty,customPageActions=[],methods={init:function(e){if(options=$.extend({},$.fn.crsapages.defaults,e),$empty=$(".empty-canvas"),updatePagesList(this),isApp()){var t=require("nw.gui");t.Window.get().on("document-start",function(e){if(e){var t=getCrsaPageForIframe($(e));t&&$(e.contentDocument).on("DOMContentLoaded",function(){$.fn.crsa("buildTree",$(e))})}})}},getAllPages:function(){return crsaPages},clearUndoSetFlag:function(){$.each(crsaPages,function(e,t){t.undoSetFlag=!1})},saveAll:function(){var e=[];$.each(crsaPages,function(t,a){if(a.saveChangedFrameworks(),a.live_update&&a.save_parent)return!0;if(a.changed||a.hasCssChanges()){var n=!1;a.crsaProjectTemplate&&e.indexOf(a.crsaProjectTemplate)<0&&(n=!0,e.push(a.crsaProjectTemplate)),a.save(function(){},!0,!0,!1,n)}})},downloadAllPages:function(){crsaLoadScript("lib/jszip/jszip.js",function(){var e=$('<p><i class="fa fa-refresh fa-spin"></i> Preparing the Zip file. Please wait...</p>');showAlert(e,"Download project");var t=new JSZip,a=function(){e.html('<a download="PinegrowProject.zip">Download the project Zip file</a></p><p>The zip file contains .html sources of all open pages, stylesheets in .css and .less format as well as Bootstrap files.'),$a=e.find("a"),$a.attr("href",window.URL.createObjectURL(t.generate({type:"blob"})))},n=function(){r?r.copyRequiredFilesToZip(t,a):a()},r=null;
$.each(crsaPages,function(e,a){t.file(a.name,a.getSource(!0)),a.crsaProjectTemplate&&(r=a.crsaProjectTemplate),a.setPageChanged(!1)});var i=$.fn.crsacss("getAllCrsaStylesheets"),s=0;$.each(i,function(e,a){s++;var r=a.getLessSource();a.getCssSource(function(e){setTimeout(function(){t.file(a.name,e);var i=a.name.replace(/\.css$/i,".less");i==a.name&&(i+=".less"),t.file(i,r),s--,0==s&&n()},10)})}),0==s&&n()})},addCustomPageAction:function(e,t){customPageActions.push({name:e,func:t})},addPage:function(e,t,a,n){{var r=getPageName(e),i=this,s=$("<div/>",{"class":"page"}).html('<span class="name">'+r+'</span><span class="page-changed">*</span><div class="content content-size-tablet-landscape"><iframe class="content-iframe" frameborder="0"></iframe></div>').appendTo(this);s.find("div.content")}$('<i class="fa fa-times crsa-close-icon"></i>').appendTo(s).on("click",function(e){e.preventDefault(),s.find(".crsa-close").trigger("click")});var o;a?o=a:(o=new CrsaPage,o.name=r,o.url=e),o.loading=!0,o.$page=s,o.$iframe=s.find("iframe"),o.setPageChanged(!1,!0);var l=$("<div/>",{"class":"btn-group"}).html('<button type="button" class="btn btn-link btn-xs dropdown-toggle" data-toggle="dropdown">Page </button>                <ul class="dropdown-menu" role="menu">                </ul>').insertAfter(s.find(".page-changed")),c=function(){var e=l.find("ul").html("");if($.each(options.sizes,function(t,a){$("<li/>").html('<a href="#">'+t+" / "+a+" px</a>").appendTo(e).data("device-width",a)}),$('<li class="divider"></li>').appendTo(e),$('<li class="dropdown-header">Responsive breakpoints</li>').appendTo(e),o.breakpoints.length>0){$("<li/>").html('<a href="#">&lt; '+o.breakpoints[0]+" px</a>").appendTo(e).data("device-width",Math.ceil(.75*o.breakpoints[0]));for(var t=0;t<o.breakpoints.length;t++)$("<li/>").html('<a href="#">'+o.breakpoints[t]+" px</a>").appendTo(e).data("device-width",o.breakpoints[t]);$("<li/>").html('<a href="#">&gt; '+o.breakpoints[o.breakpoints.length-1]+" px</a>").appendTo(e).data("device-width",Math.ceil(1.25*o.breakpoints[o.breakpoints.length-1]))}$("<li/>").html('<a href="#">Manage breakpoints...</a>').appendTo(e).on("click",function(e){e.preventDefault(),o.showManageBreakpoints()}),l.find(".btn").button(),l.find("a").on("click",function(e){e.preventDefault();var t=$(e.delegateTarget).closest("li").data("device-width");t&&(o.deviceWidth=parseInt(t),f(),methods.refresh(),$("body").trigger("crsa-window-changed",o))})};c(),$("body").on("crsa-breakpoints-changed",function(){c()});var d=function(e){return o.deviceWidth=parseInt(e),void 0};d(o.deviceWidth);var f=function(){var e=!1;$.each(options.sizes,function(t,a){return o.deviceWidth==a?(l.find(">button").html(a+'px <span class="caret"></span>'),e=!0,!1):void 0}),e||l.find(">button").html(o.deviceWidth+'px <span class="caret"></span>')};f();var p=$("<div/>",{"class":"btn-group"}).html('<button type="button" class="btn btn-link btn-xs dropdown-toggle" data-toggle="dropdown">Page <span class="caret"></span></button>                <ul class="dropdown-menu with-checkboxes" role="menu">                </ul>').insertAfter(l),u=p.find("ul");$("<li/>").html('<a href="#" class="crsa-view">Open another view</a>').appendTo(u),$("<li/>").html('<a href="#" class="crsa-clone">Duplicate</a>').appendTo(u),$("<li/>").html('<a href="#" class="crsa-mirror">Duplicate &amp; Mirror</a>').appendTo(u);var h=$("<li/>").html('<a href="#" class="crsa-reload">Reload</a>').appendTo(u);crsaAddKbd(h.find("a"),"CMD R"),isApp()||$("<li/>").html('<a href="#" class="crsa-rename">Rename</a>').appendTo(u),$("<li/>").html('<a href="#" class="crsa-manage-ss">Manage stylesheets...</a>').appendTo(u),$("<li/>").html('<a href="#" class="crsa-manage-fm">Manage frameworks...</a>').appendTo(u);var g=$("<li/>").html('<a href="#" class="crsa-code">Edit code</a>').appendTo(u);if(crsaAddKbd(g.find("a"),"CMD E"),isApp()){$("<li/>").html('<a href="#" target="_blank" class="crsa-preview"><i class="fa fa-link"></i>Open in browser</a>').appendTo(u);var m=$("<li/>").html('<a href="#" target="_blank" class="crsa-save-preview">Save &amp; Open in browser</a>').appendTo(u);u.find("a.crsa-preview i").on("click",function(e){if(isApp()){var t=require("nw.gui"),a=t.Clipboard.get(),n=$(e.delegateTarget).closest("a");a.set(n.attr("href"),"text"),n.tooltip({container:"body",placement:"left",title:"Link to the page was copied to the clipboard.",trigger:"manual"}),n.tooltip("show"),setTimeout(function(){n.tooltip("destroy")},2500),e.stopPropagation(),e.preventDefault()}});var v=function(e){var t=require("nw.gui");e=crsaMakeUrlAbsolute(e),-10==e.indexOf("file://")?(e=e.replace("file://",""),t.Shell.openItem(e)):t.Shell.openExternal(e)};u.find("a.crsa-preview").attr("href",e).on("click",function(e){isApp()&&(v($(e.delegateTarget).attr("href")),e.preventDefault())}),crsaAddKbd(m.find("a"),"CMD B"),u.find("a.crsa-save-preview").attr("href",e).on("click",function(e){if(e.preventDefault(),isApp()){var t=pinegrow.getSelectedPage();t.live_update&&t.save_parent&&(t=t.live_update),t.save(function(){v(t.url)},!0,!0)}})}customPageActions&&customPageActions.length>0&&($("<li/>",{"class":"divider"}).appendTo(u),$.each(customPageActions,function(e,t){!function(e){$("<li/>").html('<a href="#" class="crsa-custom-action">'+e.name+"</a>").appendTo(u).on("click",function(t){t.preventDefault(),e.func&&e.func(o)})}(t)})),$("<li/>",{"class":"divider"}).appendTo(u),$("<li/>").html('<a href="#" class="crsa-page-scroll"><i class="fa fa-check"></i>Scrollbars</a>').appendTo(u),$("<li/>").html('<a href="#" class="crsa-page-no-anim"><i class="fa fa-check"></i>Disable CSS Animations</a>').appendTo(u),$("<li/>",{"class":"divider"}).appendTo(u),$("<li/>").html('<a href="#" class="crsa-close">Close</a>').appendTo(u),$("<li/>").html('<a href="#" class="crsa-close-leave-css">Close HTML, keep CSS</a>').appendTo(u),p.find(".btn").button(),isApp()&&o.$iframe.attr("nwdisable","nwdisable").attr("nwfaketop","nwfaketop"),crsaPages.push(o),o.$iframe.data("crsa-page",o),methods.reloadPage(o,function(e,a){t&&t(e,a)},n),s.find("span.name").html(o.name),s.find(".crsa-code").on("click",function(e){$("body").crsa("editCode",s.find("iframe")),e.preventDefault()});var k=s.find(".crsa-page-scroll").on("click",function(e){o.scrollMode=!o.scrollMode,b($(e.delegateTarget),o.scrollMode),o.autoSize(),e.preventDefault()}),w=s.find(".crsa-page-no-anim").on("click",function(e){o.hasStoppedAnimations()?o.startAnimations():o.stopAnimations(),b($(e.delegateTarget),o.hasStoppedAnimations()),o.autoSize(),e.preventDefault()}),b=function(e,t){var a=e.find("i");t?a.css("opacity",1):a.css("opacity",0)};b(k,o.scrollMode),b(w,o.animationsStopped);var y=function(e){var t=s.find("iframe");i.trigger("crsa-page-closed",o);var a=getCrsaPageStylesForPage(t);a&&!e&&a.removeAllExclusiveSheets();var n=crsaPages.indexOf(o);n>=0&&crsaPages.splice(n,1),o.$iframe.off(".crsa").attr("src","about:blank");for(var r=0;r<crsaPages.length;r++)crsaPages[r].live_update==o&&crsaPages[r].setLiveUpdate(null);o.$iframe.remove(),o.$iframe=null,o.$page=null,s.remove(),updatePagesList(i),methods.refresh(),$("body").trigger("crsa-stylesheets-changed")},S="This page has unsaved changed. Are you sure you want to close it?",P="Stylesheets attached to this page have unsaved changes. Are you sure you want to proceed?";return s.find(".crsa-close").on("click",function(e){var t=null;o.hasCssChanges()&&(t=P),o.changed&&!o.force_close&&(t=S),t?showAlert(t,"Page has unsaved changes","Don't close","Close",null,function(){y()}):y(),e.preventDefault()}),s.find(".crsa-close-leave-css").on("click",function(e){var t=null;o.changed&&(t=S),t?showAlert(t,"Page has unsaved changes","Don't close","Close",null,function(){y(!0)}):y(!0),e.preventDefault()}),s.find(".crsa-manage-ss").on("click",function(e){var t=s.find("iframe");$.fn.crsa("setSelectedPage",t),$.fn.crsacss("showStylesheetsManager"),e.preventDefault()}),s.find(".crsa-manage-fm").on("click",function(e){$.fn.crsacss("showFrameworkManager",o),e.preventDefault()}),s.find(".crsa-clone").on("click",function(e){i.trigger("crsa-page-clone",o),e.preventDefault()}),s.find(".crsa-view").on("click",function(e){i.trigger("crsa-page-view",o),e.preventDefault()}),s.find(".crsa-mirror").on("click",function(e){i.trigger("crsa-page-mirror",o),e.preventDefault()}),s.find(".crsa-reload").on("click",function(e){i.trigger("crsa-page-reload",o),e.preventDefault()}),s.find(".crsa-refresh").on("click",function(e){i.trigger("crsa-page-refresh",o),e.preventDefault()}),s.find(".crsa-rename").on("click",function(e){i.trigger("crsa-page-rename",o),e.preventDefault()}),s.find(".crsa-preview").on("click",function(){}),updatePagesList(this),methods.refresh(),this},checkIfPageExists:function(e,t){if(isApp()&&crsaIsFileUrl(e)){var a=crsaMakeFileFromUrl(e);console.log("Checking file "+a),"file"==crsaIsFileOrDir(a)?(console.log("File "+a+" found"),t(!0)):(console.log("File "+a+" not found."),t(!1))}else $.ajax({url:e,data:null,dataType:"html"}).done(function(){t(!0)}).fail(function(){t(!1)})},reloadPage:function(e,t,a){e.loadingStart(a),methods.checkIfPageExists(e.url,function(a){e.$iframe.off("load.crsa").on("load.crsa",function(n){if(console.log("iframe load"),a){if(isApp()&&crsaIsFileUrl(e.url)){var r=require("fs"),i=crsaMakeFileFromUrl(e.url);try{var s=r.readFileSync(i,{encoding:"utf8"});e.template.detect(s)&&e.setSource(e.template.getHtml(),null,!0)}catch(o){}}}else e.setSource('<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body><p>New page</p></body>',null,!1);var l=!1;e.load_source&&(l=!0,e.setSource(e.load_source,null,!0),e.load_source=null,e.runScripts(function(){e.callFrameworkHandler("on_page_loaded"),$.fn.crsa("updateIfNeeded")})),e.loaded=!0,e.setPageChanged(!1);var c=e.$iframe.get(0).contentDocument.location.href;c=e.getPageUrlFromLoadedUrl(c),c!=e.url&&(e.rename(c),e.pageLoaded()),t&&t($(n.delegateTarget),e),e.addCrsaStyles(),l||e.callFrameworkHandler("on_page_loaded"),setTimeout(function(){methods.autoSizePage(e.$iframe,e.scrollMode)},1),e.animationsStopped?(e.stopAnimations(),crsaQuickMessage("CSS Animations stopped.",2e3)):(e.startAnimations(),crsaQuickMessage("CSS Animations resumed.",2e3)),e.$iframe.get(0).contentWindow.onbeforeunload=function(){return e.allowReload||!crsaGetCustomLogic().warnOnUnloadPage?null:"You will not be able to continue editing this page if you navigate away from it."},e.allowReload=!1,$(e.getDocument()).off("click.crsa").on("click.crsa",function(){$("body").trigger("click")})});var n=e.url+(e.url.indexOf("?")>=0?"&pgedit=1":"?pgedit=1");n=e.getCompatibleUrl(n),e.allowReload=!0,console.log("Loading "+n),e.$iframe.attr("src",n)})},showOverlays:function(e){pages.each(function(t,a){var n=$(a),r=n.find(".content-iframe"),i=n.find(".content"),s=n.find(".iframe-overlay");e?s.remove():0==s.length&&(s=$("<div/>",{"class":"iframe-overlay"}).appendTo(i).data("iframe_element",r).css("top",r.position().top+"px"))})},showLoadingOverlay:function(e,t,a){var n=e.find(".content-iframe"),r=e.find(".content"),i=e.find(".iframe-loading-overlay");t?i.remove():0==i.length&&(i=$("<div/>",{"class":"iframe-loading-overlay"}).html('<div><i class="fa fa-refresh fa-spin"></i>Loading, please wait...<p><a href="#">I don\'t want to wait</a></p></div>').appendTo(r).css("top",n.position().top+"px"),i.find("a").on("click",function(t){t.preventDefault(),methods.showLoadingOverlay(e,!0),a&&a()}))},getZoom:function(){return currentZoom},refresh:function(){methods.centerPages(centerLeft,$("#crsa-tree").is(":visible")?$("#crsa-tree").width():10),fitZoom?methods.zoom(getFitZoomScale()):methods.zoom(currentZoom)},autoSizePage:function(e,t){sizePage(e,currentZoom,t)},setFit:function(e){fitZoom=e,methods.refresh()},getFit:function(){return fitZoom},canvasResized:function(){methods.refresh()},zoom:function(e){var t=pages.find("> div.content"),a=(pages.find("iframe"),800);return currentZoom=e,t.each(function(t,n){var r=$(n),i=r.find("iframe"),s=getCrsaPageForIframe(i);a=s.deviceWidth;Math.ceil(a*e);i.css("height","").css("width",a+"px").css("transform","scale("+e+", "+e+")").css("transform-origin","0 0"),sizePage(i,e,s.scrollMode,a),i.data("zoom",e)}),$.fn.crsa("refreshSelectElement"),this},centerPages:function(e,t){centerLeft=e,centerRight=t;var a=$("div.canvas"),n=a.outerWidth(),r=n-e-t,i=20,s=a.find("div.page"),o=s.width()+i,l=Math.floor(r/o);1>l&&(l=1),l>s.length&&(l=s.length);var c=o*l,d=e+(r-c)/2-20,f=t+(r-c)/2-20;d=centerLeft,f=centerRight,a.css("padding-left",d+"px").css("padding-right",f+"px")}},getFitZoomScale=function(){var e=24,t=0,a=e;$.each(crsaPages,function(n,r){t+=r.deviceWidth,a+=e});var n=$("div.canvas").width(),r=(n-a)/t,i=230;t=0,a=e;do{var s=!0,o=a;$.each(crsaPages,function(t,a){a.deviceWidth*r<i?o+=i:(o+=a.deviceWidth*r,s=!1),o+=e}),o>n&&(r=.95*r)}while(!s&&o>n);return r>1&&(r=1),r},sizePage=function(e,t,a,n){var r=e.closest(".content");n||(n=e.width());var i=Math.ceil(n*t);e.css("height","");var s,o;if(a){var l=$body.height()-90;s=l/t,o=l}else s=Math.ceil(1.05*e[0].contentWindow.document.body.scrollHeight),o=Math.ceil(s*t);e.css("height",s+"px").css("width",n+"px"),r.css("width",i+"px").css("height",o+"px")},updatePagesList=function(e){e.each(function(e,t){pages=$(t).find("div.page")}),0==pages.length?$empty.show():$empty.hide()};$.fn.crsapages.defaults={title:"crsa",sizes:{desktop:1600,laptop:1280,"tablet-landscape":1024,"tablet-portrait":768,phone:320}};