var Pinegrow=function(){var e={},t={},n=[],i=this;this.sourceParser=!1,this.httpServer=null;this.getComponent=function(t,n){t in e?n(e[t]):e[t]=new PgComponent(t,n)},this.getProxyUrl=function(e){return this.sourceParser&&this.httpServer?this.httpServer.makeUrl(e):e},this.getOriginalUrl=function(e){return this.httpServer?this.httpServer.getOriginalUrl(e):e},this.getPlaceholderImage=function(){var e;e=isApp()?this.getProxyUrl(crsaMakeUrlFromFile(crsaGetAppDir()+"placeholders/img")):"http://pinegrow.com/placeholders/img";var t=Math.round(8*Math.random())+1;return e+t+".jpg"},this.getThumbnailForPlaceholderImage=function(e){return e.replace(".jpg","_thumb.jpg")},this.getPageForElement=function(e){var t=getIframeOfElement(e);return t?getCrsaPageForIframe(t):null},this.getStylesheets=function(){return $.fn.crsacss("getAllStylesheets")},this.addFramework=function(e){t[e.key]=e,n.length>0&&(e.localFile=n[n.length-1]),$("body").trigger("crsa-framework-loaded",e)},this.getFrameworks=function(){return t},this.findFrameworkWithFile=function(e){var n=null;return $.each(t,function(t,i){return i.localFile&&i.localFile==e?(n=i,!1):void 0}),n},this.loadAllFrameworksFromFile=function(){var e=crsaStorage.hasValue("frameworks")?crsaStorage.getValue("frameworks"):[],t="",n=0,r=function(){if(n>=e.length)t.length>0&&showAlert(t,"Not all frameworks could be loaded");else{var o=e[n];i.loadFrameworkFromFile(o,!0,function(e){e&&(t+="<p>Unable to load "+o+": "+e+"</p>"),n++,r()})}};r()},this.fileLoaded=function(){n.length>0&&n.pop()},this.loadFrameworkFromFile=function(e,t,i){var r=null;if(isApp()){{require("fs")}try{var o=(new Date).getTime(),s=e,a='<script async="false" src="'+s+"?z="+o+'"></script>',l=$("body"),a=document.createElement("script");a.async=!1,$(a).on("load",function(){$(function(){n.push(e);try{$("body").trigger("pinegrow-ready",pinegrow),pinegrow.fileLoaded(),i&&i()}catch(t){pinegrow.fileLoaded(),i&&i(t)}})}),a.setAttribute("src",s),l.get(0).appendChild(a);var c=crsaStorage.hasValue("frameworks")?crsaStorage.getValue("frameworks"):[];c.indexOf(e)<0&&(c.push(e),crsaStorage.setValue("frameworks",c))}catch(h){r=h,t||showAlert("Unable to load "+e+". "+h,"Unable to load framework"),console.log(h),i&&i(h)}}return r},this.saveFrameworksList=function(){var e=[];$.each(t,function(t,n){n.localFile&&e.push(n.localFile)}),crsaStorage.setValue("frameworks",e)},this.unloadFramework=function(e){var n=$.fn.crsapages("getAllPages");$.each(n,function(t,n){n.removeFramework(e)}),e.key in t&&delete t[e.key];var i=-1,r=crsaStorage.hasValue("frameworks")?crsaStorage.getValue("frameworks"):[];e.localFile&&(i=r.indexOf(e.localFile)),i>=0&&r.splice(i,1),crsaStorage.setValue("frameworks",r)},this.hasUnsavedFrameworks=function(){var e=!1;return $.each(t,function(t,n){n.changed&&n.user_lib&&(e=!0)}),e},this.frameworksChanged=function(){$.each($.fn.crsapages("getAllPages"),function(e,t){t.frameworksChanged()}),$("body").trigger("crsa-frameworks-changed")},this.openPage=function(e){$.fn.crsa("openPage",e,null,function(e){scrollCanvasToPage(e.$iframe)})},this.willChangeDom=function(){crsaWillChangeDom()},this.setNeedsUpdate=function(e,t){$.fn.crsa("setNeedsUpdate",t,e)},this.getSelectedPage=function(){return $.fn.crsa("getSelectedCrsaPage")},this.getSelectedElement=function(){return $.fn.crsa("getSelectedElement")},this.addPageAction=function(e,t){$.fn.crsapages("addCustomPageAction",e,t)},this.showTab=function(e){$.fn.crsa("showTab",e)},this.formatHtml=function(e){return html_beautify(e,{wrap_line_length:0,indent_size:parseInt(pinegrow.getSetting("html-indent-size","4"))})},this.getSetting=function(e,t){return e="settings-"+e,e in window.localStorage?window.localStorage[e]:("undefined"==typeof t&&(t=null),t)},this.setSetting=function(e,t){e="settings-"+e,window.localStorage[e]=t}},PgFramework=function(e,t){this.key=e,this.name=t,this.detect=null,this.component_types={},this.default=!1,this.lib_sections=[],this.ignore_css_files=[],this.type=null,this.allow_single_type=!1,this.localFile=null,this.on_get_source=null,this.user_lib=!1,this.changed=!1,this.common_sections={};var n=[],i=!1;this.addComponentType=function(e){this.component_types[e.type]=e,e.priority||(e.priority=1e3),e.framework=this,this.common_sections&&(e.sections||(e.sections={}),$.each(this.common_sections,function(t,n){e.sections[t]=n})),n.push(e),i=!1},this.removeComponentType=function(e){if(e.type in this.component_types){delete this.component_types[e.type];var t=n.indexOf(e);t>=0&&n.splice(t,1),i=!1;for(var r=0;r<this.lib_sections.length;r++){var o=this.lib_sections[r],t=o.components.indexOf(e);t>=0&&o.components.splice(t,1)}}},this.getType=function(e){i||(n.sort(function(e,t){return e.priority-t.priority}),i=!0);for(var t=0;t<n.length;t++){var r=n[t],o=!1;if("function"==typeof r.selector?o=r.selector(e):r.selector&&(o=e.is(r.selector)),o)return r}return null},this.getComponentTypes=function(){return this.component_types},this.getComponentType=function(e){return this.component_types[e]?this.component_types[e]:null},this.addLibSection=function(e){this.lib_sections.push(e),e.framework=this},this.getLibSections=function(){return this.lib_sections},this.getAutoId=function(e){var t,n=0;do n++,t=e+(n>0?n:"");while(t in this.component_types);return{count:n,type:t}},this.getFileName=function(){return this.localFile?getPageName(this.localFile):this.name.replace(/\s/gi,"")+".js"},this.save=function(e,t){e!=this.localFile&&(this.name=getPageName(e).replace(/\.js$/i,""),this.key=this.name);var n="",i=[];$.each(this.component_types,function(e,t){var r=t.type,o="comp_"+r.replace(/-/g,"_");n+=t.toJSCode(o),i.push(o)});var r='$(function() {\n\n    //Wait for Pinegrow to wake-up\n    $("body").one("pinegrow-ready", function(e, pinegrow) {\n\n        //Create new Pinegrow framework object\n        var f = new PgFramework("'+this.key+'", "'+this.name+'");\n\n        //This will prevent activating multiple versions of this framework being loaded\n        f.type = "'+this.key+'";\n        f.allow_single_type = true;\n        f.user_lib = '+(this.user_lib?"true":"false")+"\n"+n+'\n        //Tell Pinegrow about the framework\n        pinegrow.addFramework(f);\n            \n        var section = new PgFrameworkLibSection("'+this.key+'_lib", "Components");\n        //Pass components in array\n        section.setComponentTypes(['+i.join(", ")+"]);\n\n        f.addLibSection(section);\n   });\n});";try{var o=require("fs");crsaWriteFileWithBackup(o,e,r,"utf8"),this.localFile=e,pinegrow.saveFrameworksList(),this.changed=!1}catch(s){showAlert("File "+e+" could not be saved. "+s,"Error")}t&&t()}},PgFrameworkLibSection=function(e,t){this.key=e,this.name=t,this.components=[],this.framework=null,this.addComponentType=function(e){this.components.push(e)},this.setComponentTypes=function(e){this.components=e},this.getComponentTypes=function(){return this.components}},PgComponentType=function(e,t){this.type=e,this.name=t,this.selector=null,this.code=null,this.preview=null,this.sections=null,this.priority=1e3,this.parent_selector=null,this.inherit_from=null,this.empty_placeholder=null,this.display_name=null,this.live_update=!0,this.framework=null,this.set_value=null,this.toJSCode=function(e){var t=function(e){return e=html_beautify(e),e=e.replace(/\r\n|\r|\n/g,"\\\n"),e.replace(/'/g,"\\'")},n="\n        var "+e+" = new PgComponentType('"+this.type+"', '"+t(this.name)+"');\n        "+e+".code = '"+t(this.code)+"';\n        "+e+".parent_selector = "+(this.parent_selector?"'"+this.parent_selector+"'":"null")+";\n        f.addComponentType("+e+");\n        ";return n}},PgPropertiesSection=function(e,t){this.key=e,this.name=t,this.fields={},this.addProperty=function(e,t){t||(t=e.key),this.fields[e.key]=e}},PgProperty=function(e,t){this.name=t,this.key=e,this.type=null,this.action=null,this.get_value=null,this.set_value=null,this.value=null,this.show_empty=null,this.attribute=null,this.options=null},PgComponent=function(e,t){this.html=null,this.error=null,this.url=null;var n=this;if(this.url="components/"+e+".html",isApp()){var i=require("fs");try{this.html=i.readFileSync(crsaMakeFileFromUrl(this.url),{encoding:"utf8"}),t&&t(this)}catch(r){this.error=r,t&&t(this)}}else $.ajax({url:this.url,data:null,dataType:"text"}).done(function(e){n.html=e,t&&t(n)}).fail(function(e){n.error=e,t&&t(n)})};