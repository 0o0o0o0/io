var CrsaCodeEdit=function(){this.currentPage=null;var e,t,n,a="",r=null,i=null,o=$("#textedit"),s=$("#textedit_bar"),c=s.find("select.edit-css-select"),l=s.find(".live-update");l.tooltip({container:"body",placement:"bottom",title:"Auto refresh page view. If disabled, click on Refresh! (CMD + R) to refresh page view.",trigger:"hover"}),"1"==pinegrow.getSetting("code-live-update","1")&&l.attr("checked","checked");var d=function(){return l.is(":checked")};l.on("change",function(){pinegrow.setSetting("code-live-update",d()?"1":"0"),d()?crsaQuickMessage("Auto refresh is enabled."):(crsaQuickMessage("Auto refresh is disabled."),showNotice("Click on <b>Refresh!</b> or press <b>CMD + R</b> to manually refresh page view after you make changes.","Auto update is disabled","auto-refresh"))});var u=!1,g="html",f=null,h=!1,m=!1,p=!1,v=this,b=ace.require("ace/range").Range,C=null,P=!1;$("body").on("crsa-element-selected",function(e,t){if(v.currentPage&&d()&&t&&"element"==t.type){var a=t.data;if("html"==g){var r=getCrsaPageForIframe(v.currentPage),i="data-pg-edit-marker";a.attr(i,"true");var o;o=r.getSource(),a.removeAttr(i),m||(o=pinegrow.formatHtml(o));var s=o.indexOf(i);o=o.replace(' data-pg-edit-marker="true"',""),P&&v.pageChanged(r,o);var c=o.indexOf("<body");0>c&&(c=o.indexOf("<BODY")),c>=0&&(o=o.substr(c)),s-=c,C&&n.getSession().removeMarker(C);var l=0,u=0;if(s>=0){var f=n.getValue();c=f.indexOf("<body"),0>c&&(c=f.indexOf("<BODY"));for(var h=0,p=0;c>p;p++){var T=f.charAt(p);"\n"==T&&h++}for(var k=h,p=0;s>p;p++){var T=o.charAt(p);"\n"==T&&(k++,l=p),"<"==T&&(u=p)}for(var w=0,y=0,$=u-l-1,S=a.get(0).outerHTML,p=0;p<S.length;p++){var T=S.charAt(p);"\n"==T?(w++,y=0):y++}0>$&&($=0),C=n.getSession().addMarker(new b(k,$,k+w,y),"ace_active-line","text"),n.gotoLine(k+1,$,!1),n.scrollToLine(k+1,!0,!1)}}}});var T=function(){if(!u&&(d()||p)){var e=n.getValue();if("html"==g){P=!0;var o=k(e);if(a==o){r&&clearTimeout(r);var s=null;r=setTimeout(function(){i[0].innerHTML=e,r=null,s&&(clearTimeout(s),s=null),s=setTimeout(function(){$.fn.crsa("buildTree",v.currentPage,null),$.fn.crsacss("loadLessStyles",v.currentPage),s=null},500)},1e3)}else a=o,r&&clearTimeout(r),r=setTimeout(function(){var e=getIframeBody(v.currentPage[0]);e&&(e.innerHTML=o),$.fn.crsa("buildTree",v.currentPage,null),r=null},250);var c=getCrsaPageForIframe(v.currentPage);c.setPageChanged(!0);var l=u;u=!0,didMakeChange(v.currentPage),u=l}else"js"==g||"css"==g&&f&&(r&&(clearTimeout(r),r=null),r=setTimeout(function(){f.genSetSource(e,function(){var e=f.genGetError();e?(console.log(e),t=!0,n.getSession().setAnnotations([{row:e.line-1,column:e.column,text:"Syntax error",type:"error"}])):(f.changed=!0,t&&(n.getSession().clearAnnotations(),t=!1),$("body").trigger("crsa-stylesheets-changed"))},!0)},750));h=!0}},k=function(e){var t=e.match(/<\s*body[^>]*>([\s\S]*)<\/body>/im);return t?t[1]:null},w=function(){var e=getCrsaPageStylesForPage(v.currentPage),t=[];return e?($.each(e.getAllCrsaStylesheets(),function(e,n){!n.inline&&n.loaded&&t.push(n)}),t):t},y=function(){g="css";var e=c.val(),t=w();$.each(t,function(t,n){return n.name==e?(f=n,!1):void 0}),f&&S()};c.on("change",function(){y()}),this.pageChanged=function(e,t){if(!u&&"html"==g){var a=n.getFirstVisibleRow();S(t),n.scrollToLine(a,!1,!1)}};var S=function(e){u=!0;var t="";switch(g){case"css":t=f.genGetSource(),n.getSession().setMode("ace/mode/less");break;case"js":n.getSession().setMode("ace/mode/javascript");break;default:e?t=e:(t=getCrsaPageForIframe(v.currentPage).getSource(),t=removeCrsaClassesFromHtml(t),t=pinegrow.formatHtml(t)),P=!1,a=k(t),n.getSession().setMode("ace/mode/html")}n.setValue(t,-1),n.getSession().getSelection().clearSelection(),u=!1};this.exitEdit=function(e){var t=this.currentPage;if(this.currentPage=null,o.hide(),e){$.fn.crsa("updateStructureAndWireAllElemets",t),$("body").trigger("crsa-stylesheets-changed");var n=getCrsaPageForIframe(t);n.addCrsaStyles(),n.runScripts(),didMakeChange(t)}$.fn.crsa("resizeChrome")},this.isInEdit=function(e){return this.currentPage&&this.currentPage.get(0)==e.get(0)?!0:!1},this.refreshPreview=function(){p=!0,T(null),p=!1,crsaQuickMessage("Page view was refreshed.")};var M=function(e){{var t=$(e.delegateTarget);$("#textedit")}if(t.hasClass("edit-done"))v.exitEdit(!0);else if(t.hasClass("edit-refresh")){if(e.target==l.get(0))return;v.refreshPreview()}else t.hasClass("edit-html")?g="html":t.hasClass("edit-js")?g="js":t.hasClass("edit-css")&&y(),S();e.preventDefault()};s.find("a, button").on("click",function(e){M(e)}),this.editCode=function(a){this.currentPage&&!this.isInEdit(a)&&this.exitEdit(!0),this.currentPage=a;getIframeBody(this.currentPage[0]);e=getIframeDocument(this.currentPage[0]),i=$(e).find("> html"),n||(n=ace.edit("textedit"),n.getSession().setUseWrapMode(!0),n.getSession().on("change",T)),n.setTheme("ace/theme/"+pinegrow.getSetting("code-theme","xcode")),o.show(),$.fn.crsa("resizeChrome"),t=!1;var r=w();c.html(""),$.each(r,function(e,t){$("<option/>",{value:t.name}).html(t.name).appendTo(c)}),f&&c.val(f.name),willMakeChange(v.currentPage,"Edit code"),S(),showNotice("<p><b>Code view &lt;---&gt; Page view</b> - Code and page view are linked.</p><p>When you select an element on the page it gets highlighted in the code. When you make a change on the page the code gets updated.</p><p><b>Disable auto-refresh</b> (uncheck Refresh) if syncing gets too slow on complex pages.</p>","A note about code view highlighting","code-view"),d()||crsaQuickMessage("Auto refresh is disabled. Press <b>CMD + R</b> to refresh.",3e3)}},CrsaEditor=function(){this.selectedPage=null;var e=this,t=null,n=null,a=null,r=null,i=!1,o=null,s=null,c=1,l=null,d=!1;$("body").on("crsaWillMakeChange",function(){e.endEdit()});var u=function(){return e.selectedPage.get(0).contentDocument||e.selectedPage.get(0).contentWindow.document},g=function(){return e.selectedPage.get(0).contentWindow},f=function(){$.fn.crsa("setNeedsUpdate",!0),t=null,n=null},h=function(){r&&(clearTimeout(r),r=null),i=!0,r=setTimeout(function(){i=!1},500)},m=function(){var e="",t=g(),n=u();if("undefined"!=typeof t.getSelection){var a=t.getSelection();if(a.rangeCount){for(var r=n.createElement("div"),i=0,o=a.rangeCount;o>i;++i)r.appendChild(a.getRangeAt(i).cloneContents());e=r.innerHTML}}else"undefined"!=typeof n.selection&&"Text"==n.selection.type&&(e=n.selection.createRange().htmlText);return e},p=function(){var e,t=g();t.getSelection?e=t.getSelection():document.selection&&"Control"!=document.selection.type&&(e=document.selection);var n=e.anchorNode;return n},v=function(e){var t="div";if(3!=e.get(0).nodeType)if(removeCrsaClasses(e),e.is("ul,ol")){var n=e.parent();n.is("p")&&(e.insertAfter(n),""==n.html()&&n.remove())}else if(e.is("span"))e.replaceWith(e.html());else if(e.is("div"))e.replaceWith(e.contents());else if(e.is(t)){var a=e.children();(""==e.html()||1==a.length&&a.is("br"))&&e.replaceWith($("<p/>").html("<br/>"))}},b=function(){t&&(clearTimeout(t),t=null),n&&(clearTimeout(n),n=null),t=setTimeout(f,250),didMakeChange(e.selectedPage,o)};this.setSelectedPage=function(e){if((!this.selectedPage||!e||this.selectedPage.get(0)!=e.get(0)&&d)&&this.endEdit(),this.selectedPage=e,e){var t=$(u().body);"true"===t.attr("contentEditable"),t.data("crsa-editor")}},this.startEdit=function(r,i){a||(a=r,this.showToolbar(a));var g=$(u().body);d=!0;var h=43,m=h;this.selectedPage.data("crsa-page").undoStack.add("Edit text"),g=i.closest("div,body,label"),c=$.fn.crsapages("getZoom"),l=i,$.fn.crsapages("zoom",1),$.fn.crsa("scrollCanvasToElement",i),o&&o.removeAttr("contentEditable").off(".crsaeditor"),o=g,g.attr("contentEditable","true");var p=o.get(0);s&&s.disconnect();var C=null;"undefined"!=typeof MutationObserver?C=MutationObserver:"undefined"!=typeof WebKitMutationObserver&&(C=WebKitMutationObserver),s=new C(function(e){var t=!1;e.forEach(function(e){if("childList"==e.type){for(var n=0;n<e.addedNodes.length;n++)v($(e.addedNodes[n]));t=!0}}),t&&b()});var P={attributes:!0,childList:!0,characterData:!0,subtree:!0,attributeFilter:[]};if(s.observe(p,P),o.data("crsa-editor",!0).on("keyup.crsaeditor paste.crsaeditor cut.crsaeditor",function(){n&&(clearTimeout(n),n=null),t||(n=setTimeout(f,1e3)),didMakeChange(e.selectedPage,o)}).on("paste cut",function(e){console.log(e.type)}),$(u()).on("selectionchange.crsaeditor",function(){console.log("sel change")}),m=h,a&&a.css("top")!=m+"px"){var T=a.width(),k=$(window).width();a.css("left",(k-T)/2+"px"),a.animate({top:m},250,function(){})}u().execCommand("styleWithCSS",!1,!1),$.fn.crsa("refreshSelectElement")},this.endEdit=function(){if(d){var e=o;if(d=!1,o&&(o.removeAttr("contentEditable"),o.off(".crsaeditor"),s.disconnect(),o=null),a.animate({top:-60},250,function(){}),this.selectedPage){$.fn.crsapages("zoom",c);var t=l.is(":visible")?l:e;t&&$.fn.crsa("scrollCanvasToElement",t)}$.fn.crsa("refreshSelectElement")}},this.isInEdit=function(){return d},this.showToolbar=function(t){t.html("");var n=t,a=[{icon:"<b>B</b>",cmd:"bold"},{icon:"<em>It</em>",cmd:"Italic"},{icon:"H1",cmd:"formatBlock",data:"H1"},{icon:"H2",cmd:"formatBlock",data:"H2"},{icon:"H3",cmd:"formatBlock",data:"H3"},{icon:"H4",cmd:"formatBlock",data:"H4"},{icon:"H5",cmd:"formatBlock",data:"H5"},{icon:"H6",cmd:"formatBlock",data:"H6"},{icon:"P",cmd:"insertHTML",action:function(){var e=m();console.log(e);var t=p();if(t&&e){{t.wholeText?t.wholeText:t.innerHTML}e=null}if(e&&e.length>0)u().execCommand("insertHTML",!1,"<p>"+e+"</p>");else if(t){var n=$(t),a="li,h1,h2,h3,h4,h5,h6,p";if(3==t.nodeType&&(n=n.parent()),n.is("b,strong,em,sup,sub,a"))if(n.parent().is(a))n=n.parent(),n.replaceWith($("<p/>").append(n.contents()));else{var r=$("<p/>");n.replaceWith(r),r.append(n)}else n.is(a)?n.replaceWith($("<p/>").append(n.contents())):u().execCommand("insertHTML",!1,"<p>&nbsp;</p>")}}},{icon:"OL",cmd:"insertOrderedList"},{icon:"UL",cmd:"insertUnorderedList"},{icon:"LINK",cmd:"createLink",ask:"Please enter the url:",placeholder:"http://"}];$.each(a,function(e,t){var a=$("<button/>",{"class":"btn btn-sm btn-default"}).html('<a href="#">'+t.icon+"</a>").appendTo(n);!function(e){a.on("click",function(t){h();var n=e.data?e.data:null;e.action?e.action(e):e.ask?showPrompt("Link address","Edit link address",null,"http://www.example.com",null,function(t){u().execCommand(e.cmd,!1,t)}):u().execCommand(e.cmd,!1,n),t.preventDefault()})}(t)});$("<button/>",{"class":"btn btn-sm btn-info"}).html("Done").appendTo(n).on("click",function(t){e.endEdit(),t.preventDefault()})}};